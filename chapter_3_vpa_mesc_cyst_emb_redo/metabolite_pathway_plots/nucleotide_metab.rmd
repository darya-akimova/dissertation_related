---
title: "Nucleotide Metabolism"
author: "Darya Akimova"
date: "1/17/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Setup

## Packages

```{r packages, comment=NA}
library(tidyverse)
library(cowplot)
theme_set(theme_minimal())
```


## Data

```{r data, comment=NA}
### pathway info ###
vpa.pathways <- read_csv("./data/pathway_info/vpa_only_exp1/vpa_only_exp_all_cmpnd_pathways.csv")
vf.pathways <- read_csv("./data/pathway_info/vpa_fa_exp1/vpa_fa_exp1_all_cmpnd_pathways.csv")
vpa.hilic.pathways <- read_csv("./data/pathway_info/vpa_hilic/vpa_hilic_exp_all_cmpnd_pathways.csv")
vf.p5.pathways <- read_csv("./data/pathway_info/vpa_fa_p5/vpa_fa_p5_all_cmpnd_pathways.csv")

### cleaned log2 residuals ###
vpa.abun.list <- paste(
  "./data/cleaned_abundances/vpa_only_exp1/", 
  list.files(path = "./data/cleaned_abundances/vpa_only_exp1/"), 
  sep = ""
  ) %>% 
  map(read_csv)
vf.abun.list <- paste(
  "./data/cleaned_abundances/vpa_fa_exp1/", 
  list.files(path = "./data/cleaned_abundances/vpa_fa_exp1/"), 
  sep = ""
  ) %>% 
  map(read_csv)
vpa.hilic.abun.list <- paste(
  "./data/cleaned_abundances/vpa_only_hilic/", 
  list.files(path = "./data/cleaned_abundances/vpa_only_hilic/"), 
  sep = ""
  ) %>% 
  map(read_csv)
vf.p5.abun.list <- paste(
  "./data/cleaned_abundances/vpa_fa_p5/", 
  list.files(path = "./data/cleaned_abundances/vpa_fa_p5/"), 
  sep = ""
  ) %>% 
  map(read_csv)

### statistically significant hits + FC 1.2 cut-off ###
vpa.hits.list <- paste(
  "./data/hit_lists/vpa_only_exp1/", 
  list.files(path = "./data/hit_lists/vpa_only_exp1/"), 
  sep = ""
  ) %>% 
  map(read_csv)
vf.hits.list <- paste(
  "./data/hit_lists/vpa_fa_exp1/", 
  list.files(path = "./data/hit_lists/vpa_fa_exp1/"), 
  sep = ""
  ) %>% 
  map(read_csv)
vpa.hilic.hits.list <- paste(
  "./data/hit_lists/vpa_only_hilic/", 
  list.files(path = "./data/hit_lists/vpa_only_hilic/"), 
  sep = ""
  ) %>% 
  map(read_csv)
vf.p5.hits.list <- paste(
  "./data/hit_lists/vpa_fa_p5/", 
  list.files(path = "./data/hit_lists/vpa_fa_p5/"), 
  sep = ""
  ) %>% 
  map(read_csv)
```


# Prep

Full list of all metabolites detected/quantified across VPA expriments that were found to be associated with either Purine metabolism, Pyrimidine metabolism, or the Pentose phosphate pathway:

```{r}
all.nuc.metab <- bind_rows(
  bind_rows(
    "vpa_only" = vpa.pathways %>% 
      filter(str_detect(path_name, "Purine") | str_detect(path_name, "Pyrimidine") | str_detect(path_name, "Pentose phosphate")),
    "vpa_hilic" = vpa.hilic.pathways %>% 
      filter(str_detect(path_name, "Purine") | str_detect(path_name, "Pyrimidine") | str_detect(path_name, "Pentose phosphate")),
    .id = "experiment"
    ), 
  bind_rows(
    "vf_first" = vf.pathways %>% 
      filter(str_detect(path_name, "Purine") | str_detect(path_name, "Pyrimidine") | str_detect(path_name, "Pentose phosphate")),
    "vf_p5" = vf.p5.pathways %>% 
      filter(str_detect(path_name, "Purine") | str_detect(path_name, "Pyrimidine") | str_detect(path_name, "Pentose phosphate")),
    .id = "experiment"
    )
  )
# preview
head(all.nuc.metab)
# full number of relevant metabolites across experiments
nrow(all.nuc.metab)
# unique number of compounds across experiments 
length(unique(all.nuc.metab$compound_full_exp))
```


Convert the full lists (all pathways) of statistically significant compounds from list to df format:

```{r hits_list_to_df, comment=NA}
### nucleotide metabolism related only) ###
### vpa exp 1 ###
vpa.hits.df <- bind_rows(
  "vpa_cell.neg" = vpa.hits.list[[1]],
  "vpa_cell.pos" = vpa.hits.list[[2]],
  "vpa_med.neg" = vpa.hits.list[[3]],
  .id = "exp_source.mode"
  ) %>% 
  select(compound_short, compound_full:cas_id, exp_source.mode, change_in_vpa, vpa_div_cntrl, adj.P.Val) %>% 
  rename("adj_pval" = adj.P.Val) %>% 
  filter(compound_short %in% all.nuc.metab$compound_short)
### vpa + fa exp 1 ###
vf.hits.df <- bind_rows(
  "vf_cell.neg" = vf.hits.list[[1]],
  "vf_cell.pos" = vf.hits.list[[2]],
  "vf_med.neg" = vf.hits.list[[3]],
  .id = "exp_source.mode"
  ) %>% 
  select(compound_short, compound_full:cas_id, exp_source.mode, term, change_in_vpa, FC, adj_pval) %>% 
  rename("vpa_div_cntrl" = FC) %>% 
  filter(compound_short %in% all.nuc.metab$compound_short)
### vpa hilic ### 
vpa.hilic.hits.df <- bind_rows(
  "vpa.hilic_cell.neg" = vpa.hilic.hits.list[[1]],
  "vpa.hilic_cell.pos" = vpa.hilic.hits.list[[2]],
  .id = "exp_source.mode"
  ) %>% 
  select(compound_short, compound_full:cas_id, exp_source.mode, change_in_vpa, vpa_div_cntrl, adj.P.Val) %>% 
  rename("adj_pval" = adj.P.Val) %>% 
  filter(compound_short %in% all.nuc.metab$compound_short)
### vpa + fa p5 ###
vf.p5.hits.df <- bind_rows(
  "vf.p5_cell.neg" = vf.p5.hits.list[[1]],
  "vf.p5_cell.pos" = vf.p5.hits.list[[2]],
  "vf.p5_med.neg" = vf.p5.hits.list[[3]],
  .id = "exp_source.mode"
  ) %>% 
  select(compound_short, compound_full:cas_id, exp_source.mode, term, change_in_vpa, FC, adj_pval) %>% 
  rename("vpa_div_cntrl" = FC)  %>% 
  filter(compound_short %in% all.nuc.metab$compound_short)
```


Need to convert the log2 abundance residuals (after regression onto covariates, or the intercept for a few) from list format to df, without losing info about exp/etc:

```{r abun_resid_list_to_df, warning=FALSE, comment=NA}
### vpa only ###
vpa.nucl.abun.df <- vpa.abun.list %>% 
  # pick only relevant sample info and compound abun columns (nucleotide metab)
  map(select, Samples, Treatment, one_of(all.nuc.metab$compound_short)) %>% 
  # convert from wide to long format for easy list -> df conversion
  map(gather, key = "compound_short", value = "log2_resid_abun", -c(Samples:Treatment)) %>% 
  # combine with experiment, pathway, etc 
  map(inner_join, all.nuc.metab, by = "compound_short") %>% 
  # list -> df
  bind_rows() %>%
  # rearrange the columns
  select(experiment, mode, Samples:compound_short, compound_full_exp, everything())
### vpa + fa exp 1 ###
vf.nucl.abun.df <- vf.abun.list %>%  
  map(select, Samples:FA, one_of(all.nuc.metab$compound_short)) %>% 
  map(gather, key = "compound_short", value = "log2_resid_abun", -c(Samples:FA)) %>% 
  map(inner_join, all.nuc.metab, by = "compound_short") %>% 
  bind_rows() %>% 
  mutate(FA = ifelse(FA == "cntrl", "1Xfa", "5Xfa")) %>% 
  unite("Treatment", VPA:FA, sep = "_") %>% 
  select(experiment, mode, Samples:compound_short, compound_full_exp, everything())
### vpa hilic ###
vpa.hilic.nucl.abun.df <- vpa.hilic.abun.list %>% 
  map(select, Samples, Group, one_of(all.nuc.metab$compound_short)) %>% 
  map(gather, key = "compound_short", value = "log2_resid_abun", -c(Samples:Group)) %>% 
  map(inner_join, all.nuc.metab, by = "compound_short") %>% 
  bind_rows() %>%
  rename("Treatment" = Group) %>% 
  select(experiment, mode, Samples:compound_short, compound_full_exp, everything())
### vpa + fa p5 hilic ###
vf.p5.nucl.abun.df <- vf.p5.abun.list %>%  
  map(select, Samples:FA, one_of(all.nuc.metab$compound_short)) %>% 
  map(gather, key = "compound_short", value = "log2_resid_abun", -c(Samples:FA)) %>% 
  map(inner_join, all.nuc.metab, by = "compound_short") %>% 
  bind_rows() %>% 
  mutate(FA = ifelse(FA == "base", "1Xfa", "5Xfa")) %>% 
  unite("Treatment", VPA:FA, sep = "_") %>% 
  select(experiment, mode, Samples:compound_short, compound_full_exp, everything())
```

The abundance df created in the above chunk include all compound related to nucleotide metabolism that had passed the filters, but not all of them were found to be statistically significant in the end. To mark the difference, a new column is needed:

```{r sig_column_create, comment=NA}
### vpa only ###
vpa.nucl.abun.df <- vpa.nucl.abun.df %>% 
  mutate(significant = ifelse(compound_short %in% vpa.hits.df$compound_short, TRUE, FALSE)) 
# check how many TRUE in df
vpa.nucl.abun.df %>% 
  select(compound_short, significant) %>% 
  distinct() %>% 
  {table(.$significant)}
# vs how many nucleotide metab hits there should be
nrow(vpa.hits.df)

### vpa + fa exp 1 ###
vf.nucl.abun.df <- vf.nucl.abun.df %>% 
  mutate(significant = ifelse(compound_short %in% vf.hits.df$compound_short, TRUE, FALSE))
vf.nucl.abun.df %>% 
  select(compound_short, significant) %>% 
  distinct() %>% 
  {table(.$significant)}
nrow(vf.hits.df)
length(unique(vf.hits.df$compound_short))
# difference because some compounds are sig for both low and high FA background, which were treated separatly

### vpa hilic ###
vpa.hilic.nucl.abun.df <- vpa.hilic.nucl.abun.df %>% 
  mutate(significant = ifelse(compound_short %in% vpa.hilic.hits.df$compound_short, TRUE, FALSE))
vpa.hilic.nucl.abun.df %>% 
  select(compound_short, significant) %>% 
  distinct() %>% 
  {table(.$significant)}
nrow(vpa.hilic.hits.df)

### vpa + fa p5 hilic ###
vf.p5.nucl.abun.df <- vf.p5.nucl.abun.df %>% 
  mutate(significant = ifelse(compound_short %in% vf.p5.hits.df$compound_short, TRUE, FALSE))
vf.p5.nucl.abun.df %>% 
  select(compound_short, significant) %>% 
  distinct() %>% 
  {table(.$significant)}
nrow(vf.p5.hits.df)
length(unique(vf.p5.hits.df$compound_short))
```


# Visualization

# Purine metabolism:

```{r purine_plots, comment=NA, fig.height=8, fig.width = 6}
# raw residuals
vpa.nucl.abun.df %>% 
  filter(path_name == "Purine metabolism") %>% 
  mutate(alt_cmpnd_name = paste(compound_full_exp, " (", mode, ")", sep = "")) %>% 
  ggplot(aes(alt_cmpnd_name, log2_resid_abun, color = Treatment, fill = Treatment)) +
  geom_boxplot(alpha = 0.5) +
  geom_point(size = 2, position = position_dodge(0.75)) +
  scale_color_manual(values = c("#56B4E9", "#E69F00"), labels = c("Control", "VPA")) +
  scale_fill_manual(values = c("#56B4E9", "#E69F00")) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1),
    legend.justification = "top"
    )
# scaled
vpa.nucl.abun.df %>% 
  filter(path_name == "Purine metabolism") %>% 
  mutate(alt_cmpnd_name = paste(compound_full_exp, " (", mode, ")", sep = "")) %>% 
  group_by(alt_cmpnd_name) %>% 
  mutate(scaled_resid = scale(log2_resid_abun)) %>% 
  ungroup() %>% 
  ggplot(aes(alt_cmpnd_name, scaled_resid, color = Treatment, fill = Treatment)) +
  geom_boxplot(alpha = 0.5) +
  geom_point(size = 2, position = position_dodge(0.75)) +
  scale_color_manual(values = c("#56B4E9", "#E69F00"), labels = c("Control", "VPA")) +
  scale_fill_manual(values = c("#56B4E9", "#E69F00")) +
  theme(
    legend.justification = "top"
    ) +
  coord_flip()
# raw flipped
vpa.nucl.abun.df %>% 
  filter(path_name == "Purine metabolism") %>% 
  mutate(alt_cmpnd_name = paste(compound_full_exp, " (", mode, ")", sep = "")) %>% 
  ggplot(aes(alt_cmpnd_name, log2_resid_abun, color = Treatment, fill = Treatment)) +
  geom_boxplot(alpha = 0.5) +
  geom_point(size = 2, position = position_dodge(0.75)) +
  scale_color_manual(values = c("#56B4E9", "#E69F00"), labels = c("Control", "VPA")) +
  scale_fill_manual(values = c("#56B4E9", "#E69F00")) +
  theme(
    legend.justification = "top"
    ) +
  coord_flip()
# Sig and not sig
vpa.nucl.abun.df %>% 
  filter(path_name == "Purine metabolism") %>% 
  mutate(alt_cmpnd_name = paste(compound_full_exp, " (", mode, ")", sep = "")) %>% 
  ggplot(aes(alt_cmpnd_name, log2_resid_abun, color = Treatment)) +
  geom_boxplot(alpha = 0.5) +
  geom_point(size = 1, position = position_dodge(0.75)) +
  scale_color_manual(values = c("#56B4E9", "#E69F00"), labels = c("Control", "VPA")) +
  scale_fill_manual(values = c("#56B4E9", "#E69F00")) +
  theme(
    legend.justification = "top"
    ) +
  coord_flip() +
  facet_wrap(~ significant)
# Sig and not sig scaled
vpa.nucl.abun.df %>% 
  filter(path_name == "Purine metabolism") %>% 
  mutate(alt_cmpnd_name = paste(compound_full_exp, " (", mode, ")", sep = "")) %>% 
  group_by(alt_cmpnd_name) %>% 
  mutate(scaled_resid = scale(log2_resid_abun)) %>% 
  ungroup() %>% 
  ggplot(aes(alt_cmpnd_name, scaled_resid, color = Treatment, fill = Treatment)) +
  geom_boxplot(alpha = 0.5) +
  geom_point(size = 1.5, position = position_dodge(0.75)) +
  scale_color_manual(values = c("#56B4E9", "#E69F00"), labels = c("Control", "VPA")) +
  scale_fill_manual(values = c("#56B4E9", "#E69F00")) +
  theme(
    legend.justification = "top",
    panel.grid.major.y = element_line(color = "black", linetype = "dashed"),
    panel.grid.major.x = element_blank()
    ) +
  coord_flip() +
  facet_wrap(~ significant)
# add zero line
vpa.nucl.abun.df %>% 
  filter(path_name == "Purine metabolism") %>% 
  mutate(alt_cmpnd_name = paste(compound_full_exp, " (", mode, ")", sep = "")) %>% 
  group_by(alt_cmpnd_name) %>% 
  mutate(scaled_resid = scale(log2_resid_abun)) %>% 
  ungroup() %>% 
  ggplot(aes(alt_cmpnd_name, scaled_resid, color = Treatment, fill = Treatment)) +
  geom_hline(yintercept = 0, color = "gray50", size = 1) +
  geom_boxplot(alpha = 0.5) +
  geom_point(size = 1.5, position = position_dodge(0.75)) +
  scale_color_manual(values = c("#56B4E9", "#E69F00"), labels = c("Control", "VPA")) +
  scale_fill_manual(values = c("#56B4E9", "#E69F00")) +
  theme(
    legend.justification = "top",
    panel.grid.major.y = element_line(color = "black", linetype = "dashed"),
    panel.grid.major.x = element_blank()
    ) +
  coord_flip() +
  facet_wrap(~ significant)
```


What about comparisons between experiments?

```{r comment=NA, fig.height=8, fig.width = 6}
vpa.nucl.abun.df %>% 
  filter(path_name == "Purine metabolism") %>% 
  mutate(alt_cmpnd_name = paste(compound_full_exp, " (", mode, ")", sep = ""))
vf.nucl.abun.df %>% 
  filter(path_name == "Purine metabolism") %>% 
  separate(Treatment, into = c("VPA", "FA"), sep = "_") %>% 
  mutate(alt_cmpnd_name = paste(compound_full_exp, " (", mode, " / ", FA, ")", sep = "")) %>% 
  group_by(alt_cmpnd_name) %>% 
  mutate(scaled_resid = scale(log2_resid_abun)) %>% 
  ungroup() %>% 
  ggplot(aes(alt_cmpnd_name, scaled_resid, color = VPA, fill = VPA)) +
  geom_hline(yintercept = 0, color = "gray50", size = 1) +
 # geom_boxplot(alpha = 0.5) +
  geom_point(size = 2, position = position_dodge(0.75), alpha = 0.8) +
  scale_color_manual(values = c("#56B4E9", "#E69F00"), labels = c("Control", "VPA")) +
  scale_fill_manual(values = c("#56B4E9", "#E69F00")) +
  theme(
    legend.justification = "top",
    panel.grid.major.y = element_line(color = "gray50", linetype = "dashed"),
    panel.grid.major.x = element_blank()
    ) +
  coord_flip() +
  facet_wrap(~ significant)
```


What if I show only significant compounds?

```{r only_significant_plots, comment=NA, fig.height=8, fig.width = 6}
vpa.nucl.abun.df %>% 
  filter(path_name == "Purine metabolism" & significant == TRUE) %>% 
  mutate(alt_cmpnd_name = paste(compound_full_exp, " (", mode, ")", sep = "")) %>% 
  group_by(alt_cmpnd_name) %>% 
  mutate(scaled_resid = scale(log2_resid_abun)) %>% 
  ungroup() %>% 
  ggplot(aes(alt_cmpnd_name, scaled_resid, color = Treatment, fill = Treatment)) +
  geom_hline(yintercept = 0, color = "gray50", size = 1) +
  geom_boxplot(alpha = 0.5) +
  geom_point(size = 1.5, position = position_dodge(0.75)) +
  scale_color_manual(values = c("#56B4E9", "#E69F00"), labels = c("Control", "VPA")) +
  scale_fill_manual(values = c("#56B4E9", "#E69F00"), guide = FALSE) +
  theme(
    legend.justification = "top",
    panel.grid.major.y = element_line(color = "black", linetype = "dashed"),
    panel.grid.major.x = element_blank()
    ) +
  coord_flip() +
  ylab("Scaled Residuals") +
  xlab("Compound")
```

Sort by FC? No - would like to keep same compound by mode together. Maybe average? Yes.

```{r comment=NA, fig.height=8, fig.width = 6}
### vpa only ###
vpa.purn.plot.prep <- vpa.nucl.abun.df %>% 
  filter(path_name == "Purine metabolism" & significant == TRUE) %>% 
  mutate(alt_cmpnd_name = paste(compound_full_exp, " (", mode, ")", sep = "")) %>% 
  group_by(alt_cmpnd_name) %>% 
  mutate(scaled_resid = scale(log2_resid_abun)) %>% 
  ungroup() %>% 
  inner_join(
    vpa.hits.df %>% 
      group_by(compound_full) %>% 
      summarize(avg_FC = mean(vpa_div_cntrl)),
    by = c("compound_full_exp" = "compound_full")
    ) %>% 
  arrange(desc(avg_FC), alt_cmpnd_name) %>%
  mutate(plot_order = factor(alt_cmpnd_name, levels = unique(alt_cmpnd_name)))
vpa.purn.plot.prep %>% 
  ggplot(aes(plot_order, scaled_resid, color = Treatment, fill = Treatment)) +
  geom_hline(yintercept = 0, color = "gray50", size = 1) +
  geom_boxplot(alpha = 0.3) +
  geom_point(size = 2, position = position_dodge(0.75)) +
  scale_color_manual(values = c("#56B4E9", "#E69F00"), labels = c("Control", "VPA")) +
  scale_fill_manual(values = c("#56B4E9", "#E69F00"), guide = FALSE) +
  theme(
    legend.justification = "top",
    panel.grid.major.y = element_line(color = "black", linetype = "dashed"),
    panel.grid.major.x = element_blank()
    ) +
  coord_flip() +
  ylab("Scaled Residuals") +
  xlab("Compound")
### vpa + fa exp 1 ###
vf.purn.plot.prep <- vf.nucl.abun.df %>% 
  filter(path_name == "Purine metabolism" & significant == TRUE) %>% 
  separate(Treatment, into = c("VPA", "FA"), sep = "_") %>% 
  mutate(alt_cmpnd_name = paste(compound_full_exp, " (", mode, ")", sep = "")) %>% 
  group_by(alt_cmpnd_name) %>% 
  mutate(scaled_resid = scale(log2_resid_abun)) %>% 
  ungroup() %>% 
  inner_join(
    vf.hits.df %>% 
      group_by(compound_full) %>% 
      summarize(avg_FC = mean(vpa_div_cntrl)),
    by = c("compound_full_exp" = "compound_full")
    ) %>% 
  arrange(desc(avg_FC), alt_cmpnd_name) %>%
  mutate(plot_order = factor(alt_cmpnd_name, levels = unique(alt_cmpnd_name)))
vf.purn.plot.prep %>% 
  ggplot(aes(plot_order, scaled_resid, color = VPA, fill = VPA)) +
  geom_hline(yintercept = 0, color = "gray50", size = 1) +
  geom_boxplot(alpha = 0.3) +
  geom_point(size = 2, position = position_dodge(0.75)) +
  scale_color_manual(values = c("#56B4E9", "#E69F00"), labels = c("Control", "VPA")) +
  scale_fill_manual(values = c("#56B4E9", "#E69F00"), guide = FALSE) +
  theme(
    legend.justification = "top",
    panel.grid.major.y = element_line(color = "black", linetype = "dashed"),
    panel.grid.major.x = element_blank()
    ) +
  coord_flip() +
  ylab("Scaled Residuals") +
  xlab("Compound") +
  facet_wrap(~ FA, ncol = 2, scales = "free_y")
```


```{r}
vpa.purn.plot.prep %>% 
  ggplot(aes(plot_order, scaled_resid, color = Treatment, fill = Treatment)) +
  geom_hline(yintercept = 0, color = "gray50", size = 1) +
  geom_boxplot(alpha = 0.3) +
  geom_point(size = 2, position = position_dodge(0.75)) +
  scale_color_manual(values = c("#56B4E9", "#E69F00"), labels = c("Control", "VPA")) +
  scale_fill_manual(values = c("#56B4E9", "#E69F00"), guide = FALSE) +
  theme(
    legend.justification = "top",
    panel.grid.major.x = element_line(color = "black", linetype = "dashed"),
    panel.grid.major.y = element_blank(),
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)
    ) +
  ylab("Scaled Residuals") +
  xlab("Compound")
vf.purn.plot.prep %>% 
  ggplot(aes(plot_order, scaled_resid, color = VPA, fill = VPA)) +
  geom_hline(yintercept = 0, color = "gray50", size = 1) +
  geom_boxplot(alpha = 0.3) +
  geom_point(size = 2, position = position_dodge(0.75)) +
  scale_color_manual(values = c("#56B4E9", "#E69F00"), labels = c("Control", "VPA")) +
  scale_fill_manual(values = c("#56B4E9", "#E69F00"), guide = FALSE) +
  theme(
    legend.justification = "top",
    panel.grid.major.x = element_line(color = "black", linetype = "dashed"),
    panel.grid.major.y = element_blank(),
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)
    ) +
  ylab("Scaled Residuals") +
  xlab("Compound") +
  facet_wrap(~ FA, ncol = 1)
```

# Session Info

```{r session_info, comment=NA}
sessionInfo()
```

