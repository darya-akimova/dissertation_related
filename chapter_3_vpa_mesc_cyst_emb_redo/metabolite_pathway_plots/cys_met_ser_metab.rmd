---
title: "Cys/Met/Ser Metabolism"
author: "Darya Akimova"
date: "2/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Setup

## Packages

```{r packages, comment=NA}
library(tidyverse)
library(ggthemes)
library(cowplot)
theme_set(theme_minimal())
```


## Data

```{r data, comment=NA}
### pathway info ###
vpa.pathways <- read_csv("./data/pathway_info/vpa_only_exp1/vpa_only_exp_all_cmpnd_pathways.csv")
vf.pathways <- read_csv("./data/pathway_info/vpa_fa_exp1/vpa_fa_exp1_all_cmpnd_pathways.csv")
vpa.hilic.pathways <- read_csv("./data/pathway_info/vpa_hilic/vpa_hilic_exp_all_cmpnd_pathways.csv")
vf.p5.pathways <- read_csv("./data/pathway_info/vpa_fa_p5/vpa_fa_p5_all_cmpnd_pathways.csv")

### cleaned log2 residuals ###
vpa.abun.list <- paste(
  "./data/cleaned_abundances/vpa_only_exp1/", 
  list.files(path = "./data/cleaned_abundances/vpa_only_exp1/"), 
  sep = ""
  ) %>% 
  map(read_csv)
vf.abun.list <- paste(
  "./data/cleaned_abundances/vpa_fa_exp1/", 
  list.files(path = "./data/cleaned_abundances/vpa_fa_exp1/"), 
  sep = ""
  ) %>% 
  map(read_csv)
vpa.hilic.abun.list <- paste(
  "./data/cleaned_abundances/vpa_only_hilic/", 
  list.files(path = "./data/cleaned_abundances/vpa_only_hilic/"), 
  sep = ""
  ) %>% 
  map(read_csv)
vf.p5.abun.list <- paste(
  "./data/cleaned_abundances/vpa_fa_p5/", 
  list.files(path = "./data/cleaned_abundances/vpa_fa_p5/"), 
  sep = ""
  ) %>% 
  map(read_csv)

### statistically significant hits + FC 1.2 cut-off ###
vpa.hits.list <- paste(
  "./data/hit_lists/vpa_only_exp1/", 
  list.files(path = "./data/hit_lists/vpa_only_exp1/"), 
  sep = ""
  ) %>% 
  map(read_csv)
vf.hits.list <- paste(
  "./data/hit_lists/vpa_fa_exp1/", 
  list.files(path = "./data/hit_lists/vpa_fa_exp1/"), 
  sep = ""
  ) %>% 
  map(read_csv)
vpa.hilic.hits.list <- paste(
  "./data/hit_lists/vpa_only_hilic/", 
  list.files(path = "./data/hit_lists/vpa_only_hilic/"), 
  sep = ""
  ) %>% 
  map(read_csv)
vf.p5.hits.list <- paste(
  "./data/hit_lists/vpa_fa_p5/", 
  list.files(path = "./data/hit_lists/vpa_fa_p5/"), 
  sep = ""
  ) %>% 
  map(read_csv)
```


# Prep

Full list of all metabolites detected/quantified across VPA expriments that were found to be associated with either Purine metabolism, Pyrimidine metabolism, or the Pentose phosphate pathway:

```{r}
all.sulf.metab <- bind_rows(
  bind_rows(
    "vpa_only" = vpa.pathways %>% 
      filter(str_detect(path_name, "Glycine, serine and threonine metabolism") | str_detect(path_name, "Cysteine and methionine metabolism") | str_detect(path_name, "Taurine and hypotaurine metabolism") | str_detect(path_name, "Glutathione metabolism")),
    "vpa_hilic" = vpa.hilic.pathways %>% 
      filter(str_detect(path_name, "Glycine, serine and threonine metabolism") | str_detect(path_name, "Cysteine and methionine metabolism") | str_detect(path_name, "Taurine and hypotaurine metabolism") | str_detect(path_name, "Glutathione metabolism")),
    .id = "experiment"
    ), 
  bind_rows(
    "vf_first" = vf.pathways %>% 
      filter(str_detect(path_name, "Glycine, serine and threonine metabolism") | str_detect(path_name, "Cysteine and methionine metabolism") | str_detect(path_name, "Taurine and hypotaurine metabolism") | str_detect(path_name, "Glutathione metabolism")),
    "vf_p5" = vf.p5.pathways %>% 
      filter(str_detect(path_name, "Glycine, serine and threonine metabolism") | str_detect(path_name, "Cysteine and methionine metabolism") | str_detect(path_name, "Taurine and hypotaurine metabolism") | str_detect(path_name, "Glutathione metabolism")),
    .id = "experiment"
    )
  )
# preview
head(all.sulf.metab)
# full number of relevant metabolites across experiments
nrow(all.sulf.metab)
# unique number of compounds across experiments 
length(unique(all.sulf.metab$compound_full_exp))
```


Convert the full lists (all pathways) of statistically significant compounds from list to df format:

```{r hits_list_to_df, comment=NA}
### vpa exp 1 ###
vpa.hits.df <- bind_rows(
  "vpa_cell.neg" = vpa.hits.list[[1]],
  "vpa_cell.pos" = vpa.hits.list[[2]],
  "vpa_med.neg" = vpa.hits.list[[3]],
  .id = "exp_source.mode"
  ) %>% 
  select(compound_short, compound_full:cas_id, exp_source.mode, change_in_vpa, vpa_div_cntrl, adj.P.Val) %>% 
  rename("adj_pval" = adj.P.Val) %>% 
  filter(compound_short %in% all.sulf.metab$compound_short)
### vpa + fa exp 1 ###
vf.hits.df <- bind_rows(
  "vf_cell.neg" = vf.hits.list[[1]],
  "vf_cell.pos" = vf.hits.list[[2]],
  "vf_med.neg" = vf.hits.list[[3]],
  .id = "exp_source.mode"
  ) %>% 
  select(compound_short, compound_full:cas_id, exp_source.mode, term, change_in_vpa, FC, adj_pval) %>% 
  rename("vpa_div_cntrl" = FC) %>% 
  filter(compound_short %in% all.sulf.metab$compound_short)
### vpa hilic ### 
vpa.hilic.hits.df <- bind_rows(
  "vpa.hilic_cell.neg" = vpa.hilic.hits.list[[1]],
  "vpa.hilic_cell.pos" = vpa.hilic.hits.list[[2]],
  .id = "exp_source.mode"
  ) %>% 
  select(compound_short, compound_full:cas_id, exp_source.mode, change_in_vpa, vpa_div_cntrl, adj.P.Val) %>% 
  rename("adj_pval" = adj.P.Val) %>% 
  filter(compound_short %in% all.sulf.metab$compound_short)
### vpa + fa p5 ###
vf.p5.hits.df <- bind_rows(
  "vf.p5_cell.neg" = vf.p5.hits.list[[1]],
  "vf.p5_cell.pos" = vf.p5.hits.list[[2]],
  "vf.p5_med.neg" = vf.p5.hits.list[[3]],
  .id = "exp_source.mode"
  ) %>% 
  select(compound_short, compound_full:cas_id, exp_source.mode, term, change_in_vpa, FC, adj_pval) %>% 
  rename("vpa_div_cntrl" = FC)  %>% 
  filter(compound_short %in% all.sulf.metab$compound_short) %>% 
  distinct()
```


Need to convert the log2 abundance residuals (after regression onto covariates, or the intercept for a few) from list format to df, without losing info about exp/etc:

```{r abun_resid_list_to_df, warning=FALSE, comment=NA}
### vpa only ###
vpa.sulf.abun.df <- vpa.abun.list %>% 
  # pick only relevant sample info and compound abun columns (nucleotide metab)
  map(select, Samples, Treatment, one_of(all.sulf.metab$compound_short)) %>% 
  # convert from wide to long format for easy list -> df conversion
  map(gather, key = "compound_short", value = "log2_resid_abun", -c(Samples:Treatment)) %>% 
  # combine with experiment, pathway, etc 
  map(inner_join, all.sulf.metab, by = "compound_short") %>% 
  # list -> df
  bind_rows() %>%
  # rearrange the columns
  select(experiment, mode, Samples:compound_short, compound_full_exp, everything())
### vpa + fa exp 1 ###
vf.sulf.abun.df <- vf.abun.list %>%  
  map(select, Samples:FA, one_of(all.sulf.metab$compound_short)) %>% 
  map(gather, key = "compound_short", value = "log2_resid_abun", -c(Samples:FA)) %>% 
  map(inner_join, all.sulf.metab, by = "compound_short") %>% 
  bind_rows() %>% 
  mutate(FA = ifelse(FA == "cntrl", "1Xfa", "5Xfa")) %>% 
  unite("Treatment", VPA:FA, sep = "_") %>% 
  select(experiment, mode, Samples:compound_short, compound_full_exp, everything())
### vpa hilic ###
vpa.hilic.sulf.abun.df <- vpa.hilic.abun.list %>% 
  map(select, Samples, Group, one_of(all.sulf.metab$compound_short)) %>% 
  map(gather, key = "compound_short", value = "log2_resid_abun", -c(Samples:Group)) %>% 
  map(inner_join, all.sulf.metab, by = "compound_short") %>% 
  bind_rows() %>%
  rename("Treatment" = Group) %>% 
  select(experiment, mode, Samples:compound_short, compound_full_exp, everything())
### vpa + fa p5 hilic ###
vf.p5.sulf.abun.df <- vf.p5.abun.list %>%  
  map(select, Samples:FA, one_of(all.sulf.metab$compound_short)) %>% 
  map(gather, key = "compound_short", value = "log2_resid_abun", -c(Samples:FA)) %>% 
  map(inner_join, all.sulf.metab, by = "compound_short") %>% 
  bind_rows() %>% 
  mutate(FA = ifelse(FA == "base", "1Xfa", "5Xfa")) %>% 
  unite("Treatment", VPA:FA, sep = "_") %>% 
  select(experiment, mode, Samples:compound_short, compound_full_exp, everything())
```

The abundance df created in the above chunk include all compound related to nucleotide metabolism that had passed the filters, but not all of them were found to be statistically significant in the end. To mark the difference, a new column is needed:

```{r sig_column_create, comment=NA}
### vpa only ###
vpa.sulf.abun.df <- vpa.sulf.abun.df %>% 
  mutate(significant = ifelse(compound_short %in% vpa.hits.df$compound_short, TRUE, FALSE)) 
# check how many TRUE in df
vpa.sulf.abun.df %>% 
  select(compound_short, significant) %>% 
  distinct() %>% 
  {table(.$significant)}
# vs how many nucleotide metab hits there should be
nrow(vpa.hits.df)

### vpa + fa exp 1 ###
vf.sulf.abun.df <- vf.sulf.abun.df %>% 
  mutate(significant = ifelse(compound_short %in% vf.hits.df$compound_short, TRUE, FALSE))
vf.sulf.abun.df %>% 
  select(compound_short, significant) %>% 
  distinct() %>% 
  {table(.$significant)}
nrow(vf.hits.df)
length(unique(vf.hits.df$compound_short))
# difference because some compounds are sig for both low and high FA background, which were treated separatly

### vpa hilic ###
vpa.hilic.sulf.abun.df <- vpa.hilic.sulf.abun.df %>% 
  mutate(significant = ifelse(compound_short %in% vpa.hilic.hits.df$compound_short, TRUE, FALSE))
vpa.hilic.sulf.abun.df %>% 
  select(compound_short, significant) %>% 
  distinct() %>% 
  {table(.$significant)}
nrow(vpa.hilic.hits.df)

### vpa + fa p5 hilic ###
vf.p5.sulf.abun.df <- vf.p5.sulf.abun.df %>% 
  mutate(significant = ifelse(compound_short %in% vf.p5.hits.df$compound_short, TRUE, FALSE))
vf.p5.sulf.abun.df %>% 
  select(compound_short, significant) %>% 
  distinct() %>% 
  {table(.$significant)}
nrow(vf.p5.hits.df)
length(unique(vf.p5.hits.df$compound_short))
```


# Visualization

## GSH / GSSG ratios


```{r}

vpa.gsh.to.gssg.plot <- vpa.sulf.abun.df %>% 
  filter(compound_full_exp == "Glutathione" | compound_full_exp == "GSSG") %>% 
  select(-path_name) %>% 
  distinct() %>%
  select(-c(compound_short, cas_id:significant)) %>% 
  spread(compound_full_exp, log2_resid_abun) %>% 
  mutate(ratio_glut_gssg = 2 ^ (Glutathione - GSSG)) %>% 
  ggplot(aes(Treatment, ratio_glut_gssg, color = Treatment)) +
  geom_boxplot(alpha = 0.5) +
  geom_point(size = 2, position = position_dodge(0.75)) +
  scale_color_manual(values = c("#56B4E9", "#E69F00"), labels = c("Control", "VPA")) +
  #scale_fill_manual(values = c("#56B4E9", "#E69F00")) +
  facet_wrap(~ mode) +
  ylab("GSH / GSSG") +
  ggtitle("GSH / GSSG\nVPA-only (Exp 1) Neg and Pos Mode")

vf.gsh.to.gssg.plot <- vf.sulf.abun.df %>% 
  filter(compound_full_exp == "Glutathione" | compound_full_exp == "GSSG") %>% 
  select(-path_name) %>% 
  distinct() %>% 
  select(-c(compound_short, cas_id:significant)) %>% 
  spread(compound_full_exp, log2_resid_abun) %>% 
  mutate(ratio_glut_gssg = 2 ^ (Glutathione - GSSG)) %>% 
  ggplot(aes(Treatment, ratio_glut_gssg, color = Treatment)) +
  geom_boxplot(alpha = 0.5) +
  geom_point(size = 2, position = position_dodge(0.75)) +
  scale_color_tableau() +
  scale_fill_tableau() +
  facet_wrap(~ mode) +
  ylab("GSH / GSSG") +
  theme(axis.text.x = element_text(angle = 60, hjust = 1)) +
  ggtitle("GSH / GSSG\nVPA + FA (Exp 3) Neg and Pos Mode")

vpa.hilic.gsh.to.gssg.plot <- vpa.hilic.sulf.abun.df %>% 
  filter(compound_full_exp == "Glutathione (GSH)" | compound_full_exp == "GSSG") %>% 
  select(-path_name) %>% 
  distinct() %>%
  select(-c(compound_short, cas_id:significant)) %>% 
  spread(compound_full_exp, log2_resid_abun) %>% 
  rename(Glutathione = `Glutathione (GSH)`) %>% 
  mutate(ratio_glut_gssg = 2 ^ (Glutathione - GSSG)) %>% 
  ggplot(aes(Treatment, ratio_glut_gssg, color = Treatment)) +
  geom_boxplot(alpha = 0.5) +
  geom_point(size = 2, position = position_dodge(0.75)) +
  scale_color_manual(values = c("#56B4E9", "#E69F00"), labels = c("Control", "VPA")) +
  facet_wrap(~ mode) +
  ylab("GSH / GSSG") +
  ggtitle("GSH / GSSG\nVPA-only HILIC (Exp 4) Neg and Pos Mode")

vf.p5.gsh.to.gssg.plot <- vf.p5.sulf.abun.df %>% 
  filter(compound_full_exp == "Glutathione (GSH)" | compound_full_exp == "GSSG") %>% 
  select(-path_name) %>% 
  distinct() %>% 
  select(-c(compound_short, cas_id:significant)) %>% 
  spread(compound_full_exp, log2_resid_abun) %>% 
  rename(Glutathione = `Glutathione (GSH)`) %>%
  mutate(ratio_glut_gssg = 2 ^ (Glutathione - GSSG)) %>% 
  ggplot(aes(Treatment, ratio_glut_gssg, color = Treatment)) +
  geom_boxplot(alpha = 0.5) +
  geom_point(size = 2, position = position_dodge(0.75)) +
  scale_color_tableau() +
  facet_wrap(~ mode) +
  ylab("GSH / GSSG") +
  ggtitle("GSH / GSSG\nP5 FA / VPA + FA (Exp 5) Neg and Pos Mode") +
  theme(axis.text.x = element_text(angle = 60, hjust = 1))

gsh.to.gssg.grid <- plot_grid(vpa.gsh.to.gssg.plot, vpa.hilic.gsh.to.gssg.plot, vf.gsh.to.gssg.plot, vf.p5.gsh.to.gssg.plot, rel_heights = c(1, 1.5))
save_plot("./results/gsh_to_gssg_ratio_plots.png", gsh.to.gssg.grid, base_height = 6, base_width = 8)
```



## X metabolism:



```{r raw_resid_plots, comment=NA, fig.height=8, fig.width = 6}
# raw residuals
vpa.sulf.abun.df %>% 
  filter(path_name == "Glutathione metabolism") %>% 
  mutate(alt_cmpnd_name = paste(compound_full_exp, " (", mode, ")", sep = "")) %>% 
  ggplot(aes(alt_cmpnd_name, log2_resid_abun, color = Treatment, fill = Treatment)) +
  geom_boxplot(alpha = 0.5) +
  geom_point(size = 2, position = position_dodge(0.75)) +
  scale_color_manual(values = c("#56B4E9", "#E69F00"), labels = c("Control", "VPA")) +
  scale_fill_manual(values = c("#56B4E9", "#E69F00")) +
  theme(
    axis.text.x = element_text(angle = 60, hjust = 1, vjust = 1),
    legend.justification = "top"
    ) +
  ggtitle("Glutathione Metabolism (All detect)\nVPA-only (Exp 1)") +
  xlab("Compound Name") +
  ylab("log2(Compound Residuals)") +
  facet_wrap(~ significant)



vpa.sulf.abun.df %>% 
  filter(path_name == "Cysteine and methionine metabolism") %>% 
  mutate(alt_cmpnd_name = paste(compound_full_exp, " (", mode, ")", sep = "")) %>% 
  ggplot(aes(alt_cmpnd_name, log2_resid_abun, color = Treatment, fill = Treatment)) +
  geom_boxplot(alpha = 0.5) +
  geom_point(size = 2, position = position_dodge(0.75)) +
  scale_color_manual(values = c("#56B4E9", "#E69F00"), labels = c("Control", "VPA")) +
  scale_fill_manual(values = c("#56B4E9", "#E69F00")) +
  theme(
    axis.text.x = element_text(angle = 60, hjust = 1, vjust = 1),
    legend.justification = "top"
    ) +
  ggtitle("Cys/Met Metabolism (All detect)\nVPA-only (Exp 1)") +
  xlab("Compound Name") +
  ylab("log2(Compound Residuals)")
vpa.sulf.abun.df %>% 
  filter(path_name == "Glycine, serine and threonine metabolism") %>% 
  mutate(alt_cmpnd_name = paste(compound_full_exp, " (", mode, ")", sep = "")) %>% 
  ggplot(aes(alt_cmpnd_name, log2_resid_abun, color = Treatment, fill = Treatment)) +
  geom_boxplot(alpha = 0.5) +
  geom_point(size = 2, position = position_dodge(0.75)) +
  scale_color_manual(values = c("#56B4E9", "#E69F00"), labels = c("Control", "VPA")) +
  scale_fill_manual(values = c("#56B4E9", "#E69F00")) +
  theme(
    axis.text.x = element_text(angle = 60, hjust = 1, vjust = 1),
    legend.justification = "top"
    ) +
  ggtitle("Gly/Ser/Thr Metabolism (All detect)\nVPA-only (Exp 1)") +
  xlab("Compound Name") +
  ylab("log2(Compound Residuals)")
vpa.sulf.abun.df %>% 
  filter(path_name == "Taurine and hypotaurine metabolism") %>% 
  mutate(alt_cmpnd_name = paste(compound_full_exp, " (", mode, ")", sep = "")) %>% 
  ggplot(aes(alt_cmpnd_name, log2_resid_abun, color = Treatment, fill = Treatment)) +
  geom_boxplot(alpha = 0.5) +
  geom_point(size = 2, position = position_dodge(0.75)) +
  scale_color_manual(values = c("#56B4E9", "#E69F00"), labels = c("Control", "VPA")) +
  scale_fill_manual(values = c("#56B4E9", "#E69F00")) +
  theme(
    axis.text.x = element_text(angle = 60, hjust = 1, vjust = 1),
    legend.justification = "top"
    ) +
  ggtitle("Taurine/Hypotaurine Metabolism (All detect)\nVPA-only (Exp 1)") +
  xlab("Compound Name") +
  ylab("log2(Compound Residuals)")

```


What about comparisons between experiments?

```{r comment=NA, fig.height=8, fig.width = 6}
vpa.nucl.abun.df %>% 
  filter(path_name == "Purine metabolism") %>% 
  mutate(alt_cmpnd_name = paste(compound_full_exp, " (", mode, ")", sep = ""))
vf.nucl.abun.df %>% 
  filter(path_name == "Purine metabolism") %>% 
  separate(Treatment, into = c("VPA", "FA"), sep = "_") %>% 
  mutate(alt_cmpnd_name = paste(compound_full_exp, " (", mode, " / ", FA, ")", sep = "")) %>% 
  group_by(alt_cmpnd_name) %>% 
  mutate(scaled_resid = scale(log2_resid_abun)) %>% 
  ungroup() %>% 
  ggplot(aes(alt_cmpnd_name, scaled_resid, color = VPA, fill = VPA)) +
  geom_hline(yintercept = 0, color = "gray50", size = 1) +
 # geom_boxplot(alpha = 0.5) +
  geom_point(size = 2, position = position_dodge(0.75), alpha = 0.8) +
  scale_color_manual(values = c("#56B4E9", "#E69F00"), labels = c("Control", "VPA")) +
  scale_fill_manual(values = c("#56B4E9", "#E69F00")) +
  theme(
    legend.justification = "top",
    panel.grid.major.y = element_line(color = "gray50", linetype = "dashed"),
    panel.grid.major.x = element_blank()
    ) +
  coord_flip() +
  facet_wrap(~ significant)
```


What if I show only significant compounds?

```{r only_significant_plots, comment=NA, fig.height=8, fig.width = 6}
vpa.nucl.abun.df %>% 
  filter(path_name == "Purine metabolism" & significant == TRUE) %>% 
  mutate(alt_cmpnd_name = paste(compound_full_exp, " (", mode, ")", sep = "")) %>% 
  group_by(alt_cmpnd_name) %>% 
  mutate(scaled_resid = scale(log2_resid_abun)) %>% 
  ungroup() %>% 
  ggplot(aes(alt_cmpnd_name, scaled_resid, color = Treatment, fill = Treatment)) +
  geom_hline(yintercept = 0, color = "gray50", size = 1) +
  geom_boxplot(alpha = 0.5) +
  geom_point(size = 1.5, position = position_dodge(0.75)) +
  scale_color_manual(values = c("#56B4E9", "#E69F00"), labels = c("Control", "VPA")) +
  scale_fill_manual(values = c("#56B4E9", "#E69F00"), guide = FALSE) +
  theme(
    legend.justification = "top",
    panel.grid.major.y = element_line(color = "black", linetype = "dashed"),
    panel.grid.major.x = element_blank()
    ) +
  coord_flip() +
  ylab("Scaled Residuals") +
  xlab("Compound")
```

Sort by FC? No - would like to keep same compound by mode together. Maybe average? Yes.

```{r comment=NA, fig.height=8, fig.width = 6}
### vpa only ###
vpa.purn.plot.prep <- vpa.nucl.abun.df %>% 
  filter(path_name == "Purine metabolism" & significant == TRUE) %>% 
  mutate(alt_cmpnd_name = paste(compound_full_exp, " (", mode, ")", sep = "")) %>% 
  group_by(alt_cmpnd_name) %>% 
  mutate(scaled_resid = scale(log2_resid_abun)) %>% 
  ungroup() %>% 
  inner_join(
    vpa.hits.df %>% 
      group_by(compound_full) %>% 
      summarize(avg_FC = mean(vpa_div_cntrl)),
    by = c("compound_full_exp" = "compound_full")
    ) %>% 
  arrange(desc(avg_FC), alt_cmpnd_name) %>%
  mutate(plot_order = factor(alt_cmpnd_name, levels = unique(alt_cmpnd_name)))
vpa.purn.plot.prep %>% 
  ggplot(aes(plot_order, scaled_resid, color = Treatment, fill = Treatment)) +
  geom_hline(yintercept = 0, color = "gray50", size = 1) +
  geom_boxplot(alpha = 0.3) +
  geom_point(size = 2, position = position_dodge(0.75)) +
  scale_color_manual(values = c("#56B4E9", "#E69F00"), labels = c("Control", "VPA")) +
  scale_fill_manual(values = c("#56B4E9", "#E69F00"), guide = FALSE) +
  theme(
    legend.justification = "top",
    panel.grid.major.y = element_line(color = "black", linetype = "dashed"),
    panel.grid.major.x = element_blank()
    ) +
  coord_flip() +
  ylab("Scaled Residuals") +
  xlab("Compound")
### vpa + fa exp 1 ###
vf.purn.plot.prep <- vf.nucl.abun.df %>% 
  filter(path_name == "Purine metabolism" & significant == TRUE) %>% 
  separate(Treatment, into = c("VPA", "FA"), sep = "_") %>% 
  mutate(alt_cmpnd_name = paste(compound_full_exp, " (", mode, ")", sep = "")) %>% 
  group_by(alt_cmpnd_name) %>% 
  mutate(scaled_resid = scale(log2_resid_abun)) %>% 
  ungroup() %>% 
  inner_join(
    vf.hits.df %>% 
      group_by(compound_full) %>% 
      summarize(avg_FC = mean(vpa_div_cntrl)),
    by = c("compound_full_exp" = "compound_full")
    ) %>% 
  arrange(desc(avg_FC), alt_cmpnd_name) %>%
  mutate(plot_order = factor(alt_cmpnd_name, levels = unique(alt_cmpnd_name)))
vf.purn.plot.prep %>% 
  ggplot(aes(plot_order, scaled_resid, color = VPA, fill = VPA)) +
  geom_hline(yintercept = 0, color = "gray50", size = 1) +
  geom_boxplot(alpha = 0.3) +
  geom_point(size = 2, position = position_dodge(0.75)) +
  scale_color_manual(values = c("#56B4E9", "#E69F00"), labels = c("Control", "VPA")) +
  scale_fill_manual(values = c("#56B4E9", "#E69F00"), guide = FALSE) +
  theme(
    legend.justification = "top",
    panel.grid.major.y = element_line(color = "black", linetype = "dashed"),
    panel.grid.major.x = element_blank()
    ) +
  coord_flip() +
  ylab("Scaled Residuals") +
  xlab("Compound") +
  facet_wrap(~ FA, ncol = 2, scales = "free_y")
```


```{r purine_plot_final, comment=NA}
vpa.only.purine.plot <- vpa.purn.plot.prep %>% 
  ggplot(aes(plot_order, scaled_resid, color = Treatment, fill = Treatment)) +
  geom_hline(yintercept = 0, color = "gray50", size = 1) +
  geom_boxplot(alpha = 0.3) +
  geom_point(size = 1.5, position = position_dodge(0.75)) +
  scale_color_manual(values = c("#56B4E9", "#E69F00"), labels = c("Control", "VPA")) +
  scale_fill_manual(values = c("#56B4E9", "#E69F00"), guide = FALSE) +
  theme(
    legend.justification = "top",
    panel.grid.major.x = element_line(color = "black", linetype = "dashed"),
    panel.grid.major.y = element_blank(),
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)
    ) +
  ylab("Scaled Residuals") +
  xlab("Compound")
vf.purine.plot <- vf.purn.plot.prep %>% 
  mutate(FA = ifelse(str_detect(FA, "1Xfa"), "1X FA", "5X FA")) %>% 
  ggplot(aes(plot_order, scaled_resid, color = VPA, fill = VPA)) +
  geom_hline(yintercept = 0, color = "gray50", size = 1) +
  geom_boxplot(alpha = 0.3) +
  geom_point(size = 1.5, position = position_dodge(0.75)) +
  scale_color_manual(values = c("#56B4E9", "#E69F00"), labels = c("Control", "VPA")) +
  scale_fill_manual(values = c("#56B4E9", "#E69F00"), guide = FALSE) +
  theme(
    legend.justification = "top",
    panel.grid.major.x = element_line(color = "black", linetype = "dashed"),
    panel.grid.major.y = element_blank(),
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)
    ) +
  ylab("Scaled Residuals") +
  xlab("Compound") +
  facet_wrap(~ FA, ncol = 1)
vpa.only.purine.plot
vf.purine.plot
#save_plot(filename = "./results/vpa_vf_sig_purine_plot.png", plot_grid(vpa.only.purine.plot, vf.purine.plot, ncol = 1, labels = c("A", "B"), rel_heights = c(1.25, 2)), base_height = 8.5, base_width = 6)
```

Separate triphosphates for ppt presentation

```{r}
vpa.only.purine.notri.plot <- vpa.purn.plot.prep %>% 
  filter(compound_full_exp != "GTP" & compound_full_exp != "ATP") %>% 
  ggplot(aes(plot_order, scaled_resid, color = Treatment, fill = Treatment)) +
  geom_hline(yintercept = 0, color = "gray50", size = 1) +
  geom_boxplot(alpha = 0.3) +
  geom_point(size = 1.5, position = position_dodge(0.75)) +
  scale_color_manual(values = c("#56B4E9", "#E69F00"), labels = c("Control", "VPA")) +
  scale_fill_manual(values = c("#56B4E9", "#E69F00"), guide = FALSE) +
  theme(
    legend.justification = "top",
    panel.grid.major.x = element_line(color = "black", linetype = "dashed"),
    panel.grid.major.y = element_blank(),
    axis.text.x = element_text(angle = 60, hjust = 1, vjust = 1)
    ) +
  ylab("Scaled Residuals") +
  xlab("Compound") +
  ggtitle("Purine biosynthesis and degradation\nVPA-only (Exp 1)")
vf.purine.notri.plot <- vf.purn.plot.prep %>% 
  filter(compound_full_exp != "GTP" & compound_full_exp != "ATP") %>% 
  mutate(FA = ifelse(str_detect(FA, "1Xfa"), "1X FA", "5X FA")) %>% 
  ggplot(aes(plot_order, scaled_resid, color = VPA, fill = VPA)) +
  geom_hline(yintercept = 0, color = "gray50", size = 1) +
  geom_boxplot(alpha = 0.3) +
  geom_point(size = 1.5, position = position_dodge(0.75)) +
  scale_color_manual(values = c("#56B4E9", "#E69F00"), labels = c("Control", "VPA")) +
  scale_fill_manual(values = c("#56B4E9", "#E69F00"), guide = FALSE) +
  theme(
    legend.justification = "top",
    panel.grid.major.x = element_line(color = "black", linetype = "dashed"),
    panel.grid.major.y = element_blank(),
    axis.text.x = element_text(angle = 60, hjust = 1, vjust = 1)
    ) +
  ylab("Scaled Residuals") +
  xlab("Compound") +
  facet_wrap(~ FA, ncol = 1)+
  ggtitle("Purine biosynthesis and degradation\nVPA + FA Exp (Exp 3)")
vpa.only.purine.notri.plot
vf.purine.notri.plot 

#save_plot(filename = "./results/vpa_sig_purine_notri_plot.png", vpa.only.purine.notri.plot, base_height = 4, base_width = 6)
#save_plot(filename = "./results/vf_sig_purine_notri_plot.png", vf.purine.notri.plot, base_height = 6, base_width = 6)
```


## Pyrimidine metabolism

```{r}
vpa.pyrim.plot.prep <- vpa.nucl.abun.df %>% 
  filter(path_name == "Pyrimidine metabolism" & significant == TRUE) %>% 
  mutate(alt_cmpnd_name = paste(compound_full_exp, " (", mode, ")", sep = "")) %>% 
  group_by(alt_cmpnd_name) %>% 
  mutate(scaled_resid = scale(log2_resid_abun)) %>% 
  ungroup() %>% 
  inner_join(
    vpa.hits.df %>% 
      group_by(compound_full) %>% 
      summarize(avg_FC = mean(vpa_div_cntrl)),
    by = c("compound_full_exp" = "compound_full")
    ) %>% 
  arrange(desc(avg_FC), alt_cmpnd_name) %>%
  mutate(plot_order = factor(alt_cmpnd_name, levels = unique(alt_cmpnd_name)))
vf.pyrim.plot.prep <- vf.nucl.abun.df %>% 
  filter(path_name == "Pyrimidine metabolism" & significant == TRUE) %>% 
  separate(Treatment, into = c("VPA", "FA"), sep = "_") %>% 
  mutate(alt_cmpnd_name = paste(compound_full_exp, " (", mode, ")", sep = "")) %>% 
  group_by(alt_cmpnd_name) %>% 
  mutate(scaled_resid = scale(log2_resid_abun)) %>% 
  ungroup() %>% 
  inner_join(
    vf.hits.df %>% 
      group_by(compound_full) %>% 
      summarize(avg_FC = mean(vpa_div_cntrl)),
    by = c("compound_full_exp" = "compound_full")
    ) %>% 
  arrange(desc(avg_FC), alt_cmpnd_name) %>%
  mutate(alt_cmpnd_name = ifelse(alt_cmpnd_name == "N-Carbamoyl-L-aspartic Acid (cell.pos)", "Carbamoyl-\naspartic Acid (cell.pos)", alt_cmpnd_name)) %>% 
  mutate(plot_order = factor(alt_cmpnd_name, levels = unique(alt_cmpnd_name)))
```


```{r pyrim_plot_final, comment=NA}
vpa.only.pyrim.plot <- vpa.pyrim.plot.prep %>% 
  ggplot(aes(plot_order, scaled_resid, color = Treatment, fill = Treatment)) +
  geom_hline(yintercept = 0, color = "gray50", size = 1) +
  geom_boxplot(alpha = 0.3) +
  geom_point(size = 1.5, position = position_dodge(0.75)) +
  scale_color_manual(values = c("#56B4E9", "#E69F00"), labels = c("Control", "VPA")) +
  scale_fill_manual(values = c("#56B4E9", "#E69F00"), guide = FALSE) +
  theme(
    legend.justification = "top",
    panel.grid.major.x = element_line(color = "black", linetype = "dashed"),
    panel.grid.major.y = element_blank(),
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)
    ) +
  ylab("Scaled Residuals") +
  xlab("Compound")
vf.pyrim.plot <- vf.pyrim.plot.prep %>% 
  mutate(FA = ifelse(str_detect(FA, "1Xfa"), "1X FA", "5X FA")) %>% 
  ggplot(aes(plot_order, scaled_resid, color = VPA, fill = VPA)) +
  geom_hline(yintercept = 0, color = "gray50", size = 1) +
  geom_boxplot(alpha = 0.3) +
  geom_point(size = 1.5, position = position_dodge(0.75)) +
  scale_color_manual(values = c("#56B4E9", "#E69F00"), labels = c("Control", "VPA")) +
  scale_fill_manual(values = c("#56B4E9", "#E69F00"), guide = FALSE) +
  theme(
    legend.justification = "top",
    panel.grid.major.x = element_line(color = "black", linetype = "dashed"),
    panel.grid.major.y = element_blank(),
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)
    ) +
  ylab("Scaled Residuals") +
  xlab("Compound") +
  facet_wrap(~ FA, ncol = 1)
vpa.only.pyrim.plot
vf.pyrim.plot 
#save_plot(filename = "./results/vpa_vf_sig_pyrim_plot.png", plot_grid(vpa.only.pyrim.plot, vf.pyrim.plot, ncol = 1, labels = c("A", "B"), rel_heights = c(1, 2)), base_height = 8.5, base_width = 6)
```



Separate triphosphates for ppt presentation

```{r}
vpa.only.pyrim.notri.plot <- vpa.pyrim.plot.prep %>% 
  filter(compound_full_exp != "CTP" & compound_full_exp != "UTP") %>% 
  ggplot(aes(plot_order, scaled_resid, color = Treatment, fill = Treatment)) +
  geom_hline(yintercept = 0, color = "gray50", size = 1) +
  geom_boxplot(alpha = 0.3) +
  geom_point(size = 1.5, position = position_dodge(0.75)) +
  scale_color_manual(values = c("#56B4E9", "#E69F00"), labels = c("Control", "VPA")) +
  scale_fill_manual(values = c("#56B4E9", "#E69F00"), guide = FALSE) +
  theme(
    legend.justification = "top",
    panel.grid.major.x = element_line(color = "black", linetype = "dashed"),
    panel.grid.major.y = element_blank(),
    axis.text.x = element_text(angle = 60, hjust = 1, vjust = 1)
    ) +
  ylab("Scaled Residuals") +
  xlab("Compound") +
  ggtitle("Pyrimidine biosynthesis and degradation\nVPA-only (Exp 1)")
vf.pyrim.notri.plot <- vf.pyrim.plot.prep %>% 
  filter(compound_full_exp != "dTTP" & compound_full_exp != "CTP" & compound_full_exp != "UTP") %>% 
  mutate(FA = ifelse(str_detect(FA, "1Xfa"), "1X FA", "5X FA")) %>% 
  ggplot(aes(plot_order, scaled_resid, color = VPA, fill = VPA)) +
  geom_hline(yintercept = 0, color = "gray50", size = 1) +
  geom_boxplot(alpha = 0.3) +
  geom_point(size = 1.5, position = position_dodge(0.75)) +
  scale_color_manual(values = c("#56B4E9", "#E69F00"), labels = c("Control", "VPA")) +
  scale_fill_manual(values = c("#56B4E9", "#E69F00"), guide = FALSE) +
  theme(
    legend.justification = "top",
    panel.grid.major.x = element_line(color = "black", linetype = "dashed"),
    panel.grid.major.y = element_blank(),
    axis.text.x = element_text(angle = 60, hjust = 1, vjust = 1)
    ) +
  ylab("Scaled Residuals") +
  xlab("Compound") +
  facet_wrap(~ FA, ncol = 1) +
  ggtitle("Pyrimidine biosynthesis and degradation\nVPA + FA Exp (Exp 3)")
vpa.only.pyrim.notri.plot
vf.pyrim.notri.plot

#save_plot(filename = "./results/vpa_sig_pyrim_notri_plot.png", vpa.only.pyrim.notri.plot, base_height = 4, base_width = 6)
#save_plot(filename = "./results/vf_sig_pyrim_notri_plot.png", vf.pyrim.notri.plot, base_height = 6, base_width = 6)
```


Triphosphates

```{r}
vpa.purn.plot.prep %>% 
  filter(compound_full_exp == "GTP" | compound_full_exp == "ATP")
vf.purn.plot.prep %>% 
  filter(compound_full_exp == "GTP" | compound_full_exp == "ATP")
vpa.pyrim.plot.prep %>% 
  filter(compound_full_exp == "CTP" | compound_full_exp == "UTP")
vf.pyrim.plot.prep %>% 
  filter(compound_full_exp == "dTTP" | compound_full_exp == "CTP" | compound_full_exp == "UTP")

vpa.only.purine.tri.plot <- vpa.purn.plot.prep %>% 
  filter(compound_full_exp == "GTP" | compound_full_exp == "ATP") %>% 
  ggplot(aes(plot_order, scaled_resid, color = Treatment, fill = Treatment)) +
  geom_hline(yintercept = 0, color = "gray50", size = 1) +
  geom_boxplot(alpha = 0.3) +
  geom_point(size = 1.5, position = position_dodge(0.75)) +
  scale_color_manual(values = c("#56B4E9", "#E69F00"), labels = c("Control", "VPA")) +
  scale_fill_manual(values = c("#56B4E9", "#E69F00"), guide = FALSE) +
  theme(
    legend.justification = "top",
    panel.grid.major.x = element_line(color = "black", linetype = "dashed"),
    panel.grid.major.y = element_blank(),
    axis.text.x = element_text(angle = 60, hjust = 1, vjust = 1)
    ) +
  ylab("Scaled Residuals") +
  xlab("Compound") +
  ggtitle("Purine triphosphates\nVPA-only (Exp 1)")
vf.purine.tri.plot <- vf.purn.plot.prep %>% 
  filter(compound_full_exp == "GTP" | compound_full_exp == "ATP") %>% 
  mutate(FA = ifelse(str_detect(FA, "1Xfa"), "1X FA", "5X FA")) %>% 
  ggplot(aes(plot_order, scaled_resid, color = VPA, fill = VPA)) +
  geom_hline(yintercept = 0, color = "gray50", size = 1) +
  geom_boxplot(alpha = 0.3) +
  geom_point(size = 1.5, position = position_dodge(0.75)) +
  scale_color_manual(values = c("#56B4E9", "#E69F00"), labels = c("Control", "VPA")) +
  scale_fill_manual(values = c("#56B4E9", "#E69F00"), guide = FALSE) +
  theme(
    legend.justification = "top",
    panel.grid.major.x = element_line(color = "black", linetype = "dashed"),
    panel.grid.major.y = element_blank(),
    axis.text.x = element_text(angle = 60, hjust = 1, vjust = 1)
    ) +
  ylab("Scaled Residuals") +
  xlab("Compound") +
  facet_wrap(~ FA, ncol = 1)+
  ggtitle("Purine triphosphates\nVPA + FA Exp (Exp 3)")
vpa.only.pyrim.tri.plot <- vpa.pyrim.plot.prep %>% 
  filter(compound_full_exp == "CTP" | compound_full_exp == "UTP") %>% 
  ggplot(aes(plot_order, scaled_resid, color = Treatment, fill = Treatment)) +
  geom_hline(yintercept = 0, color = "gray50", size = 1) +
  geom_boxplot(alpha = 0.3) +
  geom_point(size = 1.5, position = position_dodge(0.75)) +
  scale_color_manual(values = c("#56B4E9", "#E69F00"), labels = c("Control", "VPA")) +
  scale_fill_manual(values = c("#56B4E9", "#E69F00"), guide = FALSE) +
  theme(
    legend.justification = "top",
    panel.grid.major.x = element_line(color = "black", linetype = "dashed"),
    panel.grid.major.y = element_blank(),
    axis.text.x = element_text(angle = 60, hjust = 1, vjust = 1)
    ) +
  ylab("Scaled Residuals") +
  xlab("Compound") +
  ggtitle("Pyrimidine triphosphates\nVPA-only (Exp 1)")
vf.pyrim.tri.plot <- vf.pyrim.plot.prep %>% 
  filter(compound_full_exp == "dTTP" | compound_full_exp == "CTP" | compound_full_exp == "UTP") %>% 
  mutate(FA = ifelse(str_detect(FA, "1Xfa"), "1X FA", "5X FA")) %>% 
  ggplot(aes(plot_order, scaled_resid, color = VPA, fill = VPA)) +
  geom_hline(yintercept = 0, color = "gray50", size = 1) +
  geom_boxplot(alpha = 0.3) +
  geom_point(size = 1.5, position = position_dodge(0.75)) +
  scale_color_manual(values = c("#56B4E9", "#E69F00"), labels = c("Control", "VPA")) +
  scale_fill_manual(values = c("#56B4E9", "#E69F00"), guide = FALSE) +
  theme(
    legend.justification = "top",
    panel.grid.major.x = element_line(color = "black", linetype = "dashed"),
    panel.grid.major.y = element_blank(),
    axis.text.x = element_text(angle = 60, hjust = 1, vjust = 1)
    ) +
  ylab("Scaled Residuals") +
  xlab("Compound") +
  facet_wrap(~ FA, ncol = 1) +
  ggtitle("Pyrimidine triphosphates\nVPA + FA Exp (Exp 3)")
vpa.only.purine.tri.plot
vf.purine.tri.plot
vpa.only.pyrim.tri.plot 
vf.pyrim.tri.plot
triphos.grid <- plot_grid(
  plot_grid(vpa.only.purine.tri.plot, vpa.only.pyrim.tri.plot, ncol = 1),
  vf.purine.tri.plot,
  vf.pyrim.tri.plot,
  ncol = 3,
  rel_widths = c(1, 1.25, 1.5)
  )
#save_plot(filename = "./results/triphos_plot.png", triphos.grid, base_height = 5, base_width = 10)
```




## Pentose phosphate pathway

```{r}
vpa.ppp.plot.prep <- vpa.nucl.abun.df %>% 
  filter(path_name == "Pentose phosphate pathway" & significant == TRUE) %>% 
  mutate(alt_cmpnd_name = paste(compound_full_exp, "\n(", mode, ")", sep = "")) %>% 
  group_by(alt_cmpnd_name) %>% 
  mutate(scaled_resid = scale(log2_resid_abun)) %>% 
  ungroup() %>% 
  inner_join(
    vpa.hits.df %>% 
      group_by(compound_full) %>% 
      summarize(avg_FC = mean(vpa_div_cntrl)),
    by = c("compound_full_exp" = "compound_full")
    ) %>% 
  arrange(desc(avg_FC), alt_cmpnd_name) %>%
  mutate(plot_order = factor(alt_cmpnd_name, levels = unique(alt_cmpnd_name)))
vpa.only.ppp.plot <- vpa.ppp.plot.prep %>% 
  ggplot(aes(plot_order, scaled_resid, color = Treatment, fill = Treatment)) +
  geom_hline(yintercept = 0, color = "gray50", size = 1) +
  geom_boxplot(alpha = 0.3) +
  geom_point(size = 1.5, position = position_dodge(0.75)) +
  scale_color_manual(values = c("#56B4E9", "#E69F00"), labels = c("Control", "VPA")) +
  scale_fill_manual(values = c("#56B4E9", "#E69F00"), guide = FALSE) +
  theme(
    legend.justification = "top",
    panel.grid.major.x = element_line(color = "black", linetype = "dashed"),
    panel.grid.major.y = element_blank(),
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)
    ) +
  ylab("Scaled Residuals") +
  xlab("Compound")
vpa.only.ppp.plot
#save_plot(filename = "./results/vpa_sig_ppp_plot.png", vpa.only.ppp.plot, base_height = 4, base_width = 6)
```


# Session Info

```{r session_info, comment=NA}
sessionInfo()
```

