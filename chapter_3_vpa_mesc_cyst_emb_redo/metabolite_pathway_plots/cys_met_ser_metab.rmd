---
title: "Cys/Met/Ser Metabolism"
author: "Darya Akimova"
date: "2/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Setup

## Packages

```{r packages, comment=NA}
library(tidyverse)
library(ggthemes)
library(cowplot)
theme_set(theme_minimal())
```


## Data

```{r data, comment=NA}
### pathway info ###
vpa.pathways <- read_csv("./data/pathway_info/vpa_only_exp1/vpa_only_exp_all_cmpnd_pathways.csv")
vf.pathways <- read_csv("./data/pathway_info/vpa_fa_exp1/vpa_fa_exp1_all_cmpnd_pathways.csv")
vpa.hilic.pathways <- read_csv("./data/pathway_info/vpa_hilic/vpa_hilic_exp_all_cmpnd_pathways.csv")
vf.p5.pathways <- read_csv("./data/pathway_info/vpa_fa_p5/vpa_fa_p5_all_cmpnd_pathways.csv")

### cleaned log2 residuals ###
vpa.abun.list <- paste(
  "./data/cleaned_abundances/vpa_only_exp1/", 
  list.files(path = "./data/cleaned_abundances/vpa_only_exp1/"), 
  sep = ""
  ) %>% 
  map(read_csv)
vf.abun.list <- paste(
  "./data/cleaned_abundances/vpa_fa_exp1/", 
  list.files(path = "./data/cleaned_abundances/vpa_fa_exp1/"), 
  sep = ""
  ) %>% 
  map(read_csv)
vpa.hilic.abun.list <- paste(
  "./data/cleaned_abundances/vpa_only_hilic/", 
  list.files(path = "./data/cleaned_abundances/vpa_only_hilic/"), 
  sep = ""
  ) %>% 
  map(read_csv)
vf.p5.abun.list <- paste(
  "./data/cleaned_abundances/vpa_fa_p5/", 
  list.files(path = "./data/cleaned_abundances/vpa_fa_p5/"), 
  sep = ""
  ) %>% 
  map(read_csv)

### statistically significant hits + FC 1.2 cut-off ###
vpa.hits.list <- paste(
  "./data/hit_lists/vpa_only_exp1/", 
  list.files(path = "./data/hit_lists/vpa_only_exp1/"), 
  sep = ""
  ) %>% 
  map(read_csv)
vf.hits.list <- paste(
  "./data/hit_lists/vpa_fa_exp1/", 
  list.files(path = "./data/hit_lists/vpa_fa_exp1/"), 
  sep = ""
  ) %>% 
  map(read_csv)
vpa.hilic.hits.list <- paste(
  "./data/hit_lists/vpa_only_hilic/", 
  list.files(path = "./data/hit_lists/vpa_only_hilic/"), 
  sep = ""
  ) %>% 
  map(read_csv)
vf.p5.hits.list <- paste(
  "./data/hit_lists/vpa_fa_p5/", 
  list.files(path = "./data/hit_lists/vpa_fa_p5/"), 
  sep = ""
  ) %>% 
  map(read_csv)
```


# Prep

Full list of all metabolites detected/quantified across VPA expriments that were found to be associated with either Purine metabolism, Pyrimidine metabolism, or the Pentose phosphate pathway:

```{r}
all.sulf.metab <- bind_rows(
  bind_rows(
    "vpa_only" = vpa.pathways %>% 
      filter(str_detect(path_name, "Glycine, serine and threonine metabolism") | str_detect(path_name, "Cysteine and methionine metabolism") | str_detect(path_name, "Taurine and hypotaurine metabolism") | str_detect(path_name, "Glutathione metabolism")),
    "vpa_hilic" = vpa.hilic.pathways %>% 
      filter(str_detect(path_name, "Glycine, serine and threonine metabolism") | str_detect(path_name, "Cysteine and methionine metabolism") | str_detect(path_name, "Taurine and hypotaurine metabolism") | str_detect(path_name, "Glutathione metabolism")),
    .id = "experiment"
    ), 
  bind_rows(
    "vf_first" = vf.pathways %>% 
      filter(str_detect(path_name, "Glycine, serine and threonine metabolism") | str_detect(path_name, "Cysteine and methionine metabolism") | str_detect(path_name, "Taurine and hypotaurine metabolism") | str_detect(path_name, "Glutathione metabolism")),
    "vf_p5" = vf.p5.pathways %>% 
      filter(str_detect(path_name, "Glycine, serine and threonine metabolism") | str_detect(path_name, "Cysteine and methionine metabolism") | str_detect(path_name, "Taurine and hypotaurine metabolism") | str_detect(path_name, "Glutathione metabolism")),
    .id = "experiment"
    )
  )
# preview
head(all.sulf.metab)
# full number of relevant metabolites across experiments
nrow(all.sulf.metab)
# unique number of compounds across experiments 
length(unique(all.sulf.metab$compound_full_exp))
```


Convert the full lists (all pathways) of statistically significant compounds from list to df format:

```{r hits_list_to_df, comment=NA}
### vpa exp 1 ###
vpa.hits.df <- bind_rows(
  "vpa_cell.neg" = vpa.hits.list[[1]],
  "vpa_cell.pos" = vpa.hits.list[[2]],
  "vpa_med.neg" = vpa.hits.list[[3]],
  .id = "exp_source.mode"
  ) %>% 
  select(compound_short, compound_full:cas_id, exp_source.mode, change_in_vpa, vpa_div_cntrl, adj.P.Val) %>% 
  rename("adj_pval" = adj.P.Val) %>% 
  filter(compound_short %in% all.sulf.metab$compound_short)
### vpa + fa exp 1 ###
vf.hits.df <- bind_rows(
  "vf_cell.neg" = vf.hits.list[[1]],
  "vf_cell.pos" = vf.hits.list[[2]],
  "vf_med.neg" = vf.hits.list[[3]],
  .id = "exp_source.mode"
  ) %>% 
  select(compound_short, compound_full:cas_id, exp_source.mode, term, change_in_vpa, FC, adj_pval) %>% 
  rename("vpa_div_cntrl" = FC) %>% 
  filter(compound_short %in% all.sulf.metab$compound_short)
### vpa hilic ### 
vpa.hilic.hits.df <- bind_rows(
  "vpa.hilic_cell.neg" = vpa.hilic.hits.list[[1]],
  "vpa.hilic_cell.pos" = vpa.hilic.hits.list[[2]],
  .id = "exp_source.mode"
  ) %>% 
  select(compound_short, compound_full:cas_id, exp_source.mode, change_in_vpa, vpa_div_cntrl, adj.P.Val) %>% 
  rename("adj_pval" = adj.P.Val) %>% 
  filter(compound_short %in% all.sulf.metab$compound_short)
### vpa + fa p5 ###
vf.p5.hits.df <- bind_rows(
  "vf.p5_cell.neg" = vf.p5.hits.list[[1]],
  "vf.p5_cell.pos" = vf.p5.hits.list[[2]],
  "vf.p5_med.neg" = vf.p5.hits.list[[3]],
  .id = "exp_source.mode"
  ) %>% 
  select(compound_short, compound_full:cas_id, exp_source.mode, term, change_in_vpa, FC, adj_pval) %>% 
  rename("vpa_div_cntrl" = FC)  %>% 
  filter(compound_short %in% all.sulf.metab$compound_short) %>% 
  distinct()
```


Need to convert the log2 abundance residuals (after regression onto covariates, or the intercept for a few) from list format to df, without losing info about exp/etc:

```{r abun_resid_list_to_df, warning=FALSE, comment=NA}
### vpa only ###
vpa.sulf.abun.df <- vpa.abun.list %>% 
  # pick only relevant sample info and compound abun columns (nucleotide metab)
  map(select, Samples, Treatment, one_of(all.sulf.metab$compound_short)) %>% 
  # convert from wide to long format for easy list -> df conversion
  map(gather, key = "compound_short", value = "log2_resid_abun", -c(Samples:Treatment)) %>% 
  # combine with experiment, pathway, etc 
  map(inner_join, all.sulf.metab, by = "compound_short") %>% 
  # list -> df
  bind_rows() %>%
  # rearrange the columns
  select(experiment, mode, Samples:compound_short, compound_full_exp, everything())
### vpa + fa exp 1 ###
vf.sulf.abun.df <- vf.abun.list %>%  
  map(select, Samples:FA, one_of(all.sulf.metab$compound_short)) %>% 
  map(gather, key = "compound_short", value = "log2_resid_abun", -c(Samples:FA)) %>% 
  map(inner_join, all.sulf.metab, by = "compound_short") %>% 
  bind_rows() %>% 
  mutate(FA = ifelse(FA == "cntrl", "1Xfa", "5Xfa")) %>% 
  unite("Treatment", VPA:FA, sep = "_") %>% 
  select(experiment, mode, Samples:compound_short, compound_full_exp, everything())
### vpa hilic ###
vpa.hilic.sulf.abun.df <- vpa.hilic.abun.list %>% 
  map(select, Samples, Group, one_of(all.sulf.metab$compound_short)) %>% 
  map(gather, key = "compound_short", value = "log2_resid_abun", -c(Samples:Group)) %>% 
  map(inner_join, all.sulf.metab, by = "compound_short") %>% 
  bind_rows() %>%
  rename("Treatment" = Group) %>% 
  select(experiment, mode, Samples:compound_short, compound_full_exp, everything())
### vpa + fa p5 hilic ###
vf.p5.sulf.abun.df <- vf.p5.abun.list %>%  
  map(select, Samples:FA, one_of(all.sulf.metab$compound_short)) %>% 
  map(gather, key = "compound_short", value = "log2_resid_abun", -c(Samples:FA)) %>% 
  map(inner_join, all.sulf.metab, by = "compound_short") %>% 
  bind_rows() %>% 
  mutate(FA = ifelse(FA == "base", "1Xfa", "5Xfa")) %>% 
  unite("Treatment", VPA:FA, sep = "_") %>% 
  select(experiment, mode, Samples:compound_short, compound_full_exp, everything())
```

The abundance df created in the above chunk include all compound related to nucleotide metabolism that had passed the filters, but not all of them were found to be statistically significant in the end. To mark the difference, a new column is needed:

```{r sig_column_create, comment=NA}
### vpa only ###
vpa.sulf.abun.df <- vpa.sulf.abun.df %>% 
  mutate(significant = ifelse(compound_short %in% vpa.hits.df$compound_short, TRUE, FALSE)) 
# check how many TRUE in df
vpa.sulf.abun.df %>% 
  select(compound_short, significant) %>% 
  distinct() %>% 
  {table(.$significant)}
# vs how many nucleotide metab hits there should be
nrow(vpa.hits.df)

### vpa + fa exp 1 ###
vf.sulf.abun.df <- vf.sulf.abun.df %>% 
  mutate(significant = ifelse(compound_short %in% vf.hits.df$compound_short, TRUE, FALSE))
vf.sulf.abun.df %>% 
  select(compound_short, significant) %>% 
  distinct() %>% 
  {table(.$significant)}
nrow(vf.hits.df)
length(unique(vf.hits.df$compound_short))
# difference because some compounds are sig for both low and high FA background, which were treated separatly

### vpa hilic ###
vpa.hilic.sulf.abun.df <- vpa.hilic.sulf.abun.df %>% 
  mutate(significant = ifelse(compound_short %in% vpa.hilic.hits.df$compound_short, TRUE, FALSE))
vpa.hilic.sulf.abun.df %>% 
  select(compound_short, significant) %>% 
  distinct() %>% 
  {table(.$significant)}
nrow(vpa.hilic.hits.df)

### vpa + fa p5 hilic ###
vf.p5.sulf.abun.df <- vf.p5.sulf.abun.df %>% 
  mutate(significant = ifelse(compound_short %in% vf.p5.hits.df$compound_short, TRUE, FALSE))
vf.p5.sulf.abun.df %>% 
  select(compound_short, significant) %>% 
  distinct() %>% 
  {table(.$significant)}
nrow(vf.p5.hits.df)
length(unique(vf.p5.hits.df$compound_short))
```


# Visualization

## GSH / GSSG ratios


```{r}
vpa.gsh.to.gssg.plot <- vpa.sulf.abun.df %>% 
  filter(compound_full_exp == "Glutathione" | compound_full_exp == "GSSG") %>% 
  select(-path_name) %>% 
  distinct() %>%
  select(-c(compound_short, cas_id:significant)) %>% 
  spread(compound_full_exp, log2_resid_abun) %>% 
  mutate(
    ratio_glut_gssg = 2 ^ (Glutathione - GSSG),
    mode = case_when(
      mode == "cell.neg" ~ "Cell / Neg Mode",
      mode == "cell.pos" ~ "Cell / Pos Mode",
      TRUE ~ "Don't know"
      ),
    Treatment = case_when(
      Treatment == "cntrl" ~ "Control",
      Treatment == "vpa" ~ "VPA",
      TRUE ~ "Don't know")
    ) %>% 
  ggplot(aes(Treatment, ratio_glut_gssg, color = Treatment, fill = Treatment)) +
  geom_boxplot(alpha = 0.3) +
  geom_point(size = 2, position = position_dodge(0.75)) +
  scale_color_manual(values = c("#56B4E9", "#E69F00"), guide = FALSE) +
  scale_fill_manual(values = c("#56B4E9", "#E69F00"), guide = FALSE) +
  facet_wrap(~ mode) +
  ylab("GSH / GSSG") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  ylim(c(0.4, 2.2))
vpa.gsh.to.gssg.plot
vf.gsh.to.gssg.plot <- vf.sulf.abun.df %>% 
  filter(compound_full_exp == "Glutathione" | compound_full_exp == "GSSG") %>% 
  select(-path_name) %>% 
  distinct() %>% 
  select(-c(compound_short, cas_id:significant)) %>% 
  spread(compound_full_exp, log2_resid_abun) %>% 
  mutate(
    ratio_glut_gssg = 2 ^ (Glutathione - GSSG),
    mode = case_when(
      mode == "cell.neg" ~ "Cell / Neg Mode",
      mode == "cell.pos" ~ "Cell / Pos Mode",
      TRUE ~ "Don't know"
      ),
    Treatment = case_when(
      Treatment == "cntrl_1Xfa" ~ "Control",
      Treatment == "cntrl_5Xfa" ~ "5X FA",
      Treatment == "vpa_1Xfa" ~ "VPA",
      Treatment == "vpa_5Xfa" ~ "VPA + 5X FA",
      TRUE ~ "Don't know"
      )
    ) %>% 
  ggplot(aes(Treatment, ratio_glut_gssg, color = Treatment, fill = Treatment)) +
  geom_boxplot(alpha = 0.3) +
  geom_point(size = 2, position = position_dodge(0.75)) +
  scale_color_manual(
    values = c("#0072B2", "#56B4E9", "#E69F00",  "#D55E00"),
    guide = FALSE,
    breaks = c("Control", "5X FA",  "VPA", "VPA + 5X FA")
    ) +
  scale_fill_manual(values = c("#0072B2", "#56B4E9", "#E69F00",  "#D55E00"), guide = FALSE) +
  facet_wrap(~ mode) +
  ylab("GSH / GSSG") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_x_discrete(limits = c("Control", "5X FA", "VPA", "VPA + 5X FA")) +
  ylim(c(0.4, 2.2))
vf.gsh.to.gssg.plot 
vpa.hilic.gsh.to.gssg.plot <- vpa.hilic.sulf.abun.df %>% 
  filter(compound_full_exp == "Glutathione (GSH)" | compound_full_exp == "GSSG") %>% 
  select(-path_name) %>% 
  distinct() %>%
  select(-c(compound_short, cas_id:significant)) %>% 
  spread(compound_full_exp, log2_resid_abun) %>% 
  rename(Glutathione = `Glutathione (GSH)`) %>% 
  mutate(
    ratio_glut_gssg = 2 ^ (Glutathione - GSSG),
    mode = case_when(
      mode == "cell.neg" ~ "Cell / Neg Mode",
      mode == "cell.pos" ~ "Cell / Pos Mode",
      TRUE ~ "Don't know"
      ),
    Treatment = case_when(
      Treatment == "cntrl" ~ "Control",
      Treatment == "vpa" ~ "VPA",
      TRUE ~ "Don't know")
    ) %>% 
  ggplot(aes(Treatment, ratio_glut_gssg, color = Treatment, fill = Treatment)) +
  geom_boxplot(alpha = 0.3) +
  geom_point(size = 2, position = position_dodge(0.75)) +
  scale_color_manual(values = c("#56B4E9", "#E69F00"), guide = FALSE) +
  scale_fill_manual(values = c("#56B4E9", "#E69F00"), guide = FALSE) +
  facet_wrap(~ mode) +
  ylab("GSH / GSSG") +
  theme(axis.text.x = element_text(angle = 60, hjust = 1)) +
  ylim(c(0.4, 2.2))
vpa.hilic.gsh.to.gssg.plot
vf.p5.gsh.to.gssg.plot <- vf.p5.sulf.abun.df %>% 
  filter(compound_full_exp == "Glutathione (GSH)" | compound_full_exp == "GSSG") %>% 
  select(-path_name) %>% 
  distinct() %>% 
  select(-c(compound_short, cas_id:significant)) %>% 
  spread(compound_full_exp, log2_resid_abun) %>% 
  rename(Glutathione = `Glutathione (GSH)`) %>%
  mutate(
    ratio_glut_gssg = 2 ^ (Glutathione - GSSG),
    mode = case_when(
      mode == "cell.neg" ~ "Cell / Neg Mode",
      mode == "cell.pos" ~ "Cell / Pos Mode",
      TRUE ~ "Don't know"
      ),
    Treatment = case_when(
      Treatment == "cntrl_1Xfa" ~ "Control",
      Treatment == "cntrl_5Xfa" ~ "5X FA",
      Treatment == "vpa_1Xfa" ~ "VPA",
      Treatment == "vpa_5Xfa" ~ "VPA + 5X FA",
      TRUE ~ "Don't know"
      )
    ) %>% 
  ggplot(aes(Treatment, ratio_glut_gssg, color = Treatment, fill = Treatment)) +
  geom_boxplot(alpha = 0.3) +
  geom_point(size = 2, position = position_dodge(0.75)) +
   scale_color_manual(
    values = c("#0072B2", "#56B4E9", "#E69F00",  "#D55E00"),
    guide = FALSE,
    breaks = c("Control", "5X FA",  "VPA", "VPA + 5X FA")
    ) +
  scale_fill_manual(values = c("#0072B2", "#56B4E9", "#E69F00",  "#D55E00"), guide = FALSE) +
  facet_wrap(~ mode) +
  ylab("GSH / GSSG") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_x_discrete(limits = c("Control", "5X FA", "VPA", "VPA + 5X FA")) +
  ylim(c(0.4, 2.2))
vf.p5.gsh.to.gssg.plot
gsh.to.gssg.grid <- plot_grid(
  vpa.gsh.to.gssg.plot, vpa.hilic.gsh.to.gssg.plot,
  vf.gsh.to.gssg.plot, vf.p5.gsh.to.gssg.plot,
  rel_heights = c(1, 1.5), labels = c("A", "B", "C", "D")
  )
#save_plot("./results/gsh_to_gssg_ratio_plots.png", gsh.to.gssg.grid, base_height = 6, base_width = 8)
gsh.to.gssg.grid.alt <- plot_grid(
  vpa.gsh.to.gssg.plot, vf.gsh.to.gssg.plot,
  vpa.hilic.gsh.to.gssg.plot, vf.p5.gsh.to.gssg.plot,
  rel_widths = c(1, 1.3), labels = c("A", "B", "C", "D")
  )
#save_plot("./results/gsh_to_gssg_ratio_plots_alt2.png", gsh.to.gssg.grid.alt, base_height = 7, base_width = 8)
```


## Glutathione related metabolites test:


```{r raw_resid_plots, comment=NA, fig.height=8, fig.width = 6}
# raw residuals
vpa.sulf.abun.df %>% 
  mutate(alt_cmpnd_name = paste(compound_full_exp, " (", mode, ")", sep = "")) %>% 
  filter(str_detect(alt_cmpnd_name, "Glutathione") | str_detect(alt_cmpnd_name, "GSSG") | str_detect(alt_cmpnd_name, "Cystathionine") | str_detect(alt_cmpnd_name, "Taurine") | str_detect(alt_cmpnd_name, "Hypotaurine") | str_detect(alt_cmpnd_name, "3-Sulfino")) %>% 
  filter(mode == "cell.neg" | mode == "cell.pos") %>% 
  ggplot(aes(alt_cmpnd_name, log2_resid_abun, color = Treatment, fill = Treatment)) +
  geom_boxplot(alpha = 0.3) +
  geom_point(size = 2, position = position_dodge(0.75)) +
  scale_color_manual(values = c("#56B4E9", "#E69F00"), labels = c("Control", "VPA")) +
  scale_fill_manual(values = c("#56B4E9", "#E69F00"), guide = FALSE) +
  theme(
    axis.text.x = element_text(angle = 60, hjust = 1, vjust = 1),
    legend.justification = "top"
    ) +
  xlab("Compound Name") +
  ylab("log2(Compound Residuals)") +
  facet_wrap(~ significant, scales = "free_x")
vf.sulf.abun.df %>% 
  mutate(alt_cmpnd_name = paste(compound_full_exp, " (", mode, ")", sep = "")) %>% 
  filter(str_detect(alt_cmpnd_name, "Glutathione") | str_detect(alt_cmpnd_name, "GSSG") | str_detect(alt_cmpnd_name, "Cystathionine") | str_detect(alt_cmpnd_name, "Taurine") | str_detect(alt_cmpnd_name, "Hypotaurine") | str_detect(alt_cmpnd_name, "3-Sulfi")) %>% 
  filter(mode == "cell.neg" | mode == "cell.pos") %>%  
  ggplot(aes(alt_cmpnd_name, log2_resid_abun, color = Treatment, fill = Treatment)) +
  geom_boxplot(alpha = 0.3) +
  geom_point(size = 2, position = position_dodge(0.75)) +
  scale_color_manual(
    values = c("#56B4E9", "#0072B2", "#E69F00",  "#D55E00"),
    labels = c("Control", "5X FA",  "VPA", "VPA + 5X FA") #,
   # breaks = c("Control", "5X FA",  "VPA", "VPA + 5X FA")
    ) +
  scale_fill_manual(values = c("#56B4E9", "#0072B2", "#E69F00",  "#D55E00"), guide = FALSE) +
  theme(
    axis.text.x = element_text(angle = 60, hjust = 1, vjust = 1),
    legend.justification = "top"
    ) +
  xlab("Compound Name") +
  ylab("log2(Compound Residuals)") +
  facet_wrap(~ significant, scales = "free_x")
```


## Plot prep

```{r plot_prep, comment = NA}
### VPA-only ###
vpa.GSH.cmpnd.sel <- vpa.sulf.abun.df %>% 
  mutate(alt_cmpnd_name = paste(compound_full_exp, " (", mode, ")", sep = "")) %>% 
  filter(compound_full_exp %in% c("Glutathione", "GSSG", "Cystathionine", "Taurine", "Hypotaurine", "3-Sulfinoalanine") & (mode == "cell.neg" | mode == "cell.pos")) %>% 
  select(-c(cas_id:path_name)) %>% 
  distinct()
vpa.GSH.FCsum <- vpa.GSH.cmpnd.sel %>% 
  group_by(compound_full_exp, Treatment, mode) %>% 
  summarize(avg_abun = mean(log2_resid_abun)) %>% 
  ungroup() %>% 
  spread(Treatment, avg_abun) %>% 
  mutate(FC = vpa - cntrl) %>% 
  group_by(compound_full_exp) %>% 
  summarize(avg_FC = mean(FC))
vpa.GSH.cmpnd.prep <- vpa.GSH.cmpnd.sel %>% 
  group_by(alt_cmpnd_name) %>% 
  mutate(scaled_resid = scale(log2_resid_abun)) %>% 
  ungroup() %>% 
  inner_join(vpa.GSH.FCsum, by = "compound_full_exp") %>% 
  arrange(desc(avg_FC), alt_cmpnd_name) %>%
  mutate(
    alt_cmpnd_name = case_when(
      significant ~ paste0(alt_cmpnd_name, "*"),
      !significant ~ alt_cmpnd_name),
    plot_order = factor(alt_cmpnd_name, levels = unique(alt_cmpnd_name)),
    )
### VPA + FA ###
vf.GSH.cmpnd.sel <- vf.sulf.abun.df %>% 
  mutate(alt_cmpnd_name = paste(compound_full_exp, " (", mode, ")", sep = "")) %>% 
  filter(compound_full_exp %in% c("Glutathione", "GSSG", "Cystathionine", "Taurine", "Hypotaurine", "3-Sulfinoalanine") & (mode == "cell.neg" | mode == "cell.pos")) %>% 
  select(-c(cas_id:path_name)) %>% 
  distinct()
vf.GSH.FCsum <- vf.GSH.cmpnd.sel %>% 
  group_by(compound_full_exp, Treatment, mode) %>% 
  summarize(avg_abun = mean(log2_resid_abun)) %>% 
  ungroup() %>% 
  separate(Treatment, into = c("Treatment", "FA"), sep = "_") %>% 
  spread(Treatment, avg_abun) %>% 
  mutate(FC = vpa - cntrl) %>% 
  group_by(compound_full_exp) %>% 
  summarize(avg_FC = mean(FC))
vf.GSH.cmpnd.prep <- vf.GSH.cmpnd.sel %>% 
  group_by(alt_cmpnd_name) %>% 
  mutate(scaled_resid = scale(log2_resid_abun)) %>% 
  ungroup() %>% 
  inner_join(vf.GSH.FCsum, by = "compound_full_exp") %>% 
  arrange(desc(avg_FC), alt_cmpnd_name) %>%
  mutate(
    alt_cmpnd_name = case_when(
      significant ~ paste0(alt_cmpnd_name, "*"),
      !significant ~ alt_cmpnd_name),
    plot_order = factor(alt_cmpnd_name, levels = unique(alt_cmpnd_name)),
    )
### VPA HILIC ###
vpa.hilic.GSH.cmpnd.sel <- vpa.hilic.sulf.abun.df %>% 
  mutate(
    compound_full_exp = ifelse(compound_full_exp == "Glutathione (GSH)", "Glutathione", compound_full_exp),
    alt_cmpnd_name = paste(compound_full_exp, " (", mode, ")", sep = "")
    ) %>% 
  filter(compound_full_exp %in% c("Glutathione", "GSSG", "Cystathionine", "Taurine", "Hypotaurine", "3-Sulfinoalanine") & (mode == "cell.neg" | mode == "cell.pos")) %>% 
  select(-c(cas_id:path_name)) %>% 
  distinct()
vpa.hilic.GSH.FCsum <- vpa.hilic.GSH.cmpnd.sel %>% 
  group_by(compound_full_exp, Treatment, mode) %>% 
  summarize(avg_abun = mean(log2_resid_abun)) %>% 
  ungroup() %>% 
  spread(Treatment, avg_abun) %>% 
  mutate(FC = vpa - cntrl) %>% 
  group_by(compound_full_exp) %>% 
  summarize(avg_FC = mean(FC))
vpa.hilic.GSH.cmpnd.prep <- vpa.hilic.GSH.cmpnd.sel %>% 
  group_by(alt_cmpnd_name) %>% 
  mutate(scaled_resid = scale(log2_resid_abun)) %>% 
  ungroup() %>% 
  inner_join(vpa.hilic.GSH.FCsum, by = "compound_full_exp") %>% 
  arrange(desc(avg_FC), alt_cmpnd_name) %>%
  mutate(
    alt_cmpnd_name = case_when(
      significant ~ paste0(alt_cmpnd_name, "*"),
      !significant ~ alt_cmpnd_name),
    plot_order = factor(alt_cmpnd_name, levels = unique(alt_cmpnd_name)),
    )
### VPA + FA p5 ###
vf.p5.GSH.cmpnd.sel <- vf.p5.sulf.abun.df %>% 
  mutate(
    compound_full_exp = ifelse(compound_full_exp == "Glutathione (GSH)", "Glutathione", compound_full_exp),
    alt_cmpnd_name = paste(compound_full_exp, " (", mode, ")", sep = "")
    ) %>% 
  filter(compound_full_exp %in% c("Glutathione", "GSSG", "Cystathionine", "Taurine", "Hypotaurine", "3-Sulfinoalanine") & (mode == "cell.neg" | mode == "cell.pos")) %>% 
  select(-c(cas_id:path_name)) %>% 
  distinct()
vf.p5.GSH.FCsum <- vf.p5.GSH.cmpnd.sel %>% 
  group_by(compound_full_exp, Treatment, mode) %>% 
  summarize(avg_abun = mean(log2_resid_abun)) %>% 
  ungroup() %>% 
  separate(Treatment, into = c("Treatment", "FA"), sep = "_") %>% 
  spread(Treatment, avg_abun) %>% 
  mutate(FC = vpa - cntrl) %>% 
  group_by(compound_full_exp) %>% 
  summarize(avg_FC = mean(FC))
vf.p5.GSH.cmpnd.prep <- vf.p5.GSH.cmpnd.sel %>% 
  group_by(alt_cmpnd_name) %>% 
  mutate(scaled_resid = scale(log2_resid_abun)) %>% 
  ungroup() %>% 
  inner_join(vf.p5.GSH.FCsum, by = "compound_full_exp") %>% 
  arrange(desc(avg_FC), alt_cmpnd_name) %>%
  mutate(
    alt_cmpnd_name = case_when(
      significant ~ paste0(alt_cmpnd_name, "*"),
      !significant ~ alt_cmpnd_name),
    plot_order = factor(alt_cmpnd_name, levels = unique(alt_cmpnd_name)),
    )
```



```{r glutathione_metab_plot_final, comment=NA}
### VPA-only ###
vpa.GSH.plot <- vpa.GSH.cmpnd.prep %>% 
  ggplot(aes(plot_order, scaled_resid, color = Treatment, fill = Treatment)) +
  geom_hline(yintercept = 0, color = "gray50", size = 1) +
  geom_boxplot(alpha = 0.3) +
  geom_point(size = 1.5, position = position_dodge(0.75)) +
  scale_color_manual(values = c("#56B4E9", "#E69F00"), labels = c("Control", "VPA")) +
  scale_fill_manual(values = c("#56B4E9", "#E69F00"), guide = FALSE) +
  theme(
    legend.justification = "top",
    panel.grid.major.x = element_line(color = "black", linetype = "dashed"),
    panel.grid.major.y = element_blank(),
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)
    ) +
  ylab("Scaled Residuals") +
  xlab("Compound") +
  theme(plot.margin = margin(5, 5, 5, 40))
vpa.GSH.plot
### VPA + FA ###
vf.GSH.plot <- vf.GSH.cmpnd.prep %>% 
  filter(scaled_resid < 3) %>% 
  ggplot(aes(plot_order, scaled_resid, color = Treatment, fill = Treatment)) +
  geom_hline(yintercept = 0, color = "gray50", size = 1) +
  geom_boxplot(alpha = 0.3) +
  geom_point(size = 1.5, position = position_dodge(0.75)) +
  scale_color_manual(
    values = c("#56B4E9", "#0072B2", "#E69F00", "#D55E00"),
    labels = c("Control", "5X FA",  "VPA", "VPA + 5X FA")
    ) +
  scale_fill_manual(values = c("#56B4E9", "#0072B2", "#E69F00",  "#D55E00"), guide = FALSE) +
  theme(
    legend.justification = "top",
    panel.grid.major.x = element_line(color = "black", linetype = "dashed"),
    panel.grid.major.y = element_blank(),
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 10)
    ) +
  ylab("Scaled Residuals") +
  xlab("Compound") +
  theme(plot.margin = margin(5, 5, 5, 30))
vf.GSH.plot
### VPA HILIC ###
vpa.hilic.GSH.plot <- vpa.hilic.GSH.cmpnd.prep %>% 
  ggplot(aes(plot_order, scaled_resid, color = Treatment, fill = Treatment)) +
  geom_hline(yintercept = 0, color = "gray50", size = 1) +
  geom_boxplot(alpha = 0.3) +
  geom_point(size = 1.5, position = position_dodge(0.75)) +
  scale_color_manual(values = c("#56B4E9", "#E69F00"), labels = c("Control", "VPA")) +
  scale_fill_manual(values = c("#56B4E9", "#E69F00"), guide = FALSE) +
  theme(
    legend.justification = "top",
    panel.grid.major.x = element_line(color = "black", linetype = "dashed"),
    panel.grid.major.y = element_blank(),
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)
    ) +
  ylab("Scaled Residuals") +
  xlab("Compound") +
  theme(plot.margin = margin(5, 5, 5, 40))
vpa.hilic.GSH.plot
### VPA + FA p5 ###
vf.p5.GSH.plot <- vf.p5.GSH.cmpnd.prep %>% 
  filter(scaled_resid < 3) %>% 
  ggplot(aes(plot_order, scaled_resid, color = Treatment, fill = Treatment)) +
  geom_hline(yintercept = 0, color = "gray50", size = 1) +
  geom_boxplot(alpha = 0.3) +
  geom_point(size = 1.5, position = position_dodge(0.75)) +
  scale_color_manual(
    values = c("#56B4E9", "#0072B2", "#E69F00", "#D55E00"),
    labels = c("Control", "5X FA",  "VPA", "VPA + 5X FA")
    ) +
  scale_fill_manual(values = c("#56B4E9", "#0072B2", "#E69F00",  "#D55E00"), guide = FALSE) +
  theme(
    legend.justification = "top",
    panel.grid.major.x = element_line(color = "black", linetype = "dashed"),
    panel.grid.major.y = element_blank(),
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 10)
    ) +
  ylab("Scaled Residuals") +
  xlab("Compound") +
  theme(plot.margin = margin(5, 5, 5, 30))
vf.p5.GSH.plot
vpa.vf.GSH.plot.grid <- plot_grid(vpa.GSH.plot, vf.GSH.plot, vpa.hilic.GSH.plot, vf.p5.GSH.plot, ncol = 2, labels = c("A", "B", "C", "D"), rel_widths = c(1, 1.25))
#save_plot(filename = "./results/vpa_vf_GSH_metab_plot.png", vpa.vf.GSH.plot.grid, base_height = 8, base_width = 10)
vpa.only.GSH.grid <- plot_grid(vpa.GSH.plot, vpa.hilic.GSH.plot, ncol = 1, labels = c("A", "B"))
#save_plot(filename = "./results/vpa_only_GSH_metab_plot.png", vpa.only.GSH.grid, base_height = 8, base_width = 6)
vf.only.GSH.plot.grid <- plot_grid(vf.GSH.plot, vf.p5.GSH.plot, ncol = 1, labels = c("A", "B"))
#save_plot(filename = "./results/vf_only_GSH_metab_plot.png", vf.only.GSH.plot.grid, base_height = 10, base_width = 8)
```


## SAM / SAH ratios


```{r sam_to_sah_plot, comment=NA}
### VPA only ###
vpa.sam.to.sah.prep <- vpa.sulf.abun.df %>% 
  filter((compound_full_exp == "SAM" | compound_full_exp == "SAH") & mode == "cell.pos") %>% 
  select(-path_name) %>% 
  distinct() %>%
  select(-c(compound_short, cas_id:significant)) %>% 
  spread(compound_full_exp, log2_resid_abun) %>% 
  mutate(
    ratio_sam_sah = 2 ^ (SAM - SAH),
    Treatment = case_when(
      Treatment == "cntrl" ~ "Control",
      Treatment == "vpa" ~ "VPA",
      TRUE ~ "Don't know")
    )
vpa.sam.to.sah.plot <- vpa.sam.to.sah.prep %>% 
  # one ratio close to 4
  filter(ratio_sam_sah < 2) %>% 
  ggplot(aes(Treatment, ratio_sam_sah, color = Treatment, fill = Treatment)) +
  geom_boxplot(alpha = 0.3) +
  geom_point(size = 2, position = position_dodge(0.75)) +
  scale_color_manual(values = c("#56B4E9", "#E69F00"), guide = FALSE) +
  scale_fill_manual(values = c("#56B4E9", "#E69F00"), guide = FALSE) +
  ylab("SAM / SAH") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  ylim(c(0.5, 1.8))
vpa.sam.to.sah.plot
### VPA + FA ###
vf.sam.to.sah.prep <- vf.sulf.abun.df %>% 
  filter((compound_full_exp == "SAM" | compound_full_exp == "SAH") & mode == "cell.pos") %>% 
  select(-path_name) %>% 
  distinct() %>% 
  select(-c(compound_short, cas_id:significant)) %>% 
  spread(compound_full_exp, log2_resid_abun) %>% 
  mutate(
    ratio_sam_sah = 2 ^ (SAM - SAH),
    Treatment = case_when(
      Treatment == "cntrl_1Xfa" ~ "Control",
      Treatment == "cntrl_5Xfa" ~ "5X FA",
      Treatment == "vpa_1Xfa" ~ "VPA",
      Treatment == "vpa_5Xfa" ~ "VPA + 5X FA",
      TRUE ~ "Don't know"
      )
    )
vf.sam.to.sah.plot <- vf.sam.to.sah.prep %>% 
  ggplot(aes(Treatment, ratio_sam_sah, color = Treatment, fill = Treatment)) +
  geom_boxplot(alpha = 0.3) +
  geom_point(size = 2, position = position_dodge(0.75)) +
  scale_color_manual(
    values = c("#0072B2", "#56B4E9", "#E69F00",  "#D55E00"),
    guide = FALSE,
    breaks = c("Control", "5X FA",  "VPA", "VPA + 5X FA")
    ) +
  scale_fill_manual(values = c("#0072B2", "#56B4E9", "#E69F00",  "#D55E00"), guide = FALSE) +
  ylab("SAM / SAH") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_x_discrete(limits = c("Control", "5X FA", "VPA", "VPA + 5X FA")) +
  ylim(c(0.5, 1.8))
vf.sam.to.sah.plot
### VPA HILIC ###
vpa.hilic.sulf.abun.df %>% 
  filter(str_detect(compound_full_exp, "SAM") | str_detect(compound_full_exp,"SAH")) %>% 
  group_by(mode, compound_full_exp) %>% 
  count()
### VPA + FA p5 ###
vf.p5.sam.to.sah.prep <- vf.p5.sulf.abun.df %>% 
  filter((str_detect(compound_full_exp, "SAM") | str_detect(compound_full_exp,"SAH")) & mode == "cell.pos") %>%
  mutate(
    compound_full_exp = case_when(
      str_detect(compound_full_exp, "SAM") ~ "SAM",
      str_detect(compound_full_exp, "SAH") ~ "SAH",
      TRUE ~ "Don't know"
      )
    ) %>% 
  select(-path_name) %>% 
  distinct() %>% 
  select(-c(compound_short, cas_id:significant)) %>% 
  spread(compound_full_exp, log2_resid_abun) %>% 
  mutate(
    ratio_sam_sah = 2 ^ (SAM - SAH),
    Treatment = case_when(
      Treatment == "cntrl_1Xfa" ~ "Control",
      Treatment == "cntrl_5Xfa" ~ "5X FA",
      Treatment == "vpa_1Xfa" ~ "VPA",
      Treatment == "vpa_5Xfa" ~ "VPA + 5X FA",
      TRUE ~ "Don't know"
      )
    ) 
vf.p5.sam.to.sah.plot <- vf.p5.sam.to.sah.prep %>% 
  ggplot(aes(Treatment, ratio_sam_sah, color = Treatment, fill = Treatment)) +
  geom_boxplot(alpha = 0.3) +
  geom_point(size = 2, position = position_dodge(0.75)) +
   scale_color_manual(
    values = c("#0072B2", "#56B4E9", "#E69F00",  "#D55E00"),
    guide = FALSE,
    breaks = c("Control", "5X FA",  "VPA", "VPA + 5X FA")
    ) +
  scale_fill_manual(values = c("#0072B2", "#56B4E9", "#E69F00",  "#D55E00"), guide = FALSE) +
  ylab("SAM / SAH") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_x_discrete(limits = c("Control", "5X FA", "VPA", "VPA + 5X FA")) +
  ylim(c(0.5, 1.8))
vf.p5.sam.to.sah.plot

sam.to.sah.grid <- plot_grid(
  vpa.sam.to.sah.plot, vf.sam.to.sah.plot,
  vf.p5.sam.to.sah.plot,
  ncol = 3, labels = c("A", "B", "C"),
  rel_widths = c(1, 1.25, 1.25)
  )
sam.to.sah.grid
#save_plot("./results/sam_to_sah_ratio_plots.png", sam.to.sah.grid, base_height = 3, base_width = 8)
```

# Session Info

```{r session_info, comment=NA}
sessionInfo()
```

