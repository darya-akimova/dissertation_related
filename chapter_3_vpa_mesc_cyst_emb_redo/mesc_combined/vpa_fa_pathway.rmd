---
title: "vpa_exp_pathway"
author: "Darya Akimova"
date: "12/10/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Setup

## Packages

```{r packages, comment=NA}
library(tidyverse)
library(GGally)
```


# Data

```{r data, comment=NA}
vf.cmpnd.info.raw <- paste(
  "./data/compound_info/vpa_fa_exp1/", 
  list.files(path = "./data/compound_info/vpa_fa_exp1/"), 
  sep = ""
  ) %>% 
  map(read_csv)
vf.hits.raw <- paste(
  "./data/hit_lists/vpa_fa_exp1/", 
  list.files(path = "./data/hit_lists/vpa_fa_exp1/"), 
  sep = ""
  ) %>% 
  map(read_csv)
# compound info
cmpnd.id <- read_csv("./data/other/anp_db_compound_kegg_fixed.csv")
kegg.info <- read_csv("./data/other/kegg_pathways_updated.csv")
filtered.pathways <- read_csv("./data/other/filtered_list_of_pathways.csv")
```


# Cleanup

```{r comment=NA}
vf.cmpnd.info.prep <- vf.cmpnd.info.raw %>% 
  bind_rows() %>% 
  mutate(
    mode = ifelse(
      str_detect(compound_short, "VPA_FAnC"), "cell.neg", 
      ifelse(
        str_detect(compound_short, "VPA_FApC"), "cell.pos", 
        ifelse(
          str_detect(compound_short, "VPA_FAnM"), "med.neg", "med.pos"
          )
        )
      )
    ) 
table(vf.cmpnd.info.prep$mode)
vf.hits.prep <- vf.hits.raw %>% 
  bind_rows() %>%
  mutate(
    mode = ifelse(
      str_detect(compound_short, "VPA_FAnC"), "cell.neg", 
      ifelse(
        str_detect(compound_short, "VPA_FApC"), "cell.pos", 
        ifelse(
          str_detect(compound_short, "VPA_FAnM"), "med.neg", "med.pos"
      )
    )
    ))
table(vf.hits.prep$mode)
colnames(kegg.info) <- c("KEGG", str_to_lower(colnames(kegg.info))[2:length(colnames(kegg.info))])
kegg.info <- kegg.info %>% 
  select(-c(reaction:brite))
kegg.info
```


# DB Merges

```{r db_merges, comment = NA}
vf.cmpnd.info.prep %>% 
  inner_join(cmpnd.id, by = "cas_id", suffix = c("_exp", "_db")) %>% 
  anti_join(kegg.info, by = "KEGG") %>% 
  {table(.$KEGG)}
vf.hits.prep %>% 
  inner_join(cmpnd.id, by = "cas_id", suffix = c("_exp", "_db")) %>% 
  anti_join(kegg.info, by = "KEGG") %>% 
  {table(.$KEGG)}
vf.full.cmpnd.join <- vf.cmpnd.info.prep %>% 
  inner_join(cmpnd.id, by = "cas_id", suffix = c("_exp", "_db")) %>% 
  left_join(kegg.info, by = "KEGG", suffix = c("_data", "_kegg"))
vf.hits.join <- vf.hits.prep %>% 
  inner_join(cmpnd.id, by = "cas_id", suffix = c("_exp", "_db")) %>% 
  left_join(kegg.info, by = "KEGG", suffix = c("_data", "_kegg"))
vf.full.cmpnd.join %>% 
  select(mass, mol_weight, exact_mass) %>% 
  ggpairs()
vf.full.cmpnd.join %>% 
  ggplot(aes(mass, exact_mass)) +
  geom_point()
vf.full.cmpnd.join %>% 
  filter(exact_mass > mass + 20)
# found the form without phosphate
colnames(vf.full.cmpnd.join)
vf.full.pathways <- vf.full.cmpnd.join %>% 
  select(compound_short, compound_full_exp, mode, cas_id, KEGG, pathway) %>% 
  separate(pathway, into = paste("pathway", 1:55, sep = "_"), sep = ";") %>% 
  gather("path_num", "path_name", -c(compound_short:KEGG)) %>% 
  filter(!(is.na(path_name))) %>% 
  select(-path_num)
vf.hits.pathways <- vf.hits.join %>% 
  select(compound_short, compound_full_exp, mode, cas_id, KEGG, pathway) %>% 
  separate(pathway, into = paste("pathway", 1:55, sep = "_"), sep = ";") %>% 
  gather("path_num", "path_name", -c(compound_short:KEGG)) %>% 
  filter(!(is.na(path_name))) %>% 
  select(-path_num)
vf.pathway.counts <- vf.full.pathways %>% 
  select(-c(compound_short, mode)) %>% 
  distinct() %>% 
  group_by(path_name) %>% 
  summarize(
    tot_compnd = n()
  ) %>% 
  full_join(
    vf.hits.pathways  %>% 
      select(-c(compound_short, mode)) %>% 
        distinct() %>% 
        group_by(path_name) %>% 
        summarize(
          tot_hits = n()
          ), 
    by = "path_name"
    ) %>% 
  arrange(desc(tot_hits)) 
vf.pathway.counts[is.na(vf.pathway.counts$tot_hits), "tot_hits"] <- 0

vf.pathway.counts %>% 
  ggplot(aes(tot_compnd, tot_hits)) +
  geom_abline(intercept = 0, slope = 1) +
  geom_point(size = 2, alpha = 0.3) +
  theme_minimal() +
  xlab("Total number of compounds detected in pathway") +
  ylab("Total number of hits in pathway")
#write_csv(vf.pathway.counts, path = "./results/vf_exp_pathway_count.csv")

vf.pathway.counts %>% 
  filter(path_name %in% filtered.pathways$Pathway) %>% 
  ggplot(aes(tot_compnd, tot_hits)) +
  geom_abline(intercept = 0, slope = 1) +
  geom_point(size = 2, alpha = 0.3) +
  theme_minimal() +
  xlab("Total number of compounds detected in pathway") +
  ylab("Total number of hits in pathway")
vf.pathway.counts %>% 
  filter(path_name %in% filtered.pathways$Pathway) %>% 
  View()
```

Select only the interesting/relevant KEGG pathways

```{r}
vf.full.pathways %>% 
  filter(path_name %in% filtered.pathways$Pathway)
vf.hits.pathways %>% 
  filter(path_name %in% filtered.pathways$Pathway) %>%
  distinct() %>% 
  View()
```

