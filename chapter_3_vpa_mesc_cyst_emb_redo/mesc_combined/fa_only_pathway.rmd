---
title: "FA Exp Pathway"
author: "Darya Akimova"
date: "12/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Setup

## Packages

```{r packages, comment=NA}
library(tidyverse)
library(GGally)
```


# Data

```{r data, comment=NA}
fa.cmpnd.info.raw <- paste(
  "./data/compound_info/fa_only_exp1/", 
  list.files(path = "./data/compound_info/fa_only_exp1"), 
  sep = ""
  ) %>% 
  map(read_csv)
fa.hits.raw <- paste(
  "./data/hit_lists/fa_only_exp1/", 
  list.files(path = "./data/hit_lists/fa_only_exp1/"), 
  sep = ""
  ) %>% 
  map(read_csv)
# compound info
cmpnd.id <- read_csv("./data/other/anp_db_compound_kegg_fixed.csv")
kegg.info <- read_csv("./data/other/kegg_pathways_updated.csv")
filtered.pathways <- read_csv("./data/other/filtered_list_of_pathways.csv")
```


# Cleanup

```{r comment=NA}
fa.cmpnd.info.prep <- fa.cmpnd.info.raw %>% 
  bind_rows() %>% 
  mutate(
    mode = ifelse(
      str_detect(compound_short, "FAnC"), "cell.neg", 
      ifelse(
        str_detect(compound_short, "FApC"), "cell.pos", 
        ifelse(
          str_detect(compound_short, "FAnM"), "med.neg", "med.pos"
          )
        )
      )
    ) 
table(fa.cmpnd.info.prep$mode)
fa.hits.prep <- fa.hits.raw %>% 
  bind_rows() %>%
  mutate(
    mode = ifelse(
      str_detect(compound_short, "FAnC"), "cell.neg", 
      ifelse(
        str_detect(compound_short, "FApC"), "cell.pos", 
        ifelse(
          str_detect(compound_short, "FAnM"), "med.neg", "med.pos"
          )
        )
      )
    )
table(fa.hits.prep$mode)
colnames(kegg.info) <- c("KEGG", str_to_lower(colnames(kegg.info))[2:length(colnames(kegg.info))])
kegg.info <- kegg.info %>% 
  select(-c(reaction:brite))
kegg.info
```


# DB Merges

```{r db_merges, comment = NA}
fa.cmpnd.info.prep %>% 
  inner_join(cmpnd.id, by = "cas_id", suffix = c("_exp", "_db")) %>% 
  anti_join(kegg.info, by = "KEGG") %>% 
  {table(.$KEGG)}
fa.hits.prep %>% 
  inner_join(cmpnd.id, by = "cas_id", suffix = c("_exp", "_db")) %>% 
  anti_join(kegg.info, by = "KEGG") %>% 
  {table(.$KEGG)}
fa.full.cmpnd.join <- fa.cmpnd.info.prep %>% 
  inner_join(cmpnd.id, by = "cas_id", suffix = c("_exp", "_db")) %>% 
  left_join(kegg.info, by = "KEGG", suffix = c("_data", "_kegg"))
fa.hits.join <- fa.hits.prep %>% 
  inner_join(cmpnd.id, by = "cas_id", suffix = c("_exp", "_db")) %>% 
  left_join(kegg.info, by = "KEGG", suffix = c("_data", "_kegg"))
fa.full.cmpnd.join %>% 
  select(mass, mol_weight, exact_mass) %>% 
  ggpairs()
fa.full.cmpnd.join %>% 
  ggplot(aes(mass, exact_mass)) +
  geom_point()
fa.full.cmpnd.join %>% 
  filter(exact_mass > mass + 20)
# found the form without phosphate
colnames(fa.full.cmpnd.join)
fa.full.pathways <- fa.full.cmpnd.join %>% 
  select(compound_short, compound_full_exp, mode, cas_id, KEGG, pathway) %>% 
  separate(pathway, into = paste("pathway", 1:55, sep = "_"), sep = ";") %>% 
  gather("path_num", "path_name", -c(compound_short:KEGG)) %>% 
  filter(!(is.na(path_name))) %>% 
  select(-path_num)
fa.hits.pathways <- fa.hits.join %>% 
  select(compound_short, compound_full_exp, mode, cas_id, KEGG, pathway) %>% 
  separate(pathway, into = paste("pathway", 1:55, sep = "_"), sep = ";") %>% 
  gather("path_num", "path_name", -c(compound_short:KEGG)) %>% 
  filter(!(is.na(path_name))) %>% 
  select(-path_num)
fa.pathway.counts <- fa.full.pathways %>% 
  select(-c(compound_short, mode)) %>% 
  distinct() %>% 
  group_by(path_name) %>% 
  summarize(
    tot_compnd = n()
  ) %>% 
  full_join(
    fa.hits.pathways  %>% 
      select(-c(compound_short, mode)) %>% 
        distinct() %>% 
        group_by(path_name) %>% 
        summarize(
          tot_hits = n()
          ), 
    by = "path_name"
    ) %>% 
  arrange(desc(tot_hits)) 
fa.pathway.counts[is.na(fa.pathway.counts$tot_hits), "tot_hits"] <- 0

fa.pathway.counts %>% 
  ggplot(aes(tot_compnd, tot_hits)) +
  geom_abline(intercept = 0, slope = 1) +
  geom_point(size = 2, alpha = 0.3) +
  theme_minimal() +
  xlab("Total number of compounds detected in pathway") +
  ylab("Total number of hits in pathway")
#write_csv(fa.pathway.counts, path = "./results/fa_exp_pathway_count.csv")

fa.pathway.counts %>% 
  filter(path_name %in% filtered.pathways$Pathway)
```

Select only the interesting/relevant KEGG pathways

```{r}
fa.full.pathways %>% 
  filter(path_name %in% filtered.pathways$Pathway)
fa.hits.pathways %>% 
  filter(path_name %in% filtered.pathways$Pathway)

fa.pathway.counts.filtered <- fa.pathway.counts %>% 
  filter(path_name %in% filtered.pathways$Pathway) %>% 
   mutate(percent_hits = tot_hits * 100 / tot_compnd)
#write_csv(fa.pathway.counts.filtered, path = "./results/fa_only_exp1/fa_exp_pathway_count_filt.csv")
fa.pathway.counts.filtered %>% 
  ggplot(aes(tot_compnd, percent_hits)) +
  geom_abline(intercept = 0, slope = 1) +
  geom_point(size = 2, alpha = 0.6)
fa.hits.pathways.filt <- fa.hits.pathways %>% 
  filter(path_name %in% filtered.pathways$Pathway) %>% 
  distinct()
#write_csv(fa.hits.pathways.filt, path = "./results/fa_only_exp1/fa_only_exp_hits_pathways.csv")
fa.full.pathways.filt <- fa.full.pathways %>% 
  filter(path_name %in% filtered.pathways$Pathway) %>% 
  distinct()
#write_csv(fa.full.pathways.filt, path = "./results/fa_only_exp1/fa_only_exp_all_cmpnd_pathways.csv")
```

