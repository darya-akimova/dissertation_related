---
title: "Lrp6 CD Exp 1"
author: "Darya Akimova"
date: "February 2019"
output: 
  html_document:
    toc: true
    toc_float:
      smooth_scroll: false
    number_sections: true

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

# Setup

## Packages

```{r packages, comment=NA, message = FALSE}
library(tidyverse)
library(cowplot)
library(GGally)
library(heatmaply)
library(sva)
library(limma)
library(biobroom)
library(ggridges)
library(ggthemes)
theme_set(theme_minimal())
```


## Data

### Metabolite Abundances

```{r abundance_import, comment=NA}
folr1.neg.raw <- read_csv("./data/hilic_target_results/prepared_abundances/folr1_hilic_target_negmode_abundance.csv") %>% 
  mutate(Diet = ifelse(
    Diet == "2ppm", "2ppm_FA",
    ifelse(Diet == "10ppm", "10ppm_FA", Diet)
    ))
folr1.pos.raw <- read_csv("./data/hilic_target_results/prepared_abundances/folr1_hilic_target_posmode_abundance.csv") %>% 
  mutate(Diet = ifelse(
    Diet == "2ppm", "2ppm_FA",
    ifelse(Diet == "10ppm", "10ppm_FA", Diet)
    ))
setequal(folr1.neg.raw$Samples, folr1.pos.raw$Samples)
```


### Compound Information

```{r compound_info_import, comment=NA}
folr1.neg.compound.info <- read_csv("./data/hilic_target_results/prepared_compound_info/folr1_normal_genotype_hilic_neg_cmpnd_info.csv")
folr1.pos.compound.info <- read_csv("./data/hilic_target_results/prepared_compound_info/folr1_normal_genotype_hilic_pos_cmpnd_info.csv")
```


## Functions

```{r functions, comment=NA}
MissingPerSamplePlot <- function(raw.data, start.string) {
  # Counts the number of missing/NA values per sample and
  # percent compounds missing out of total number of compounds per sample
  # Then passes the result into a vertical bar plot, where each 
  # bar represents a single sample and the size of the bar 
  # is the % of compounds missing
  
  counted.na <- raw.data %>%
  select(starts_with(start.string)) %>% 
  mutate(
    count.na = apply(., 1, function(x) sum(is.na(x))),
    percent.na = (count.na / ncol(raw.data %>% select(starts_with(start.string)))) * 100
    ) %>%
  dplyr::select(count.na, percent.na) %>%
  bind_cols(
    raw.data %>% 
      select(Samples, Type)
      ) %>% 
  arrange(percent.na) %>% 
  mutate(f.order = factor(Samples, levels = Samples))
counted.na %>% 
  ggplot(aes(x = f.order, y = percent.na, fill = Type)) +
  geom_bar(stat = "identity") +
  geom_hline(yintercept = 20, color = "gray", size = 1, alpha = 0.8) +
  coord_flip()+
  xlab("Samples") +
  ylab("Percent missing values in sample") +
  theme(axis.text.y = element_text(size = 6)) 
}
MissingPerCompound <- function(raw.data, start.string){
  # Function to count in how many experimental samples each compound is missing
  # Also calculates the % missing:
  # (# NA per compound across all experimental samples) * 100 / (tot num of samples)
  
  raw.data %>% 
  filter(Type == "sample") %>% 
  select(Samples, starts_with(start.string)) %>% 
  gather(key = "Compound", value = "Abundance", -Samples) %>% 
  group_by(Compound) %>% 
  summarise(
    na_count = sum(is.na(Abundance)),
    n_samples = n(),
    percent_na = (na_count * 100 / n_samples)
    ) %>% 
  filter(na_count > 0) %>% 
  arrange(desc(percent_na))
}
ReplaceNAwMinLogTransform <- function(raw.dataframe, start.prefix, type) {
  # Function to replace any NAs in each column with the minimum for that column, 
  # separately for each data.set (patient and dabase samples separately)
  #
  # Returns: returns data frame(? check on this) with only the values bound by the function args
  # 
  smpls <- raw.dataframe %>%
    filter(Type == "sample") %>% 
    dplyr::select(starts_with(start.prefix))
  smpls.min <- lapply(smpls, min, na.rm = TRUE)
  # replace the missing values in the real samples with the minimum of the samples
  # then take the log
  smpls.noNA <- raw.dataframe  %>%
    filter(Type == "sample") %>% 
    dplyr::select(Samples:Prot_quant) %>%
    bind_cols(
      smpls %>%
        replace_na(replace = smpls.min) %>% 
        log2()
      ) 
  # replace missing mix values with values within the mix groups
  mix <- raw.dataframe %>%
    filter(Type == "mix") %>% 
    dplyr::select(starts_with(start.prefix))
  mix.min <- lapply(mix, min, na.rm = TRUE)
  # deal with cases where there is no min:
  mix.min <- lapply(mix.min, function(x) ifelse(is.infinite(x),2,x))
  mix.noNA <- raw.dataframe  %>%
    filter(Type == "mix") %>% 
    dplyr::select(Samples:Prot_quant) %>%
    bind_cols(
      mix %>%
        replace_na(replace = mix.min) %>% 
        log2()
      )
  # replace the missing values in solv and empty samples with 1 - for PCA analysis
  # then take the log
  other.min <- setNames(
    as.list(
      rep(2, ncol(
        raw.dataframe %>% 
          dplyr::select(starts_with(start.prefix))))
      ),
    colnames(raw.dataframe %>% dplyr::select(starts_with(start.prefix)))
                )
  other.num.log <- raw.dataframe %>%
    filter(Type == "solv") %>% 
    dplyr::select(Samples:Prot_quant) %>%
    bind_cols(
      raw.dataframe %>% 
        filter(Type == "solv") %>% 
        dplyr::select(starts_with(start.prefix)) %>%
        replace_na(replace = other.min) %>% 
        log2()
      )
  # combine them together back into one data frame
  all.noNA <- smpls.noNA %>% 
    bind_rows(mix.noNA) %>% 
    bind_rows(other.num.log)
}
HeatmapPrepAlt <- function(raw.data, start.prefix){
  # function for preparing dara for heatmap viz
  x <- raw.data %>% 
    select(starts_with(start.prefix)) %>% 
    scale(center = TRUE, scale = TRUE) %>% 
    as.matrix() 
  row.names(x) <- raw.data$Samples
  return(x)
}
```


# Data Exploration

## Mass vs Retention Time

Q: What are the distributions of compound masses and retention times?

```{r mass_v_RT_plots, fig.height=7, fig.width=9, comment=NA}
full.folr1.cmpnd <- folr1.neg.compound.info %>% 
  mutate(Set = "Neg") %>% 
  bind_rows(folr1.pos.compound.info %>% mutate(Set = "Pos"))
full.folr1.cmpnd %>% 
  ggplot(aes(x = RT, y = Mass)) +
  geom_point(size = 3, alpha = 0.3) +
  xlab("Retention Time (min)") +
  ylab("Mass (Da)") +
  ggtitle("Mass v RT\nFolR1 Exp 1") +
  ylim(0, 1000)
full.folr1.cmpnd %>% 
  ggplot(aes(x = RT, y = Mass, color = Set)) +
  geom_point(size = 3, alpha = 0.8) +
  xlab("Retnetion Time (min)") +
  ylab("Mass (Da)") +
  ggtitle("Mass v RT\nFolR1 Exp 1") +
  facet_wrap(~ Set) +
  ylim(0, 1000)
```


Q: Which compounds were found in one or more of the data types?


```{r cmnpd_mode_match, fig.height= 5, fig.width=8, comment=NA}
folr1.cmpnd.join <- folr1.neg.compound.info %>% 
  inner_join(folr1.pos.compound.info, by = "CAS_ID", suffix = c("_n", "_p")) %>% 
  select(
    CAS_ID, contains("short"), 
    contains("full"), starts_with("Formula"), 
    starts_with("Mass"), starts_with("RT")
    )
# compound names - found in pos and neg mode / cells 
print(folr1.cmpnd.join$compound_full_n)
# percent of cell / neg compounds found in cell / pos 
round(nrow(folr1.cmpnd.join) * 100 / nrow(folr1.neg.compound.info), 1)
# percent of cell / neg compounds found in cell / pos 
round(nrow(folr1.cmpnd.join) * 100 / nrow(folr1.pos.compound.info), 1)
# problem checks #
folr1.cmpnd.join %>% 
  select(contains("Mass")) %>% 
  ggpairs()
folr1.cmpnd.join %>% 
  select(starts_with("RT")) %>% 
  ggpairs()
```


## Missing Values

Q: Do any of the samples have greater than 20% missing (NA) compound abundances, out of all of the features in the dataset?

```{r missing_per_sample_plots, comment=NA}
MissingPerSamplePlot(folr1.neg.raw, "nC") +
  ggtitle("Missing Per Sample\nFolR1 / Exp 1 / Neg Mode")
MissingPerSamplePlot(folr1.pos.raw, "pC") +
  ggtitle("Missing Per Sample\nFolR1 / Exp 1 / Pos Mode")
```

A: Remove `set2_purple_632_R1` from neg mode, pos mode is fine.

```{r}
folr1.neg.raw <- folr1.neg.raw %>% 
  filter(Samples != "set2_purple_632_R1")
# signal was also low in pos mode, eliminate this sample from pos mode as well
folr1.pos.raw <- folr1.pos.raw %>% 
  filter(Samples != "set2_purple_632_R1")
```


Q: Are any of the compounds more than 25% missing in the experimental sample group? If there are any, they will be excluded from analysis. (Threshold increased from 20 to 25% because this is from mouse embryos, which can be expected to have a lower signal).

```{r percent_missing_per_compound, comment=NA}
(folr1.neg.cmpnd.to.excl <- MissingPerCompound(folr1.neg.raw, "nC") %>% 
  filter(percent_na > 25))
MissingPerCompound(folr1.pos.raw, "pC") %>% 
  filter(percent_na > 25)
```


## Negative Controls and Compound Elimination

### Negative Mode

```{r empty_solv_neg, comment=NA}
folr1.neg.raw.type.mean <- folr1.neg.raw %>% 
  group_by(Type) %>% 
  summarize_at(vars(matches("nC")), mean, na.rm = TRUE) %>% 
  gather(key = "Compound", value = "Type_mean_abun", -Type)
folr1.neg.raw.type.mean %>% 
  ggplot(aes(log2(Type_mean_abun), color = Type)) +
  geom_density(size = 2, alpha = 0.8) +
  ggtitle("Distribution of compound means\nFolR1 Exp 1 / Negative Mode\nGrouped by sample type")
folr1.neg.raw.type.mean.order <- folr1.neg.raw.type.mean %>% 
  filter(Type == "sample") %>% 
  arrange(Type_mean_abun)
folr1.neg.raw %>% 
  select(Samples, Type, starts_with("nC")) %>% 
  gather("Compound", value = "Abundance", -c(Samples, Type)) %>% 
  mutate(Cmpnd_sort = factor(Compound, levels = folr1.neg.raw.type.mean.order$Compound)) %>% 
  ggplot(aes(Cmpnd_sort, log2(Abundance), color = Type, group = Samples)) + 
  geom_line(alpha = 0.1, size = 1) + 
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank()) +
  xlab("Compound") +
  geom_line(
    data = folr1.neg.raw.type.mean %>% 
      mutate(Cmpnd_sort = factor(Compound, levels = folr1.neg.raw.type.mean.order$Compound)), 
    aes(Cmpnd_sort, log2(Type_mean_abun), color = Type, group = Type),
    size = 1
    ) +
  ggtitle("Profile Plot of all compound abundances\nWith average per sample type overlaid\nFolR1 Exp 1 / Negative Mode") +
  scale_color_brewer(palette = "Dark2")
folr1.neg.raw.type.mean %>% 
  mutate(Cmpnd_sort = factor(Compound, levels = folr1.neg.raw.type.mean.order$Compound)) %>% 
  ggplot(aes(Cmpnd_sort, log2(Type_mean_abun), color = Type, group = Type)) +
  geom_point(size = 1, alpha = 0.8) +
  geom_line(alpha = 0.8) +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank()) +
  xlab("Compound") +
  ylab("log2(Sample Type Mean)") +
  ggtitle("Profile Plot of compound means by sample type only\nFolR1 Exp 1 / Negative Mode") +
  scale_color_brewer(palette = "Dark2")
folr1.neg.raw.type.diff <- folr1.neg.raw.type.mean %>% 
  spread(Type, Type_mean_abun) %>% 
  mutate(smpl_solv_diff = sample / solv)
folr1.neg.raw.type.diff %>% 
  ggplot(aes(log2(smpl_solv_diff))) +
  geom_histogram(bins = 50)
# include compounds with FC > 2.5 or FC is NA (indication of NA in solv or empty)
folr1.neg.cmpnd.to.incl <- folr1.neg.raw.type.diff  %>% 
  filter(smpl_solv_diff > 2.5 | is.na(smpl_solv_diff)) %>% 
  filter(!(Compound %in% folr1.neg.cmpnd.to.excl$Compound))
# original number of metabolites
nrow(folr1.neg.raw.type.diff)
# number of metabolites after filtering 
nrow(folr1.neg.cmpnd.to.incl)
```


### Positive Mode

```{r empty_solv_pos, comment=NA}
folr1.pos.raw.type.mean <- folr1.pos.raw %>% 
  group_by(Type) %>% 
  summarize_at(vars(matches("pC")), mean, na.rm = TRUE) %>% 
  gather(key = "Compound", value = "Type_mean_abun", -Type)
folr1.pos.raw.type.mean %>% 
  ggplot(aes(log2(Type_mean_abun), color = Type)) +
  geom_density(size = 2, alpha = 0.8) +
  ggtitle("Distribution of compound means\nFolR1 Exp 1 / Positive Mode\nGrouped by sample type")
folr1.pos.raw.type.mean.order <- folr1.pos.raw.type.mean %>% 
  filter(Type == "sample") %>% 
  arrange(Type_mean_abun)
folr1.pos.raw %>% 
  select(Samples, Type, starts_with("pC")) %>% 
  gather("Compound", value = "Abundance", -c(Samples, Type)) %>% 
  mutate(Cmpnd_sort = factor(Compound, levels = folr1.pos.raw.type.mean.order$Compound)) %>% 
  ggplot(aes(Cmpnd_sort, log2(Abundance), color = Type, group = Samples)) + 
  geom_line(alpha = 0.1, size = 1) + 
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank()) +
  xlab("Compound") +
  geom_line(
    data = folr1.pos.raw.type.mean %>% 
      mutate(Cmpnd_sort = factor(Compound, levels = folr1.pos.raw.type.mean.order$Compound)), 
    aes(Cmpnd_sort, log2(Type_mean_abun), color = Type, group = Type),
    size = 1
    ) +
  ggtitle("Profile Plot of all compound abundances\nWith average per sample type overlaid\nFolR1 Exp 1 / Positive Mode") +
  scale_color_brewer(palette = "Dark2")
folr1.pos.raw.type.mean %>% 
  mutate(Cmpnd_sort = factor(Compound, levels = folr1.pos.raw.type.mean.order$Compound)) %>% 
  ggplot(aes(Cmpnd_sort, log2(Type_mean_abun), color = Type, group = Type)) +
  geom_point(size = 1, alpha = 0.8) +
  geom_line(alpha = 0.8) +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank()) +
  xlab("Compound") +
  ylab("log2(Sample Type Mean)") +
  ggtitle("Profile Plot of compound means by sample type only\nFolR1 Exp 1 / Positive Mode") +
  scale_color_brewer(palette = "Dark2")
folr1.pos.raw.type.diff <- folr1.pos.raw.type.mean %>% 
  spread(Type, Type_mean_abun) %>% 
  mutate(smpl_solv_diff = sample / solv)
folr1.pos.raw.type.diff %>% 
  ggplot(aes(log2(smpl_solv_diff))) +
  geom_histogram(bins = 50)
# include compounds with FC > 2.5 or FC is NA (indication of NA in solv or empty)
folr1.pos.cmpnd.to.incl <- folr1.pos.raw.type.diff %>% 
  filter(smpl_solv_diff > 2.5 | is.na(smpl_solv_diff))
# original number of metabolites
nrow(folr1.pos.raw.type.diff)
# number of metabolites after filtering 
nrow(folr1.pos.cmpnd.to.incl)
```


# Data Prep and Preliminary Analysis

## Cleanup

```{r min_na_rpl_log_transform, comment=NA}
folr1.neg.noNA <- folr1.neg.raw %>% 
  select(Samples:Prot_quant, one_of(folr1.neg.cmpnd.to.incl$Compound)) %>% 
  ReplaceNAwMinLogTransform("nC")
folr1.pos.noNA <- folr1.pos.raw %>% 
  select(Samples:Prot_quant, one_of(folr1.pos.cmpnd.to.incl$Compound)) %>% 
  ReplaceNAwMinLogTransform("pC")
```


## Distribution plots

### Negative Mode

```{r distribution_plots_neg, comment=NA}
folr1.neg.noNA.gathered <- folr1.neg.noNA %>% 
  gather(
    key = "Metabolite", "Abundance", 
    which(colnames(folr1.neg.noNA) == "nC1"):ncol(folr1.neg.noNA)
    )
# plot all abundances in a sample, grouped by sample as a boxplot
folr1.neg.noNA.gathered %>% 
  ggplot(aes(Samples, Abundance, fill = Type)) +
  geom_boxplot() +
  geom_boxplot(aes(color = Type), fatten = NULL, fill = NA, coef = 0, outlier.alpha = 0, show.legend = FALSE) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  ylab("log2(Abundance)") +
  ggtitle("Boxplot of compound abundances\nAll samples\nFolR1 Exp 1/ Negative Mode") +
  scale_fill_tableau() +
  scale_color_tableau()
# same data format, but as ridge plots
folr1.neg.noNA.gathered %>% 
  ggplot(aes(y = Samples, x = Abundance, fill = Type)) + 
  geom_density_ridges(scale = 15) +
  theme_ridges() +
  scale_y_discrete(expand = c(0.01, 0)) +
  ggtitle("Ridge plot of compound abundances\nAll samples\nFolR1 Exp 1/ Negative Mode") +
  scale_fill_tableau()
folr1.neg.noNA.gathered %>% 
  filter(Type != "solv") %>% 
  ggplot(aes(y = Samples, x = Abundance, fill = Type)) + 
  geom_density_ridges(scale = 15) +
  theme_ridges() +
  scale_y_discrete(expand = c(0.01, 0)) +
  ggtitle("Ridge plot of compound abundances\nAll samples\nFolR1 Exp 1/ Negative Mode") +
  scale_fill_tableau()
# experimental samples only
folr1.neg.noNA.gathered %>% 
  filter(Type == "sample") %>% 
  unite("Condition", Diet:Genotype, sep = "_") %>% 
  ggplot(aes(y = Samples, x = Abundance, fill = Condition)) + 
  geom_density_ridges(scale = 10) +
  theme_ridges() +
  scale_y_discrete(expand = c(0.01, 0)) +
  ggtitle("Ridge plot of compound abundances\nExperimental samples only\nFolR1 Exp 1/ Negative Mode") +
  scale_fill_tableau()
# overlay the distributions for another look
folr1.neg.noNA.gathered %>%
  filter(Type == "sample") %>% 
  unite("Condition", Diet:Genotype, sep = "_") %>% 
  ggplot(aes(Abundance, group = Samples, color = Condition)) +
  geom_density(alpha = 0.8, size = 0.75) +
  xlab("log2(Abundance)") +
  ggtitle("Density plot of compound abundances\nExperimental samples only\nFolR1 Exp 1/ Negative Mode") +
  scale_color_tableau()
folr1.neg.avg.smpl.abun <- folr1.neg.noNA.gathered %>% 
  group_by(Samples, Diet, Genotype) %>% 
  summarize(avg_abun = mean(Abundance)) %>% 
  arrange(avg_abun)
folr1.neg.avg.smpl.abun %>% 
  filter(Diet != "solv") %>% 
  ggplot(aes(avg_abun)) +
  geom_histogram(bins = 50)
folr1.neg.avg.smpl.abun %>% 
  filter(Diet != "solv" & Diet != "mix") %>% 
  ggplot(aes(avg_abun, fill = Genotype)) +
  geom_histogram(bins = 50) +
  facet_wrap(~ Genotype, ncol = 1) +
  scale_fill_tableau()
folr1.neg.avg.smpl.abun %>% 
  filter(Diet != "solv" & Diet != "mix") %>% 
  ggplot(aes(Diet, avg_abun)) +
  geom_boxplot() +
  geom_jitter(aes(color = Genotype), width = 0.1, size = 2, alpha = 0.8) +
  scale_color_tableau() +
  ylab("Mean Sample Log2(Abun)")
folr1.neg.avg.smpl.abun %>% 
  filter(Diet != "solv" & Diet != "mix") %>% 
  lm(avg_abun ~ Diet*Genotype, data = .) %>% 
  summary()
```


### Positive Mode

```{r distribution_plots_pos, comment=NA}
folr1.pos.noNA.gathered <- folr1.pos.noNA %>% 
  gather(
    key = "Metabolite", "Abundance", 
    which(colnames(folr1.pos.noNA) == "pC1"):ncol(folr1.pos.noNA)
    )
# plot all abundances in a sample, grouped by sample as a boxplot
folr1.pos.noNA.gathered %>% 
  ggplot(aes(Samples, Abundance, fill = Type)) +
  geom_boxplot() +
  geom_boxplot(aes(color = Type), fatten = NULL, fill = NA, coef = 0, outlier.alpha = 0, show.legend = FALSE) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  ylab("log2(Abundance)") +
  ggtitle("Boxplot of compound abundances\nAll samples\nFolR1 Exp 1/ Positive Mode") +
  scale_color_tableau() +
  scale_fill_tableau()
```

Note: filter out `set2_purple_632_R1` - moved this to earlier section

```{r comment=NA}
# same data format, but as ridge plots
folr1.pos.noNA.gathered %>% 
  ggplot(aes(y = Samples, x = Abundance, fill = Type)) + 
  geom_density_ridges(scale = 15) +
  theme_ridges() +
  scale_y_discrete(expand = c(0.01, 0)) +
  ggtitle("Ridge plot of compound abundances\nAll samples\nFolR1 Exp 1/ Positive Mode") +
  scale_fill_tableau()
# experimental samples only
folr1.pos.noNA.gathered %>% 
  filter(Type == "sample") %>% 
  unite("Condition", Diet:Genotype, sep = "_") %>% 
  ggplot(aes(y = Samples, x = Abundance, fill = Condition)) + 
  geom_density_ridges(scale = 10) +
  theme_ridges() +
  scale_y_discrete(expand = c(0.01, 0)) +
  ggtitle("Ridge plot of compound abundances\nExperimental samples only\nFolR1 Exp 1/ Positive Mode") +
  scale_fill_tableau()
# overlay the distributions for another look
folr1.pos.noNA.gathered %>%
  filter(Type == "sample") %>% 
  unite("Condition", Diet:Genotype, sep = "_") %>% 
  ggplot(aes(Abundance, group = Samples, color = Condition)) +
  geom_density(alpha = 0.8, size = 0.75) +
  xlab("log2(Abundance)") +
  ggtitle("Density plot of compound abundances\nExperimental samples only\nFolR1 Exp 1/ Positive Mode") +
  scale_color_tableau()
folr1.pos.avg.smpl.abun <- folr1.pos.noNA.gathered %>% 
  group_by(Samples, Diet, Genotype) %>% 
  summarize(avg_abun = mean(Abundance)) %>% 
  arrange(avg_abun)
folr1.pos.avg.smpl.abun %>% 
  filter(Diet != "solv") %>% 
  ggplot(aes(avg_abun)) +
  geom_histogram(bins = 50)
folr1.pos.avg.smpl.abun %>% 
  filter(Diet != "solv" & Diet != "mix") %>% 
  ggplot(aes(avg_abun, fill = Genotype)) +
  geom_histogram(bins = 50) +
  facet_wrap(~ Genotype, ncol = 1) +
  scale_fill_tableau()
folr1.pos.avg.smpl.abun %>% 
  filter(Diet != "solv" & Diet != "mix") %>% 
  ggplot(aes(Diet, avg_abun)) +
  geom_boxplot() +
  geom_jitter(aes(color = Genotype), width = 0.1, size = 2, alpha = 0.8) +
  scale_color_tableau() +
  ylab("Mean Sample Log2(Abun)")
folr1.pos.avg.smpl.abun %>% 
  filter(Diet != "solv" & Diet != "mix") %>% 
  lm(avg_abun ~ Diet*Genotype, data = .) %>% 
  summary()
```


## Principal Component Analysis 

Some plots to understand the relationship between the samples, mix samples, solvent, and empty samples in some cases. 

### Negative Mode 

```{r pca_neg, comment=NA}
### PCA on all Samples ###
folr1.neg.full.pca <- folr1.neg.noNA %>% 
  select(starts_with("nC")) %>% 
  mutate_all(scale, center = TRUE, scale = FALSE) %>% 
  as.matrix() %>% 
  prcomp()
plot(
  (folr1.neg.full.pca$sdev ^ 2) * 100 / sum(folr1.neg.full.pca$sdev ^ 2), 
  xlab = "Principal Component",
  ylab = "Variance Explained",
  main = "Percent variance explained by each principal component\nAll samples only\nFolR1 Exp 1 / Negative Mode",
  type = "b"
  )
folr1.neg.full.pca.x <- as.data.frame(folr1.neg.full.pca$x)
row.names(folr1.neg.full.pca.x) <- folr1.neg.noNA$Samples
folr1.neg.full.pca.x <- folr1.neg.full.pca.x %>% 
  bind_cols(folr1.neg.noNA %>% select(Diet:Prot_quant))
folr1.neg.full.pca.x %>% 
  ggplot(aes(x = PC1, y = PC2, color = Type)) +
  geom_point(size = 4, alpha = 0.8) +
  xlab("PC1 (82.4% Var)") +
  ylab("PC2 (3.7% Var)") +
  ggtitle("Principal Component Analysis\nAll Samples\nFolR1 Exp 1 / Negative Mode") +
  scale_color_tableau()
### Samples and mix ###
folr1.neg.smpl.mix.pca <- folr1.neg.noNA %>% 
  filter(Type == "sample" | Type == "mix") %>% 
  select(starts_with("nC")) %>% 
  mutate_all(scale, center = TRUE, scale = FALSE) %>% 
  as.matrix() %>% 
  prcomp()
plot(
  (folr1.neg.smpl.mix.pca$sdev ^ 2) * 100 / sum(folr1.neg.smpl.mix.pca$sdev ^ 2), 
  xlab = "Principal Component",
  ylab = "Variance Explained",
  main = "Percent variance explained by each principal component\nSamples and mix\nFolR1 Exp 1 / Negative Mode",
  type = "b"
  )
folr1.neg.smpl.mix.pca.x <- as.data.frame(folr1.neg.smpl.mix.pca$x)
folr1.neg.smpl.mix.pca.x <- folr1.neg.smpl.mix.pca.x %>% 
  bind_cols(
    folr1.neg.noNA %>% 
      filter(Type == "sample" | Type == "mix") %>% 
      select(Samples, Diet:Prot_quant)
  )
row.names(folr1.neg.smpl.mix.pca.x) <- folr1.neg.smpl.mix.pca.x$Samples
folr1.neg.smpl.mix.pca.x %>% 
  ggplot(aes(x = PC1, y = PC2, color = Genotype, shape = Type)) +
  geom_point(size = 4, alpha = 0.8) +
  xlab("PC1 (30.3% Var)") +
  ylab("PC2 (16.8% Var)") +
  ggtitle("Principal Component Analysis\nSamples and mix\nFolR1 Exp 1 / Negative Mode") +
  scale_color_tableau()
folr1.neg.smpl.mix.pca.x %>% 
  ggplot(aes(x = PC3, y = PC4, color = Genotype, shape = Type)) +
  geom_point(size = 4, alpha = 0.8) +
  xlab("PC3 (7.5% Var)") +
  ylab("PC4 (6.7% Var)") +
  ggtitle("Principal Component Analysis\nSamples and mix\nFolR1 Exp 1 / Negative Mode") +
  scale_color_tableau()

### Experimental Samples Only ###
folr1.neg.smpl.pca <- folr1.neg.noNA %>% 
  filter(Type == "sample") %>% 
  select(starts_with("nC")) %>% 
  mutate_all(scale, center = TRUE, scale = FALSE) %>% 
  as.matrix() %>% 
  prcomp()
plot(
  (folr1.neg.smpl.pca$sdev ^ 2) * 100 / sum(folr1.neg.smpl.pca$sdev ^ 2), 
  xlab = "Principal Component",
  ylab = "Variance Explained",
  main = "Percent variance explained by each principal component\nExperimental samples only\nFolR1 Exp 1 / Negative Mode",
  type = "b"
  )
folr1.neg.smpl.pca.x <- as.data.frame(folr1.neg.smpl.pca$x)
folr1.neg.smpl.pca.x <- folr1.neg.smpl.pca.x %>% 
  bind_cols(
    folr1.neg.noNA %>% 
      filter(Type == "sample") %>% 
      select(Samples, Diet:Prot_quant)
  )
row.names(folr1.neg.smpl.pca.x) <- folr1.neg.smpl.pca.x$Samples
folr1.neg.smpl.pca.x %>% 
  ggplot(aes(x = PC1, y = PC2, shape = Genotype, color = Diet)) +
  geom_point(size = 4, alpha = 0.8) +
  xlab("PC1 (30.2% Var)") +
  ylab("PC2 (17.3% Var)") +
  ggtitle("Principal Component Analysis\nExperimental samples only\nFolR1 Exp 1 / Negative Mode") +
  scale_color_tableau()
folr1.neg.smpl.pca.x %>% 
  ggplot(aes(x = PC3, y = PC4, shape = Genotype, color = Diet)) +
  geom_point(size = 4, alpha = 0.8) +
  xlab("PC3 (7.6% Var)") +
  ylab("PC4 (6.8% Var)") +
  ggtitle("Principal Component Analysis\nExperimental samples only\nFolR1 Exp 1 / Negative Mode") +
  scale_color_tableau()
folr1.neg.covar <- folr1.neg.smpl.pca.x %>% 
  select(Samples, PC1:PC8, Diet:Prot_quant) %>% 
  as_tibble() %>% 
  mutate(Prot_quant = as.numeric(Prot_quant)) %>% 
  gather("PC", "value", PC1:PC8)
folr1.neg.covar %>% 
  ggplot(aes(Litter_ID, value, color = Genotype, shape = Diet)) +
  geom_point(size = 2) +
  facet_wrap(~ PC, scales = "free_y") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_color_tableau()
folr1.neg.covar %>% 
  ggplot(aes(Litter_ID, value, color = Diet, shape = Genotype)) +
  geom_point(size = 2) +
  facet_wrap(~ PC, scales = "free_y") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_color_tableau()
folr1.neg.covar %>% 
  mutate(Litter_ID = as.numeric(Litter_ID)) %>% 
  filter(PC == "PC7") %>% 
  lm(value ~ Litter_ID, data = .) %>% 
  summary()
# signal difference?
folr1.neg.noNA.gathered %>% 
  filter(Type == "sample") %>% 
  group_by(Samples, Genotype, Diet, Litter_ID) %>% 
  summarize(avg_abun = mean(Abundance)) %>% 
  mutate(Litter_ID = as.numeric(Litter_ID)) %>% 
  ggplot(aes(Litter_ID, avg_abun)) +
  geom_point(size = 2, aes(color = Genotype, shape = Diet)) +
  geom_smooth(method = "lm") +
  scale_color_tableau() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
folr1.neg.covar %>% 
  ggplot(aes(Prot_quant, value, color = Genotype, shape = Diet)) +
  geom_point(size = 2) +
  facet_wrap(~ PC, scales = "free_y") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_color_tableau()
folr1.neg.covar %>% 
  ggplot(aes(Prot_quant, value, color = Diet, shape = Genotype)) +
  geom_point(size = 2) +
  facet_wrap(~ PC, scales = "free_y") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_color_tableau()
folr1.neg.covar %>% 
  group_by(PC) %>% 
  summarize(corr = cor(value, Prot_quant))
folr1.neg.covar %>% 
  ggplot(aes(Emb_position, value, color = Genotype, shape = Diet)) +
  geom_point(size = 2) +
  facet_wrap(~ PC, scales = "free_y") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_color_tableau()
folr1.neg.covar %>% 
  ggplot(aes(Emb_position, value, color = Diet, shape = Genotype)) +
  geom_point(size = 2) +
  facet_wrap(~ PC, scales = "free_y") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_color_tableau()
```


### Positive Mode 

```{r pca_pos, comment=NA}
### PCA on all Samples ###
folr1.pos.full.pca <- folr1.pos.noNA %>% 
  select(starts_with("pC")) %>% 
  mutate_all(scale, center = TRUE, scale = FALSE) %>% 
  as.matrix() %>% 
  prcomp()
plot(
  (folr1.pos.full.pca$sdev ^ 2) * 100 / sum(folr1.pos.full.pca$sdev ^ 2), 
  xlab = "Principal Component",
  ylab = "Variance Explained",
  main = "Percent variance explained by each principal component\nAll samples only\nFolR1 Exp 1 / Positive Mode",
  type = "b"
  )
folr1.pos.full.pca.x <- as.data.frame(folr1.pos.full.pca$x)
row.names(folr1.pos.full.pca.x) <- folr1.pos.noNA$Samples
folr1.pos.full.pca.x <- folr1.pos.full.pca.x %>% 
  bind_cols(folr1.pos.noNA %>% select(Diet:Prot_quant))
folr1.pos.full.pca.x %>% 
  ggplot(aes(x = PC1, y = PC2, color = Type)) +
  geom_point(size = 4, alpha = 0.8) +
  xlab("PC1 (43.4% Var)") +
  ylab("PC2 (9.9% Var)") +
  ggtitle("Principal Component Analysis\nAll Samples\nFolR1 Exp 1 / Positive Mode") +
  scale_color_tableau()
### Samples and mix ###
folr1.pos.smpl.mix.pca <- folr1.pos.noNA %>% 
  filter(Type == "sample" | Type == "mix") %>% 
  select(starts_with("pC")) %>% 
  mutate_all(scale, center = TRUE, scale = FALSE) %>% 
  as.matrix() %>% 
  prcomp()
plot(
  (folr1.pos.smpl.mix.pca$sdev ^ 2) * 100 / sum(folr1.pos.smpl.mix.pca$sdev ^ 2), 
  xlab = "Principal Component",
  ylab = "Variance Explained",
  main = "Percent variance explained by each principal component\nSamples and mix\nFolR1 Exp 1 / Positive Mode",
  type = "b"
  )
folr1.pos.smpl.mix.pca.x <- as.data.frame(folr1.pos.smpl.mix.pca$x)
folr1.pos.smpl.mix.pca.x <- folr1.pos.smpl.mix.pca.x %>% 
  bind_cols(
    folr1.pos.noNA %>% 
      filter(Type == "sample" | Type == "mix") %>% 
      select(Samples, Diet:Prot_quant)
  )
row.names(folr1.pos.smpl.mix.pca.x) <- folr1.pos.smpl.mix.pca.x$Samples
folr1.pos.smpl.mix.pca.x %>% 
  ggplot(aes(x = PC1, y = PC2, color = Genotype, shape = Type)) +
  geom_point(size = 4, alpha = 0.8) +
  xlab("PC1 (19.3% Var)") +
  ylab("PC2 (14.1% Var)") +
  ggtitle("Principal Component Analysis\nSamples and mix\nFolR1 Exp 1 / Positive Mode") +
  scale_color_tableau()
folr1.pos.smpl.mix.pca.x %>% 
  ggplot(aes(x = PC3, y = PC4, color = Genotype, shape = Type)) +
  geom_point(size = 4, alpha = 0.8) +
  xlab("PC3 (10.5% Var)") +
  ylab("PC4 (8.4% Var)") +
  ggtitle("Principal Component Analysis\nSamples and mix\nFolR1 Exp 1 / Positive Mode") +
  scale_color_tableau()

### Experimental Samples Only ###
folr1.pos.smpl.pca <- folr1.pos.noNA %>% 
  filter(Type == "sample") %>% 
  select(starts_with("pC")) %>% 
  mutate_all(scale, center = TRUE, scale = FALSE) %>% 
  as.matrix() %>% 
  prcomp()
plot(
  (folr1.pos.smpl.pca$sdev ^ 2) * 100 / sum(folr1.pos.smpl.pca$sdev ^ 2), 
  xlab = "Principal Component",
  ylab = "Variance Explained",
  main = "Percent variance explained by each principal component\nExperimental samples only\nFolR1 Exp 1 / Positive Mode",
  type = "b"
  )
folr1.pos.smpl.pca.x <- as.data.frame(folr1.pos.smpl.pca$x)
folr1.pos.smpl.pca.x <- folr1.pos.smpl.pca.x %>% 
  bind_cols(
    folr1.pos.noNA %>% 
      filter(Type == "sample") %>% 
      select(Samples, Diet:Prot_quant)
  )
row.names(folr1.pos.smpl.pca.x) <- folr1.pos.smpl.pca.x$Samples
folr1.pos.smpl.pca.x %>% 
  ggplot(aes(x = PC1, y = PC2, shape = Genotype, color = Diet)) +
  geom_point(size = 4, alpha = 0.8) +
  xlab("PC1 (19.5% Var)") +
  ylab("PC2 (14.5% Var)") +
  ggtitle("Principal Component Analysis\nExperimental samples only\nFolR1 Exp 1 / Positive Mode") +
  scale_color_tableau()
folr1.pos.smpl.pca.x %>% 
  ggplot(aes(x = PC3, y = PC4, shape = Genotype, color = Diet)) +
  geom_point(size = 4, alpha = 0.8) +
  xlab("PC3 (10.1% Var)") +
  ylab("PC4 (8.5% Var)") +
  ggtitle("Principal Component Analysis\nExperimental samples only\nFolR1 Exp 1 / Positive Mode") +
  scale_color_tableau()
folr1.pos.covar <- folr1.pos.smpl.pca.x %>% 
  select(Samples, PC1:PC8, Diet:Prot_quant) %>% 
  as_tibble() %>% 
  mutate(Prot_quant = as.numeric(Prot_quant)) %>% 
  gather("PC", "value", PC1:PC8)
folr1.pos.covar %>% 
  ggplot(aes(Litter_ID, value, color = Set, shape = Diet)) +
  geom_point(size = 2) +
  facet_wrap(~ PC, scales = "free_y") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_color_tableau()
folr1.pos.covar %>% 
  mutate(Litter_ID = as.numeric(Litter_ID)) %>% 
  group_by(PC) %>% 
  summarize(corr = cor(value, Litter_ID))
folr1.pos.covar %>% 
  mutate(Litter_ID = as.numeric(Litter_ID)) %>% 
  filter(PC == "PC4") %>% 
  lm(value ~ Litter_ID, data = .) %>% 
  summary()
# signal difference?
folr1.pos.noNA.gathered %>% 
  filter(Type == "sample") %>% 
  group_by(Samples, Genotype, Diet, Litter_ID) %>% 
  summarize(avg_abun = mean(Abundance)) %>% 
  mutate(Litter_ID = as.numeric(Litter_ID)) %>% 
  ggplot(aes(Litter_ID, avg_abun)) +
  geom_point(size = 2, aes(color = Genotype, shape = Diet)) +
  geom_smooth(method = "lm") +
  scale_color_tableau() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
folr1.pos.covar %>% 
  ggplot(aes(Prot_quant, value, color = Genotype, shape = Diet)) +
  geom_point(size = 2) +
  facet_wrap(~ PC, scales = "free_y") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_color_tableau()
folr1.pos.covar %>% 
  ggplot(aes(Prot_quant, value, color = Diet, shape = Genotype)) +
  geom_point(size = 2) +
  facet_wrap(~ PC, scales = "free_y") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_color_tableau()
folr1.pos.covar %>% 
  group_by(PC) %>% 
  summarize(corr = cor(value, Prot_quant))
folr1.pos.covar %>% 
  ggplot(aes(Emb_position, value, color = Genotype, shape = Diet)) +
  geom_point(size = 2) +
  facet_wrap(~ PC, scales = "free_y") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_color_tableau()
folr1.pos.covar %>% 
  ggplot(aes(Emb_position, value, color = Diet, shape = Genotype)) +
  geom_point(size = 2) +
  facet_wrap(~ PC, scales = "free_y") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_color_tableau()
folr1.pos.covar %>% 
  ggplot(aes(Set, value)) +
  geom_boxplot() +
  geom_jitter(width = 0.25, size = 2, aes(color = Genotype, shape = Diet)) +
  facet_wrap(~ PC, scales = "free_y") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_color_tableau()
```


# Batch Effects and Signifiance Testing

## Negative Mode

```{r neg_stat, comment=NA}
# sample prep
folr1.neg.smpl.data <- folr1.neg.noNA %>% 
  filter(Type == "sample") %>% 
  unite("Condition", Diet:Genotype, sep = "_", remove = FALSE)
folr1.neg.data.for.sva <- as.matrix(
  folr1.neg.smpl.data[, which(
    colnames(folr1.neg.smpl.data) == "nC1"
    ):ncol(folr1.neg.smpl.data)]
  )
row.names(folr1.neg.data.for.sva) <- folr1.neg.smpl.data$Samples
folr1.neg.data.for.sva <- t(folr1.neg.data.for.sva)
# pheno prep
folr1.neg.data.pheno <- as.data.frame(folr1.neg.smpl.data[, 3:10])
row.names(folr1.neg.data.pheno) <- folr1.neg.smpl.data$Samples
# sva calculation
folr1.neg.mod <- model.matrix(~ 0 + as.factor(Condition), data = folr1.neg.data.pheno)
folr1.neg.mod0 <- model.matrix(~ 1, data = folr1.neg.data.pheno)
set.seed(2018)
num.sv(folr1.neg.data.for.sva, folr1.neg.mod, method = "be")
set.seed(2018)
num.sv(folr1.neg.data.for.sva, folr1.neg.mod, method = "leek")
set.seed(2018)
folr1.neg.sv <- sva(folr1.neg.data.for.sva, folr1.neg.mod, folr1.neg.mod0)
# extract the surrogate variables
folr1.neg.surr.var <- as.data.frame(folr1.neg.sv$sv)
colnames(folr1.neg.surr.var) <- c("S1", "S2", "S3", "S4", "S5", "S6")

folr1.neg.covar <- folr1.neg.covar %>% 
  spread(key = PC, value = value) %>% 
  unite(col = "Condition", Diet:Genotype, remove = FALSE) %>% 
  inner_join(
    cbind(folr1.neg.data.pheno, folr1.neg.surr.var) %>% 
      rownames_to_column("Samples") %>% 
      select(Samples, S1:S6),
    by = "Samples"
    )
folr1.neg.covar %>% 
  select(Samples, Condition:Genotype, S1:S6) %>% 
  gather("surr_var", "value", S1:S6) %>% 
  ggplot(aes(Condition, value)) +
  geom_boxplot() +
  geom_jitter(size = 2, alpha = 0.8, width = 0.1, aes(color = Diet)) +
  facet_wrap(~ surr_var, scales = "free_y") +
  theme(axis.text.x = element_text(angle = 60, hjust = 1)) +
  scale_color_tableau()
folr1.neg.covar %>% 
  select(Samples:Genotype, PC1:PC8) %>% 
  gather("PC", "value", PC1:PC8) %>% 
  ggplot(aes(Condition, value)) +
  geom_boxplot() +
  geom_point(size = 2, alpha = 0.8, aes(color = Genotype)) +
  facet_wrap(~ PC, scales = "free") +
  theme(axis.text.x = element_text(angle = 60, hjust = 1)) +
  scale_color_tableau()
folr1.neg.covar %>% 
  select(PC1:PC8, S1:S6) %>% 
  ggcorr(label = TRUE)
folr1.neg.covar %>% 
  ggplot(aes(PC1, S1, color = Set)) +
  geom_point(size = 2, alpha = 0.8)

colnames(folr1.neg.mod) <- c("fa_het", "fa_wt", "met_het", "met_wt", "het", "wt")
# combine the full model matrix and the surrogate variables into one
folr1.neg.design.sv <- cbind(folr1.neg.mod, folr1.neg.surr.var[, 1:2])
#folr1.neg.cont.mat <- makeContrasts(
#  genotype_main = (fa_wt + met_wt + wt) - (fa_het + met_het + het), 
#  diet_main = fa_cd - fa_wt,
#  FA_diff = (fa_cd - fa_wt) - (cd - wt),
#  levels = c("fa_cd", "fa_wt", "cd", "wt", "S1")
#  )
folr1.neg.test.matrix <- model.matrix(~Diet*Genotype, folr1.neg.data.pheno) %>% 
 cbind(folr1.neg.surr.var[, 1])
colnames(folr1.neg.test.matrix)[7] <- "S1"
# fit the model/design matrix
folr1.neg.eb <- folr1.neg.data.for.sva %>% 
  lmFit(folr1.neg.test.matrix) %>% 
  eBayes()
folr1.neg.eb.tidy <- tidy(folr1.neg.eb) #%>% 
#  mutate(
#    adj_pval = p.adjust(p.value, method = "BH"),
#    FC = 2 ^ estimate,
#    change_in_cd = ifelse(FC < 1, "down", "up")
#    ) %>% 
#  rename(compound_short = gene)
folr1.neg.eb.tidy %>% 
  ggplot(aes(p.value, fill = term)) +
  geom_histogram(bins = 150) +
  geom_vline(xintercept = 0.05 / 150) +
  facet_wrap(~ term, scales = "free_y") +
  scale_fill_tableau()
folr1.neg.eb.tidy %>% 
  rename("compound_short" = gene) %>% 
  filter(p.value < 0.05/ 150 & term != "S1") %>% 
  mutate(FC = 2 ^ estimate) %>% 
  inner_join(folr1.neg.compound.info, by = "compound_short")
folr1.neg.noNA %>% 
  filter(Type == "sample") %>% 
  ggplot(aes(Diet, nC149)) +
  geom_boxplot() +
  geom_jitter(aes(color = Genotype), size = 2, width = 0.1) + 
  scale_color_tableau() + 
  theme(axis.text.x = element_text(angle = 60, hjust = 1)) +
  ylab("ATP") +
  facet_wrap(~ Genotype)
folr1.neg.noNA %>% 
  filter(Type == "sample") %>% 
  ggplot(aes(Diet, nC28)) +
  geom_boxplot() +
  geom_jitter(aes(color = Genotype), size = 2, width = 0.1) + 
  scale_color_tableau() + 
  theme(axis.text.x = element_text(angle = 60, hjust = 1)) +
  facet_wrap(~ Genotype) +
  ylab("log2(Threonine)")

folr1.neg.test.matrix.2S <- model.matrix(~Diet*Genotype, folr1.neg.data.pheno) %>% 
 cbind(folr1.neg.surr.var[, 1:2])
folr1.neg.eb.2S <- folr1.neg.data.for.sva %>% 
  lmFit(folr1.neg.test.matrix.2S) %>% 
  eBayes()
folr1.neg.eb.tidy.2S <- tidy(folr1.neg.eb.2S) #%>% 
#  mutate(
#    adj_pval = p.adjust(p.value, method = "BH"),
#    FC = 2 ^ estimate,
#    change_in_cd = ifelse(FC < 1, "down", "up")
#    ) %>% 
#  rename(compound_short = gene)
folr1.neg.eb.tidy.2S %>% 
  ggplot(aes(p.value, fill = term)) +
  geom_histogram(bins = 150) +
  geom_vline(xintercept = 0.05 / 150) +
  facet_wrap(~ term, scales = "free_y") +
  scale_fill_tableau()
folr1.neg.eb.tidy.2S %>% 
  rename("compound_short" = gene) %>% 
  filter(p.value < 0.05/ 150) %>% 
  mutate(FC = 2 ^ estimate) %>% 
  inner_join(folr1.neg.compound.info, by = "compound_short")

folr1.neg.noNA %>% 
  inner_join(folr1.neg.covar, by = "Samples") %>% 
  ggplot(aes(S2, nC149, color = Genotype.x)) +
  geom_point(size = 2, alpha = 0.6) +
  scale_color_tableau() + 
  theme(axis.text.x = element_text(angle = 60, hjust = 1)) +
  ylab("ATP")

folr1.neg.covar %>% 
  ggplot(aes(Prot_quant, S2, color = Genotype)) +
  geom_point(size = 2, alpha = 0.8)
folr1.neg.covar %>% 
  ggplot(aes(Litter_ID, S2, color = Genotype)) +
  geom_point(size = 2, alpha = 0.8) +
  theme(axis.text.x = element_text(angle = 60, hjust = 1))
folr1.neg.covar %>% 
  ggplot(aes(Set, S2)) +
  geom_boxplot() +
  geom_jitter(width = 0.1, aes(color = Genotype))
folr1.neg.covar %>% 
  ggplot(aes(Genotype, S2)) +
  geom_boxplot() +
  geom_jitter(width = 0.1, aes(color = Diet)) +
  facet_wrap(~ Diet)
folr1.neg.covar %>% 
  lm(S2 ~ Genotype:Diet, data = .) %>% 
  summary()
folr1.neg.covar %>% 
  lm(S1 ~ Genotype:Diet, data = .) %>% 
  summary()
# >> don't use S2

folr1.neg.S1.hits <- folr1.neg.eb.tidy %>% 
  rename("compound_short" = gene) %>% 
  filter(p.value < 0.05/ 150 & term != "S1") %>% 
  mutate(FC = 2 ^ estimate) %>% 
  inner_join(folr1.neg.compound.info, by = "compound_short")

# volcano plot (fix this up)
folr1.neg.eb.tidy %>%
  filter(term != "S1") %>% 
  ggplot(aes(estimate, -log10(p.value))) +
  geom_point(size = 2, alpha = 0.5) +
  geom_hline(linetype = "dashed", color = "#009E73", yintercept = -log10(0.05 / 150)) +
  geom_vline(linetype = "dashed", color = "#CC79A7", xintercept = log2(1.2)) +
  geom_vline(linetype = "dashed", color = "#CC79A7", xintercept = log2(1/1.2)) +
  xlab("log2(FC)") +
  ylab("-log10(adjusted p-value)") +
  ggtitle("Volcano plot\nFolR1 / Negative Mode")
```

### Viz

```{r neg_resid_viz, comment=NA}
folr1.neg.gathered <- folr1.neg.noNA %>%
  inner_join(
    folr1.neg.covar %>% select(Samples, S1), by = "Samples"
    ) %>%  
  select(Samples, Diet:Genotype, S1, starts_with("nC")) %>% 
  gather(key = "Compound", value = "Abundance", nC1:nC99)
folr1.neg.nested <- folr1.neg.gathered %>% 
  group_by(Compound) %>% 
  nest() %>% 
  mutate(model = map(data, ~lm(Abundance ~ S1, data = .))) %>% 
  mutate(augment_model = map(model, augment))
folr1.neg.modSV.resid <- folr1.neg.nested %>% 
  unnest(data, augment_model) %>% 
  select(Samples:Genotype, Compound, .resid) %>% 
  spread(Compound, .resid) 
folr1.neg.modSV.resid %>% 
  select(Samples, one_of(folr1.neg.S1.hits$compound_short)) %>% 
  HeatmapPrepAlt("nC") %>% 
  t() %>% 
  heatmaply(
    colors = viridis(n = 5, option = "magma"), 
    xlab = "Samples", ylab = "Compounds",
    main = "Statistically significant compounds\nFolR1 / Negitive Mode",
    margins = c(50, 200, 75, 30),
    labRow = unique(folr1.neg.S1.hits$compound_full),
    k_row = 2, k_col = 2
    )

table(folr1.neg.S1.hits$term)
folr1.neg.inter.hits <- folr1.neg.S1.hits %>% 
  filter(term == "Diet1percent_Met:Genotypewt / wt" | term == "Diet2ppm_FA:Genotypewt / wt") %>% 
  droplevels()
folr1.neg.singl.var.hits <- folr1.neg.S1.hits %>% 
  filter(term != "Diet1percent_Met:Genotypewt / wt" & term != "Diet2ppm_FA:Genotypewt / wt" & !(compound_full %in% folr1.neg.inter.hits$compound_full)) %>% 
  droplevels()
table(folr1.neg.inter.hits$term)
table(folr1.neg.singl.var.hits$term)
```


## Positive Mode

```{r pos_stat, comment=NA}
# sample prep
folr1.pos.smpl.data <- folr1.pos.noNA %>% 
  filter(Type == "sample") %>% 
  unite("Condition", Diet:Genotype, sep = "_", remove = FALSE)
folr1.pos.data.for.sva <- as.matrix(
  folr1.pos.smpl.data[, which(
    colnames(folr1.pos.smpl.data) == "pC1"
    ):ncol(folr1.pos.smpl.data)]
  )
row.names(folr1.pos.data.for.sva) <- folr1.pos.smpl.data$Samples
folr1.pos.data.for.sva <- t(folr1.pos.data.for.sva)
# pheno prep
folr1.pos.data.pheno <- as.data.frame(folr1.pos.smpl.data[, 3:10])
row.names(folr1.pos.data.pheno) <- folr1.pos.smpl.data$Samples
# sva calculation
folr1.pos.mod <- model.matrix(~ 0 + as.factor(Condition), data = folr1.pos.data.pheno)
folr1.pos.mod0 <- model.matrix(~ 1, data = folr1.pos.data.pheno)
set.seed(2018)
num.sv(folr1.pos.data.for.sva, folr1.pos.mod, method = "be")
set.seed(2018)
num.sv(folr1.pos.data.for.sva, folr1.pos.mod, method = "leek")
set.seed(2018)
folr1.pos.sv <- sva(folr1.pos.data.for.sva, folr1.pos.mod, folr1.pos.mod0)
# extract the surrogate variables
folr1.pos.surr.var <- as.data.frame(folr1.pos.sv$sv)
colnames(folr1.pos.surr.var) <- c("S1", "S2", "S3", "S4", "S5", "S6", "S7")

folr1.pos.covar <- folr1.pos.covar %>% 
  spread(key = PC, value = value) %>% 
  unite(col = "Condition", Diet:Genotype, remove = FALSE) %>% 
  inner_join(
    cbind(folr1.pos.data.pheno, folr1.pos.surr.var) %>% 
      rownames_to_column("Samples") %>% 
      select(Samples, S1:S7),
    by = "Samples"
    )
folr1.pos.covar %>% 
  select(Samples, Condition:Genotype, S1:S7) %>% 
  gather("surr_var", "value", S1:S7) %>% 
  ggplot(aes(Condition, value)) +
  geom_boxplot() +
  geom_jitter(size = 2, alpha = 0.8, width = 0.1, aes(color = Diet)) +
  facet_wrap(~ surr_var, scales = "free_y") +
  theme(axis.text.x = element_text(angle = 60, hjust = 1)) +
  scale_color_tableau()
folr1.pos.covar %>% 
  select(Samples:Genotype, PC1:PC8) %>% 
  gather("PC", "value", PC1:PC8) %>% 
  ggplot(aes(Condition, value)) +
  geom_boxplot() +
  geom_point(size = 2, alpha = 0.8, aes(color = Genotype)) +
  facet_wrap(~ PC, scales = "free") +
  theme(axis.text.x = element_text(angle = 60, hjust = 1)) +
  scale_color_tableau()
folr1.pos.covar %>% 
  select(PC1:PC8, S1:S7) %>% 
  ggcorr(label = TRUE)
 # PC 3 correlated with protein quant and PC4 with run order (or was it litter order?)
folr1.pos.covar %>% 
  ggplot(aes(PC3, S1, color = Set)) +
  geom_point(size = 2, alpha = 0.8)
folr1.pos.covar %>% 
  ggplot(aes(PC4, S1, color = Set)) +
  geom_point(size = 2, alpha = 0.8)

folr1.pos.covar %>% 
  lm(S1 ~ Diet*Genotype, data = .) %>% 
  summary()
folr1.pos.covar %>% 
  lm(S2 ~ Diet*Genotype, data = .) %>% 
  summary()

folr1.pos.test.matrix <- model.matrix(~Diet*Genotype, folr1.pos.data.pheno) %>% 
 cbind(folr1.pos.surr.var[, 1])
colnames(folr1.pos.test.matrix)[7] <- "S1"
# fit the model/design matrix
folr1.pos.eb <- folr1.pos.data.for.sva %>% 
  lmFit(folr1.pos.test.matrix) %>% 
  eBayes()
folr1.pos.eb.tidy <- tidy(folr1.pos.eb) #%>% 
#  mutate(
#    adj_pval = p.adjust(p.value, method = "BH"),
#    FC = 2 ^ estimate,
#    change_in_cd = ifelse(FC < 1, "down", "up")
#    ) %>% 
#  rename(compound_short = gene)
folr1.pos.eb.tidy %>% 
  ggplot(aes(p.value, fill = term)) +
  geom_histogram(bins = 150) +
  geom_vline(xintercept = 0.05 / 150) +
  facet_wrap(~ term, scales = "free_y") +
  scale_fill_tableau()
folr1.pos.eb.tidy %>% 
  rename("compound_short" = gene) %>% 
  filter(p.value < 0.05/ 150 & term != "S1") %>% 
  mutate(FC = 2 ^ estimate) %>% 
  inner_join(folr1.pos.compound.info, by = "compound_short") %>% 
  arrange(compound_full, term)

folr1.pos.noNA %>% 
  filter(Type == "sample") %>% 
  ggplot(aes(Diet, pC147)) +
  geom_boxplot() +
  geom_jitter(aes(color = Genotype), size = 2, width = 0.1) + 
  scale_color_tableau() + 
  theme(axis.text.x = element_text(angle = 60, hjust = 1)) +
  ylab("log2(NAD)") +
  facet_wrap(~ Genotype)
folr1.pos.noNA %>% 
  filter(Type == "sample") %>% 
  ggplot(aes(Diet, pC138)) +
  geom_boxplot() +
  geom_jitter(aes(color = Genotype), size = 2, width = 0.1) + 
  scale_color_tableau() + 
  theme(axis.text.x = element_text(angle = 60, hjust = 1)) +
  ylab("log2(ATP)") +
  facet_wrap(~ Genotype)
folr1.pos.S1.hits <- folr1.pos.eb.tidy %>% 
  rename("compound_short" = gene) %>% 
  filter(p.value < 0.05/ 150 & term != "S1") %>% 
  mutate(FC = 2 ^ estimate) %>% 
  inner_join(folr1.pos.compound.info, by = "compound_short")

# volcano plot (fix this up)
folr1.pos.eb.tidy %>%
  filter(term != "S1") %>% 
  ggplot(aes(estimate, -log10(p.value))) +
  geom_point(size = 2, alpha = 0.5) +
  geom_hline(linetype = "dashed", color = "#009E73", yintercept = -log10(0.05 / 150)) +
  geom_vline(linetype = "dashed", color = "#CC79A7", xintercept = log2(1.2)) +
  geom_vline(linetype = "dashed", color = "#CC79A7", xintercept = log2(1/1.2)) +
  xlab("log2(FC)") +
  ylab("-log10(adjusted p-value)") +
  ggtitle("Volcano plot\nFolR1 / Positive Mode")


folr1.neg.S1.hits %>% 
  inner_join(folr1.pos.S1.hits, by = "compound_full", suffix = c("_n", "_p")) %>% 
  select(compound_full, compound_short_n:term_n, p.value_n, FC_n, compound_short_p:term_p, p.value_p, FC_p)
folr1.neg.S1.hits %>% 
  inner_join(folr1.pos.S1.hits, by = "compound_full", suffix = c("_n", "_p")) %>% 
  select(compound_full, compound_short_n:term_n, p.value_n, FC_n, compound_short_p:term_p, p.value_p, FC_p) %>% 
  filter(term_n == term_p) %>% 
  ggplot(aes(FC_n, FC_p, color = term_n, label = compound_full)) +
  geom_abline(intercept = 0, slope = 1, alpha = 0.5) +
  geom_point(size = 2) +
  geom_text(hjust = 0) +
  scale_color_tableau() +
  xlim(0, 11) +
  ylim(-1, 4.5) +
  xlab("FC (neg mode)") +
  ylab("FC (pos mode)")
```


### Viz

```{r pos_resid_viz, comment=NA}
folr1.pos.gathered <- folr1.pos.noNA %>%
  inner_join(
    folr1.pos.covar %>% select(Samples, S1), by = "Samples"
    ) %>%  
  select(Samples, Diet:Genotype, S1, starts_with("pC")) %>% 
  gather(key = "Compound", value = "Abundance", pC1:pC99)
folr1.pos.nested <- folr1.pos.gathered %>% 
  group_by(Compound) %>% 
  nest() %>% 
  mutate(model = map(data, ~lm(Abundance ~ S1, data = .))) %>% 
  mutate(augment_model = map(model, augment))
folr1.pos.modSV.resid <- folr1.pos.nested %>% 
  unnest(data, augment_model) %>% 
  select(Samples:Genotype, Compound, .resid) %>% 
  spread(Compound, .resid) 
folr1.pos.modSV.resid %>% 
  select(Samples, one_of(folr1.pos.S1.hits$compound_short)) %>% 
  HeatmapPrepAlt("pC") %>% 
  t() %>% 
  heatmaply(
    colors = viridis(n = 5, option = "magma"), 
    xlab = "Samples", ylab = "Compounds",
    main = "Statistically significant compounds\nFolR1 / Positive Mode",
    margins = c(50, 200, 75, 30),
    labRow = unique(folr1.pos.S1.hits$compound_full),
    k_row = 2, k_col = 2
    )

table(folr1.pos.S1.hits$term)
folr1.pos.S1.hits %>% 
  filter(term == "Diet1percent_Met:Genotypewt / wt" | term == "Diet2ppm_FA:Genotypewt / wt")
# no interaction metabolites
folr1.pos.singl.var.hits <- folr1.pos.S1.hits %>% 
  droplevels()
table(folr1.pos.singl.var.hits$term)
```


## Post-hoc analysis

```{r post_hoc, comment=NA}
folr1.neg.inter.hits
folr1.neg.singl.var.hits %>% 
  arrange(compound_full, term)
folr1.pos.singl.var.hits %>% 
  arrange(compound_full, term)

table(folr1.neg.singl.var.hits$term)
table(folr1.pos.singl.var.hits$term)

folr1.neg.singl.var.hits %>% 
  filter(str_detect(term, "Genotype"))
folr1.pos.singl.var.hits %>% 
  filter(str_detect(term, "Genotype"))
folr1.neg.modSV.resid %>% 
  select(Samples:Genotype, nC39, nC53, nC96) %>% 
  gather("compound_short", "resid", nC39:nC96) %>% 
  inner_join(folr1.neg.compound.info, by = "compound_short") %>% 
  ggplot(aes(Genotype, resid)) +
  geom_boxplot() +
  geom_jitter(aes(color = Diet), size = 2, alpha = 0.8, width = 0.1) +
  facet_grid(compound_full ~ Diet) +
  scale_color_tableau()
```


# Conclusion



# Session Info

```{r session_info, comment=NA}
sessionInfo()
```

