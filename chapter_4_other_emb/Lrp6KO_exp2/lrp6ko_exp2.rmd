---
title: "Lrp6KO exp 2"
author: "Darya Akimova"
date: "October 22, 2018"
output: 
  html_document:
    toc: true
    toc_float:
      smooth_scroll: true
    number_sections: true
    theme: flatly
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message=FALSE)
```

# Setup

## Packages:

```{r packages, comment=NA}
library(tidyverse)
library(cowplot)
library(GGally)
library(heatmaply)
library(sva)
library(limma)
library(biobroom)
library(ggridges)
```


## Data:

### Abundances:

```{r abundance_import, comment=NA}
ko2.neg.raw <- read_csv("./data/abundances/lrp6ko_exp2_abundances_negmode.csv")
ko2.pos.raw <- read_csv("./data/abundances/lrp6ko_exp2_abundances_posmode.csv")
setequal(ko2.neg.raw$Samples, ko2.pos.raw$Samples)
ko2.pos.raw %>% select(Samples) %>% anit_join(ko2.neg.raw, by = "Samples")
ko2.pos.raw %>% select(Samples) %>% anti_join(ko2.neg.raw, by = "Samples")
```

### Compounds:

```{r compound_info_import, comment=NA}
ko2.neg.compound.info <- read_csv("./data/compound_info/lrp6ko_exp2_compound_info_negmode.csv")
ko2.pos.compound.info <- read_csv("./data/compound_info/lrp6ko_exp2_compound_info_posmode.csv")
# Kegg/other ID reference #
#cmpnd.id.db <- read_csv("")
```

## Functions:

```{r functions, comment=NA}
MissingPerSamplePlot <- function(raw.data, start.string) {
  counted.na <- raw.data %>%
  select(starts_with(start.string)) %>% 
  mutate(
    count.na = apply(., 1, function(x) sum(is.na(x))),
    percent.na = (count.na / ncol(raw.data %>% select(starts_with(start.string)))) * 100
    ) %>%
  dplyr::select(count.na, percent.na) %>%
  bind_cols(
    raw.data %>% 
      select(Samples, Type)
      ) %>% 
  arrange(percent.na) %>% 
  mutate(f.order = factor(Samples, levels = Samples))
counted.na %>% 
  ggplot(aes(x = f.order, y = percent.na, fill = Type)) +
  geom_bar(stat = "identity") +
  geom_hline(yintercept = 20, color = "gray", size = 1, alpha = 0.8) +
  coord_flip()+
  xlab("Samples") +
  ylab("Percent missing values in sample") +
  theme(axis.text.y = element_text(size = 6)) 
}

MissingPerCompound <- function(raw.data, start.string){
  raw.data %>% 
  filter(Type == "sample") %>% 
  select(Samples, starts_with(start.string)) %>% 
  gather(key = "Compound", value = "Abundance", -Samples) %>% 
  group_by(Compound) %>% 
  summarise(
    na_count = sum(is.na(Abundance)),
    n_samples = n(),
    percent_na = (na_count / n_samples * 100)
    ) %>% 
  filter(na_count > 0) %>% 
  arrange(desc(percent_na))
}


ReplaceNAwMinLogTransform <- function(raw.dataframe, start.prefix) {
  # Function to replace any NAs in each column with the minimum for that column, 
  # separately for each data.set (patient and dabase samples separately)
  #
  # Returns: returns data frame(? check on this) with only the values bound by the function args
  # 
  smpls <- raw.dataframe %>%
    filter(Type == "sample") %>% 
    dplyr::select(starts_with(start.prefix))
  smpls.min <- lapply(smpls, min, na.rm = TRUE)
  # replace the missing values in the real samples with the minimum of the samples
  # then take the log
  smpls.noNA <- raw.dataframe  %>%
    filter(Type == "sample") %>% 
    dplyr::select(Samples:Status) %>%
    bind_cols(
      smpls %>%
        replace_na(replace = smpls.min) %>% 
        log2()
      ) 
  # replace the missing values in solv and QC samples with 2 - for PCA analysis
  # then take the log
  other.min <- setNames(
    as.list(
      rep(2, ncol(
        raw.dataframe %>% 
          dplyr::select(starts_with(start.prefix))))
      ),
    colnames(raw.dataframe %>% dplyr::select(starts_with(start.prefix)))
                )
  other.num.log <- raw.dataframe %>%
    filter(Type != "sample") %>% 
    dplyr::select(Samples:Status) %>%
    bind_cols(
      raw.dataframe %>% 
        filter(Type != "sample") %>% 
        dplyr::select(starts_with(start.prefix)) %>%
        replace_na(replace = other.min) %>% 
        log2()
      )
  # combine them together back into one data frame
  all.noNA <- smpls.noNA %>% 
    bind_rows(other.num.log)
}



HeatmapPrep <- function(raw.data, group, start.prefix){
  x <- raw.data %>% 
    filter(Type == group) %>% 
    select(starts_with(start.prefix)) %>% 
    scale(center = TRUE, scale = TRUE) %>% 
    as.matrix() 
  x.rownames <- raw.data %>% 
        filter(Type == group) %>% 
        select(Samples)
  row.names(x) <- x.rownames$Samples
  return(x)
}

HeatmapPrepAlt <- function(raw.data, start.prefix){
  x <- raw.data %>% 
    select(starts_with(start.prefix)) %>% 
    scale(center = TRUE, scale = TRUE) %>% 
    as.matrix() 
  row.names(x) <- raw.data$Samples
  return(x)
}
```


# Exploratory plots

## Mass vs RT Plots

Q: What are the distributions of compound masses and retention times?

```{r mass_v_RT_plots, fig.height=5, fig.width=8}
full.ko2.cmpnd <- ko2.neg.compound.info %>% 
  mutate(group = "Lrp6KO / Neg") %>% 
  bind_rows(ko2.pos.compound.info %>% mutate(group = "Lrp6KO / Pos"))
full.ko2.cmpnd %>% 
  ggplot(aes(x = RT, y = Mass)) +
  geom_point(size = 3, alpha = 0.3) +
  xlab("Retention Time (min)") +
  ylab("Mass (Da)") +
  ggtitle("Mass v RT\nLrp6KO Exp2") +
  ylim(0, 1000)
full.ko2.cmpnd %>% 
  ggplot(aes(x = RT, y = Mass, color = group)) +
  geom_point(size = 3, alpha = 0.8) +
  xlab("Retnetion Time (min)") +
  ylab("Mass (Da)") +
  ggtitle("Mass v RT\nLrp6KO Exp2") +
  facet_wrap(~ group) +
  ylim(0, 1000)
```


Q: Which compounds were found in one or more of the data types?


```{r cmnpd_mode_match, fig.height= 5, fig.width=8}
## cell join ##
ko2.cmpnd.join <- ko2.neg.compound.info %>% 
  inner_join(ko2.pos.compound.info, by = "CAS_ID", suffix = c("_n", "_p")) %>% 
  select(
    CAS_ID, contains("short"), 
    contains("full"), starts_with("Formula"), 
    starts_with("Mass"), starts_with("RT")
    )
# compound names - found in pos and neg mode / cells 
print(ko2.cmpnd.join$Compound_full_n)
# percent of cell / neg compounds found in cell / pos 
round(nrow(ko2.cmpnd.join) * 100 / nrow(ko2.neg.compound.info), 1)
# percent of cell / neg compounds found in cell / pos 
round(nrow(ko2.cmpnd.join) * 100 / nrow(ko2.pos.compound.info), 1)
# problem checks #
ko2.cmpnd.join %>% 
  select(contains("Mass")) %>% 
  ggpairs()
ko2.cmpnd.join %>% 
  select(starts_with("RT")) %>% 
  ggpairs()
```

# Cleanup

## NA per sample and per compound

Q: Do any of the cell or media samples have greater than 20% compound abundances missing (NA)?

```{r missing_per_sample_plots, comment=NA}
## Missing Per Sample Plots ##
MissingPerSamplePlot(ko2.neg.raw, "Lrp6KO2n") +
  ggtitle("Missing Per Sample\nLrp6KO / Exp2 / Neg Mode")
MissingPerSamplePlot(ko2.pos.raw, "Lrp6KO2p") +
  ggtitle("Missing Per Sample\nLrp6KO / Exp2 / Pos Mode")
```


```{r percent_missing_per_compound}
## Missing per Compound ##
(ko2.neg.miss.excl <- MissingPerCompound(ko2.neg.raw, "Lrp6KO2n") %>% 
  filter(percent_na > 20))
(ko2.pos.miss.excl <- MissingPerCompound(ko2.pos.raw, "Lrp6KO2p") %>% 
  filter(percent_na > 20))
```


## Solv vs Sample Files


### Lrp6KO Exp2 Neg Mode


```{r solv_neg}
ko2.neg.raw.type.mean <- ko2.neg.raw %>% 
  group_by(Type) %>% 
  summarize_at(vars(matches("Lrp6KO2n")), mean, na.rm = TRUE) %>% 
  gather(key = "Compound", value = "Type_mean_abun", -Type)
ko2.neg.raw.type.mean %>% 
  ggplot(aes(log2(Type_mean_abun), color = Type)) +
  geom_density(size = 2, alpha = 0.8)
ko2.neg.raw.type.mean.order <- ko2.neg.raw.type.mean %>% 
  filter(Type == "sample") %>% 
  arrange(Type_mean_abun)
ko2.neg.raw.type.mean %>% 
  mutate(Cmpnd_sort = factor(Compound, levels = ko2.neg.raw.type.mean.order$Compound)) %>% 
  ggplot(aes(Cmpnd_sort, log2(Type_mean_abun), color = Type, group = Type)) +
  geom_point(size = 1, alpha = 0.8) +
  geom_line(alpha = 0.8) +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank()) +
  xlab("Compound") +
  ylab("log2(Sample Type Mean)") +
  ggtitle("Profile Plot of Sample Type Means\nLrp6KO Exp2 Neg Mode")
ko2.neg.raw.type.diff <- ko2.neg.raw.type.mean %>% 
  spread(Type, Type_mean_abun) %>% 
  mutate(smpl_solv_diff = sample / Solv)
ko2.neg.raw.type.diff %>% 
  ggplot(aes(log2(smpl_solv_diff))) +
  geom_histogram(bins = 50)
# include compounds with FC > 2.5 or FC is NA (indication of NA in solv)
ko2.neg.cmpnd.to.incl <- ko2.neg.raw.type.diff %>% 
  filter(smpl_solv_diff > 2.5 | is.na(smpl_solv_diff)) %>% 
  filter(!(Compound %in% ko2.neg.miss.excl$Compound))
nrow(ko2.neg.raw.type.diff)
nrow(ko2.neg.cmpnd.to.incl)
```


### Lrp6KO Exp2 Pos Mode


```{r solv_pos}
ko2.pos.raw.type.mean <- ko2.pos.raw %>% 
  group_by(Type) %>% 
  summarize_at(vars(matches("Lrp6KO2p")), mean, na.rm = TRUE) %>% 
  gather(key = "Compound", value = "Type_mean_abun", -Type)
ko2.pos.raw.type.mean %>% 
  ggplot(aes(log2(Type_mean_abun), color = Type)) +
  geom_density(size = 2, alpha = 0.8)
ko2.pos.raw.type.mean.order <- ko2.pos.raw.type.mean %>% 
  filter(Type == "sample") %>% 
  arrange(Type_mean_abun)
ko2.pos.raw.type.mean %>% 
  mutate(Cmpnd_sort = factor(Compound, levels = ko2.pos.raw.type.mean.order$Compound)) %>% 
  ggplot(aes(Cmpnd_sort, log2(Type_mean_abun), color = Type, group = Type)) +
  geom_point(size = 1, alpha = 0.8) +
  geom_line(alpha = 0.8) +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank()) +
  xlab("Compound") +
  ylab("log2(Sample Type Mean)")
ko2.pos.raw.type.diff <- ko2.pos.raw.type.mean %>% 
  spread(Type, Type_mean_abun) %>% 
  mutate(smpl_solv_diff = sample / Solv)
ko2.pos.raw.type.diff %>% 
  ggplot(aes(log2(smpl_solv_diff))) +
  geom_histogram(bins = 50)
# include compounds with FC > 2.5 or FC is NA (indication of NA in solv)
(ko2.pos.cmpnd.to.incl <- ko2.pos.raw.type.diff %>% 
  filter(smpl_solv_diff > 2.5 | is.na(smpl_solv_diff)) %>% 
  filter(!(Compound %in% ko2.pos.miss.excl$Compound)))
nrow(ko2.pos.raw.type.diff)
nrow(ko2.pos.cmpnd.to.incl)
```


# Data prep and prelim analysis

## NA replacement and log transform

```{r min_na_rpl_log_transform, comment=NA}
# replace missing with minimum for each Group in each dataset and log2() transform the data:
# exclude compound that have a >20% NA count across samples
ko2.neg.noNA <- ko2.neg.raw %>% 
  select(Samples:Status, one_of(ko2.neg.cmpnd.to.incl$Compound)) %>% 
  ReplaceNAwMinLogTransform("Lrp6KO2n")
ko2.pos.noNA <- ko2.pos.raw %>% 
  select(Samples:Status, one_of(ko2.pos.cmpnd.to.incl$Compound)) %>% 
  ReplaceNAwMinLogTransform("Lrp6KO2p")
```

## Exploratory heatmaps 

After NA replacement and ln transformation of the data

```{r heatmaps}
ko2.neg.noNA %>% 
  HeatmapPrep("sample", "Lrp6KO2n") %>% 
  heatmap(col = viridis(10), scale = "none", margins = c(8, 8))
ko2.pos.noNA %>% 
  HeatmapPrep("sample", "Lrp6KO2p") %>% 
  heatmap(col = viridis(10), scale = "none", margins = c(8, 8))
```


## Distribution plots:


```{r distrb_plots_neg, comment=NA, eval = FALSE}
ko2.neg.noNA.gathered <- ko2.neg.noNA %>% 
  gather(
    key = "Metabolite", "Abundance", 
    which(colnames(ko2.neg.noNA) == "Lrp6KO2n1"):ncol(ko2.neg.noNA)
    )

ko2.neg.noNA.gathered %>% 
  ggplot(aes(Samples, Abundance, fill = Type)) +
  geom_boxplot() +
  geom_boxplot(aes(color = Type), fatten = NULL, fill = NA, coef = 0, outlier.alpha = 0, show.legend = FALSE) +
  theme(axis.text.x = element_text(angle = 90))

ko2.neg.noNA.gathered %>% 
  unite("Group", Folate, Status, sep = " / ") %>% 
  ggplot(aes(Samples, Abundance, fill = Group)) +
  geom_boxplot() +
  geom_boxplot(aes(color = Group), fatten = NULL, fill = NA, coef = 0, outlier.alpha = 0, show.legend = FALSE) +
  theme(axis.text.x = element_text(angle = 90))

ko2.neg.noNA.gathered %>% 
  ggplot(aes(y = Samples, x = Abundance, fill = Type)) + 
  geom_density_ridges(scale = 20) +
  theme_ridges() +
  scale_y_discrete(expand = c(0.01, 0))

ko2.neg.noNA.gathered %>% 
  ggplot(aes(y = Type, x = Abundance, fill = Type)) + 
  geom_density_ridges(scale = 2.5) +
  theme_ridges() +
  scale_y_discrete(expand = c(0.01, 0))

ko2.neg.noNA.gathered %>%
  ggplot(aes(Abundance, group = Samples, color= Type)) +
  geom_density(alpha = 0.8, size = 0.75)
ko2.neg.noNA.gathered %>%
  unite("Treatment", Folate, Status, sep = " / ") %>% 
  ggplot(aes(Abundance, group = Samples, color = Treatment)) +
  geom_density(alpha = 0.8, size = 0.75) +
  facet_wrap(~ Treatment)
ko2.neg.noNA.gathered %>%
  unite("Treatment", Folate, Status, sep = " / ") %>% 
  ggplot(aes(Abundance, group = Samples, color = Treatment)) +
  geom_density(alpha = 0.8, size = 0.75)
ko2.neg.noNA.gathered %>%
  filter(Type == "sample") %>% 
  unite("Treatment", Folate, Status, sep = " / ") %>% 
  ggplot(aes(Abundance, group = Samples, color = Treatment)) +
  geom_density(alpha = 0.6, size = 0.75)
```


```{r distrb_plots_pos, comment=NA, eval = FALSE}
ko2.pos.noNA.gathered <- ko2.pos.noNA %>% 
  gather(
    key = "Metabolite", "Abundance", 
    which(colnames(ko2.pos.noNA) == "Lrp6KO2p10"):ncol(ko2.pos.noNA)
    )
ko2.pos.noNA.gathered %>% 
  ggplot(aes(Samples, Abundance, fill = Type)) +
  geom_boxplot() +
  geom_boxplot(aes(color = Type), fatten = NULL, fill = NA, coef = 0, outlier.alpha = 0, show.legend = FALSE) +
  theme(axis.text.x = element_text(angle = 90))
ko2.pos.noNA.gathered %>% 
  unite("Group", Folate, Status, sep = " / ") %>% 
  ggplot(aes(Samples, Abundance, fill = Group)) +
  geom_boxplot() +
  geom_boxplot(aes(color = Group), fatten = NULL, fill = NA, coef = 0, outlier.alpha = 0, show.legend = FALSE) +
  theme(axis.text.x = element_text(angle = 90))
ko2.pos.noNA.gathered %>% 
  ggplot(aes(y = Samples, x = Abundance, fill = Type)) + 
  geom_density_ridges(scale = 20) +
  theme_ridges() +
  scale_y_discrete(expand = c(0.01, 0))
ko2.pos.noNA.gathered %>% 
  ggplot(aes(y = Type, x = Abundance, fill = Type)) + 
  geom_density_ridges(scale = 2.5) +
  theme_ridges() +
  scale_y_discrete(expand = c(0.01, 0))
ko2.pos.noNA.gathered %>%
  ggplot(aes(Abundance, group = Samples, color= Type)) +
  geom_density(alpha = 0.8, size = 0.75)
ko2.pos.noNA.gathered %>%
  unite("Treatment", Folate, Status, sep = " / ") %>% 
  ggplot(aes(Abundance, group = Samples, color = Treatment)) +
  geom_density(alpha = 0.8, size = 0.75) +
  facet_wrap(~ Treatment)
ko2.pos.noNA.gathered %>%
  unite("Treatment", Folate, Status, sep = " / ") %>% 
  ggplot(aes(Abundance, group = Samples, color = Treatment)) +
  geom_density(alpha = 0.8, size = 0.75)
ko2.pos.noNA.gathered %>%
  filter(Type == "sample") %>% 
  unite("Treatment", Folate, Status, sep = " / ") %>% 
  ggplot(aes(Abundance, group = Samples, color = Treatment)) +
  geom_density(alpha = 0.6, size = 0.75)
```


## Exploratory PCA 

Some plots to understand the relationship between the samples, QC samples, solvent, and empty samples in some cases. 

```{r}
### Negative Mode ###
ko2.neg.smpl.pca <- ko2.neg.noNA %>% 
  filter(Type == "sample") %>% 
  select(starts_with("Lrp6KO2n")) %>% 
  as.matrix() %>% 
  prcomp()
ko2.neg.smpl.pca.x <- as.data.frame(ko2.neg.smpl.pca$x)
ko2.neg.smpl.pca.x <- ko2.neg.smpl.pca.x %>% 
  bind_cols(
    ko2.neg.noNA %>% 
      filter(Type == "sample") %>% 
      select(Samples, Folate:Status)
  )
row.names(ko2.neg.smpl.pca.x) <- ko2.neg.smpl.pca.x$Samples
ko2.neg.smpl.pca.x %>% 
  unite("Treatment", Folate, Status, sep = " / ") %>% 
  ggplot(aes(x = PC1, y = PC2, color = Treatment, label = rownames(ko2.neg.smpl.pca.x))) +
  geom_point(size = 4, alpha = 0.8) +
  xlab("PC1 (47.2 % Var)") +
  ylab("PC2 (18.1% Var)") +
  geom_text()
#Samples != "emb_133_2"
ko2.neg.smpl.filt.pca <- ko2.neg.noNA %>% 
  filter(Type == "sample" & Samples != "emb_133_2") %>% 
  select(starts_with("Lrp6KO2n")) %>% 
  as.matrix() %>% 
  prcomp()
ko2.neg.smpl.filt.pca.x <- as.data.frame(ko2.neg.smpl.filt.pca$x)
ko2.neg.smpl.filt.pca.x <- ko2.neg.smpl.filt.pca.x %>% 
  bind_cols(
    ko2.neg.noNA %>% 
      filter(Type == "sample" & Samples != "emb_133_2") %>% 
      select(Samples, Folate:Status)
  )
row.names(ko2.neg.smpl.filt.pca.x) <- ko2.neg.smpl.filt.pca.x$Samples
ko2.neg.smpl.filt.pca.x %>% 
  unite("Treatment", Folate, Status, sep = " / ") %>% 
  ggplot(aes(x = PC1, y = PC2, color = Treatment)) +
  geom_point(size = 4, alpha = 0.8) +
  xlab("PC1 (38.7 % Var)") +
  ylab("PC2 (11.0% Var)")

### Positive Mode ###
ko2.pos.smpl.pca <- ko2.pos.noNA %>% 
  filter(Type == "sample") %>% 
  select(starts_with("Lrp6KO2p")) %>% 
  as.matrix() %>% 
  prcomp()
ko2.pos.smpl.pca.x <- as.data.frame(ko2.pos.smpl.pca$x)
ko2.pos.smpl.pca.x <- ko2.pos.smpl.pca.x %>% 
  bind_cols(
    ko2.pos.noNA %>% 
      filter(Type == "sample") %>% 
      select(Samples, Folate:Status)
  )
row.names(ko2.pos.smpl.pca.x) <- ko2.pos.smpl.pca.x$Samples
ko2.pos.smpl.pca.x %>% 
  unite("Treatment", Folate, Status, sep = " / ") %>% 
  ggplot(aes(x = PC1, y = PC2, color = Treatment, label = rownames(ko2.pos.smpl.pca.x))) +
  geom_point(size = 4, alpha = 0.8) +
  geom_text(hjust = 0) +
  xlab("PC1 (35.9% Var)") +
  ylab("PC2 (16.9% Var)")
### filtered ###
ko2.pos.smpl.filt.pca <- ko2.pos.noNA %>% 
  filter(Type == "sample" & Samples != "emb_133_2") %>% 
  select(starts_with("Lrp6KO2p")) %>% 
  as.matrix() %>% 
  prcomp()
ko2.pos.smpl.filt.pca.x <- as.data.frame(ko2.pos.smpl.filt.pca$x)
ko2.pos.smpl.filt.pca.x <- ko2.pos.smpl.filt.pca.x %>% 
  bind_cols(
    ko2.pos.noNA %>% 
      filter(Type == "sample" & Samples != "emb_133_2") %>% 
      select(Samples, Folate:Status)
  )
row.names(ko2.pos.smpl.filt.pca.x) <- ko2.pos.smpl.filt.pca.x$Samples
ko2.pos.smpl.filt.pca.x %>% 
  unite("Treatment", Folate, Status, sep = " / ") %>% 
  ggplot(aes(x = PC1, y = PC2, color = Treatment, )) +
  geom_point(size = 4, alpha = 0.8) +
  xlab("PC1 (33.6% Var)") +
  ylab("PC2 (15.6% Var)")
```


# Statistically significant metabolites


## Lrp6KO Exp2 / Neg Mode

```{r lrp6ko_exp1_neg_stat, comment=NA}
ko2.neg.smpl.data <- ko2.neg.noNA %>% 
  filter(Type == "sample" & Samples != "emb_133_2")
ko2.neg.data.for.sva <- as.matrix(
  ko2.neg.smpl.data[, which(
    colnames(ko2.neg.smpl.data) == "Lrp6KO2n1"
    ):ncol(ko2.neg.smpl.data)]
  )
row.names(ko2.neg.data.for.sva) <- ko2.neg.smpl.data$Samples
ko2.neg.data.for.sva <- t(ko2.neg.data.for.sva)
# pheno prep
ko2.neg.data.pheno <- as.data.frame(ko2.neg.smpl.data[, 5:6])
row.names(ko2.neg.data.pheno) <- ko2.neg.smpl.data$Samples
# sva calculation
ko2.neg.mod <- model.matrix(~ as.factor(Folate) + as.factor(Status), data = ko2.neg.data.pheno)
ko2.neg.mod0 <- model.matrix(~ 1, data = ko2.neg.data.pheno)
num.sv(ko2.neg.data.for.sva, ko2.neg.mod, method = "be")
num.sv(ko2.neg.data.for.sva, ko2.neg.mod, method = "leek")
set.seed(2018)
ko2.neg.sv <- sva(ko2.neg.data.for.sva, ko2.neg.mod, ko2.neg.mod0)
ko2.neg.data.pheno <- ko2.neg.data.pheno %>% 
  unite("Group", Folate, Status, sep = "_")


ko2.neg.data.pheno$Group <- factor(ko2.neg.data.pheno$Group)
ko2.neg.design <- model.matrix(~ 0 + Group, data = ko2.neg.data.pheno)
ko2.neg.design.sv <- cbind(ko2.neg.design, ko2.neg.sv$sv)
colnames(ko2.neg.design.sv) <- c(
  "N_ko_10ppmFA", "N_wt_10ppmFA", 
  "N_ko_2ppmFA", "N_wt_2ppmFA", 
  "S1", "S2", "S3", "S4"
  )
ko2.neg.fit <- lmFit(ko2.neg.data.for.sva, ko2.neg.design.sv)



test.mod <- model.matrix(~ as.factor(Group), data = ko2.neg.data.pheno)
set.seed(2018)
ko2.neg.sv.test <- sva(ko2.neg.data.for.sva, test.mod, ko2.neg.mod0)

test2 <- ko2.neg.sv.test$sv
colnames(test2) <- c("test_S1", "test_S2", "test_S3", "test_S4")
test3 <- ko2.neg.sv$sv
colnames(test3) <- c("orig_S1", "orig_S2", "orig_S3", "orig_S4")
test4 <- test2 %>% 
  as_tibble() %>% 
  bind_cols(
    test3 %>% 
      as_tibble()
  ) %>% 
  bind_cols(
    ko2.neg.data.pheno %>% 
      rownames_to_column("Samples")
  ) %>% 
  bind_cols(
    ko2.neg.smpl.filt.pca.x %>% 
      select(Folate:Status, PC1:PC6)
  ) %>% 
  select(Samples:Status, everything())
test4 %>% 
  select(test_S1:PC6) %>% 
  ggcorr()
test4 %>% 
  select(Group, test_S1, orig_S1, PC1) %>% 
  ggpairs()


ko2.neg.design.pca <- cbind(ko2.neg.design, test4$PC1)
colnames(ko2.neg.design.pca) <- c(
  "N_ko_10ppmFA", "N_wt_10ppmFA", 
  "N_ko_2ppmFA", "N_wt_2ppmFA", 
  "PC1"
  )
ko2.neg.pc1.fit <- lmFit(ko2.neg.data.for.sva, ko2.neg.design.pca)



ko2.neg.cont.mat <- makeContrasts(
  ko_lowFA = A_ko_2ppmFA - N_wt_2ppmFA, 
  ko_highFA = A_ko_10ppmFA - N_wt_10ppmFA,
  FA_diff = (A_ko_10ppmFA - N_wt_10ppmFA) - (A_ko_2ppmFA - N_wt_2ppmFA),
  levels = c(
    "A_ko_10ppmFA", "N_wt_10ppmFA", 
    "A_ko_2ppmFA", "N_wt_2ppmFA", 
    "S1", "S2", "S3"
    )
  )

ko1.neg.pc1.cont.mat <- makeContrasts(
  ko_lowFA = A_ko_2ppmFA - N_wt_2ppmFA, 
  ko_highFA = A_ko_10ppmFA - N_wt_10ppmFA,
  FA_diff = (A_ko_10ppmFA - N_wt_10ppmFA) - (A_ko_2ppmFA - N_wt_2ppmFA),
  levels = c(
    "A_ko_10ppmFA", "N_wt_10ppmFA", 
    "A_ko_2ppmFA", "N_wt_2ppmFA", 
    "PC1"
    )
  )


  
ko1.neg.fit.contrast <- contrasts.fit(ko1.neg.fit, ko1.neg.cont.mat)
ko1.neg.eb <- eBayes(ko1.neg.fit.contrast)


ko1.neg.pc1.fit.contrast <- contrasts.fit(ko1.neg.pc1.fit, ko1.neg.pc1.cont.mat)
ko1.neg.pc1.eb <- eBayes(ko1.neg.pc1.fit.contrast)


ko1.neg.top.table <- topTableF(ko1.neg.eb , adjust = "BH", p.value = 0.05, n = nrow(ko1.neg.data.for.sva))
ko1.neg.all.top.table.w.names <- ko1.neg.top.table %>% 
  rownames_to_column("Compound_short") %>% 
  as_tibble() %>% 
  inner_join(ko1.neg.compound.info, by = "Compound_short")
ko1.neg.all.top.table.w.names %>% 
  select(Compound_full, ko_lowFA:FA_diff, adj.P.Val)


ko1.neg.pc1.top.table <- topTableF(ko1.neg.pc1.eb, adjust = "BH", p.value = 0.05, n = nrow(ko1.neg.data.for.sva))
ko1.neg.pc1.all.top.table.w.names <- ko1.neg.pc1.top.table %>% 
  rownames_to_column("Compound_short") %>% 
  as_tibble() %>% 
  inner_join(ko1.neg.compound.info, by = "Compound_short")
ko1.neg.pc1.all.top.table.w.names %>% 
  select(Compound_full, ko_lowFA:FA_diff, adj.P.Val)

ko1.neg.results <- decideTests(ko1.neg.eb, method = "global", adjust.method = "BH")
vennDiagram(ko1.neg.results)
ko1.neg.hits <- ko1.neg.results@.Data %>% 
  data.frame() %>% 
  rownames_to_column("Compound_short") %>% 
  filter(ko_lowFA != 0 | ko_highFA != 0 | FA_diff != 0) %>% 
  inner_join(ko1.neg.compound.info, by = "Compound_short")
ko1.neg.hits



ko1.pc1.neg.results <- decideTests(ko1.neg.pc1.eb, method = "global", adjust.method = "BH")
vennDiagram(ko1.pc1.neg.results)
ko1.pc1.neg.hits <- ko1.pc1.neg.results@.Data %>% 
  data.frame() %>% 
  rownames_to_column("Compound_short") %>% 
  filter(ko_lowFA != 0 | ko_highFA != 0 | FA_diff != 0) %>% 
  inner_join(ko1.neg.compound.info, by = "Compound_short")
ko1.pc1.neg.hits


```


```{r include=FALSE, eval=FALSE}
### Plotting ###
  vf.cell.neg.surr.var <- as.data.frame(vf.cell.neg.sv$sv)
  colnames(vf.cell.neg.surr.var) <- c("S1", "S2", "S3")
  vf.cell.neg.gathered <- vf.cell.neg.noNA %>%
    filter(Group == "sample") %>% 
    bind_cols(vf.cell.neg.surr.var) %>% 
    select(Samples, VPA, FA, S1:S3, starts_with("VPA_FAnC")) %>% 
    gather(key = "Compound", value = "Abundance", VPA_FAnC10:VPA_FAnC99)
  vf.cell.neg.nested <- vf.cell.neg.gathered %>% 
    group_by(Compound) %>% 
    nest() %>% 
    mutate(model = map(data, ~lm(Abundance ~ S1 + S2 + S3, data = .))) %>% 
    mutate(augment_model = map(model, augment))
  vf.cell.neg.modSV.resid <- vf.cell.neg.nested %>% 
    unnest(data, augment_model) %>% 
    select(Samples, VPA, FA, Compound, .resid) %>% 
    spread(Compound, .resid)
  vf.cell.neg.modSV.resid %>% 
    select(Samples:FA, one_of(vf.cell.neg.all.top.table.w.names$compound_short)) %>%
    HeatmapPrepAlt("VPA_FAnC") %>% 
    t() %>% 
    heatmap(col = magma(10), scale = "none", labRow = vf.cell.neg.all.top.table.w.names$compound_full)

  vf.cell.neg.modSV.resid %>% 
    select(Samples:FA, one_of(vf.cell.neg.all.top.table.w.names$compound_short)) %>% 
    HeatmapPrepAlt("VPA_FAnC") %>% 
    t() %>% 
    heatmaply(
      colors = viridis(n = 10, option = "magma"), 
      xlab = "Samples", ylab = "Compounds",
      main = "Statistically significant compounds\nVPA + FA Experiment / Cells / Neg Mode",
      margins = c(50, 50, 75, 30),
      labRow = vf.cell.neg.all.top.table.w.names$compound_full
      )
```

Try tidying - p.value is unadjusted - estimate is logFC from tobtable

```{r cell_neg_tidy}
ko1.neg.eb.tidy <- tidy(ko1.neg.eb) %>% 
  mutate(
    adj_pval = p.adjust(p.value, method = "BH"),
    ko_div_wt = 2 ^ estimate,
    change_in_ko = ifelse(ko_div_wt < 1, "down", "up")
    ) %>% 
  rename(Compound_short = gene)

ko1.neg.eb.tidy %>% 
  ggplot(aes(estimate, -log10(adj_pval))) +
  geom_point(size = 2, alpha = 0.5) +
  geom_hline(linetype = "dashed", color = "#009E73", yintercept = -log10(0.05)) +
  geom_vline(linetype = "dashed", color = "#CC79A7", xintercept = log2(1.2)) +
  geom_vline(linetype = "dashed", color = "#CC79A7", xintercept = log2(1/1.2)) +
  xlim(-2, 2)

ko1.neg.hits <- ko1.neg.eb.tidy %>% 
  filter(adj_pval < 0.05 & (ko_div_wt > 1.2 | ko_div_wt < 0.83)) %>% 
  inner_join(ko1.neg.compound.info, by = "Compound_short")
table(ko1.neg.hits$term)

```


## Lrp6KO Exp1 / Pos Mode

```{r lrp6ko_exp1_pos_stat, comment=NA}
# remove "emb_37_6" from the pos mode dataset
ko1.pos.smpl.data <- ko1.pos.noNA %>%
  filter(Samples != "emb_37_6") %>% 
  filter(Type == "sample")
ko1.pos.data.for.sva <- as.matrix(
  ko1.pos.smpl.data[, which(
    colnames(ko1.pos.smpl.data) == "Lrp6KOp1"
    ):ncol(ko1.pos.smpl.data)]
  )
row.names(ko1.pos.data.for.sva) <- ko1.pos.smpl.data$Samples
ko1.pos.data.for.sva <- t(ko1.pos.data.for.sva)
# pheno prep
ko1.pos.data.pheno <- as.data.frame(ko1.pos.smpl.data[, 5:6])
row.names(ko1.pos.data.pheno) <- ko1.pos.smpl.data$Samples
# sva calculation
ko1.pos.mod.vf <- model.matrix(~ as.factor(Folate) + as.factor(Status), data = ko1.pos.data.pheno)
ko1.pos.mod0 <- model.matrix(~ 1, data = ko1.pos.data.pheno)
num.sv(ko1.pos.data.for.sva, ko1.pos.mod.vf, method = "be")
num.sv(ko1.pos.data.for.sva, ko1.pos.mod.vf, method = "leek")
set.seed(2018)
ko1.pos.sv <- sva(ko1.pos.data.for.sva, ko1.pos.mod.vf, ko1.pos.mod0)
ko1.pos.data.pheno <- ko1.pos.data.pheno %>% 
  unite("Group", Folate, Status, sep = "_")


ko1.pos.data.pheno$Group <- factor(ko1.pos.data.pheno$Group)
ko1.pos.design <- model.matrix(~ 0 + Group, data = ko1.pos.data.pheno)
ko1.pos.design.sv <- cbind(ko1.pos.design, ko1.pos.sv$sv)
colnames(ko1.pos.design.sv) <- c(
  "A_ko_10ppmFA", "N_wt_10ppmFA", 
  "A_ko_2ppmFA", "N_wt_2ppmFA", 
  "S1", "S2"
  )
ko1.pos.fit <- lmFit(ko1.pos.data.for.sva, ko1.pos.design.sv)

ko1.pos.cont.mat <- makeContrasts(
  ko_lowFA = A_ko_2ppmFA - N_wt_2ppmFA, 
  ko_highFA = A_ko_10ppmFA - N_wt_10ppmFA,
  FA_diff = (A_ko_10ppmFA - N_wt_10ppmFA) - (A_ko_2ppmFA - N_wt_2ppmFA),
  levels = c(
    "A_ko_10ppmFA", "N_wt_10ppmFA", 
    "A_ko_2ppmFA", "N_wt_2ppmFA", 
    "S1", "S2"
    )
  )
  
ko1.pos.fit.contrast <- contrasts.fit(ko1.pos.fit, ko1.pos.cont.mat)
ko1.pos.eb <- eBayes(ko1.pos.fit.contrast)

ko1.pos.top.table <- topTableF(ko1.pos.eb , adjust = "BH", p.value = 0.05, n = nrow(ko1.pos.data.for.sva))
dim(ko1.pos.top.table)

ko1.pos.results <- decideTests(ko1.pos.eb, method = "global", adjust.method = "BH")
vennDiagram(ko1.pos.results)
ko1.pos.hits <- ko1.pos.results@.Data %>% 
  data.frame() %>% 
  rownames_to_column("Compound_short") %>% 
  filter(ko_lowFA != 0 | ko_highFA != 0 | FA_diff != 0) %>% 
  inner_join(ko1.pos.compound.info, by = "Compound_short")
ko1.pos.hits
```


```{r include=FALSE, eval=FALSE}
### Plotting ###
  vf.cell.neg.surr.var <- as.data.frame(vf.cell.neg.sv$sv)
  colnames(vf.cell.neg.surr.var) <- c("S1", "S2", "S3")
  vf.cell.neg.gathered <- vf.cell.neg.noNA %>%
    filter(Group == "sample") %>% 
    bind_cols(vf.cell.neg.surr.var) %>% 
    select(Samples, VPA, FA, S1:S3, starts_with("VPA_FAnC")) %>% 
    gather(key = "Compound", value = "Abundance", VPA_FAnC10:VPA_FAnC99)
  vf.cell.neg.nested <- vf.cell.neg.gathered %>% 
    group_by(Compound) %>% 
    nest() %>% 
    mutate(model = map(data, ~lm(Abundance ~ S1 + S2 + S3, data = .))) %>% 
    mutate(augment_model = map(model, augment))
  vf.cell.neg.modSV.resid <- vf.cell.neg.nested %>% 
    unnest(data, augment_model) %>% 
    select(Samples, VPA, FA, Compound, .resid) %>% 
    spread(Compound, .resid)
  vf.cell.neg.modSV.resid %>% 
    select(Samples:FA, one_of(vf.cell.neg.all.top.table.w.names$compound_short)) %>%
    HeatmapPrepAlt("VPA_FAnC") %>% 
    t() %>% 
    heatmap(col = magma(10), scale = "none", labRow = vf.cell.neg.all.top.table.w.names$compound_full)

  vf.cell.neg.modSV.resid %>% 
    select(Samples:FA, one_of(vf.cell.neg.all.top.table.w.names$compound_short)) %>% 
    HeatmapPrepAlt("VPA_FAnC") %>% 
    t() %>% 
    heatmaply(
      colors = viridis(n = 10, option = "magma"), 
      xlab = "Samples", ylab = "Compounds",
      main = "Statistically significant compounds\nVPA + FA Experiment / Cells / Neg Mode",
      margins = c(50, 50, 75, 30),
      labRow = vf.cell.neg.all.top.table.w.names$compound_full
      )
```

Try tidying - p.value is unadjusted - estimate is logFC from tobtable

```{r cell_pos_tidy, eval=FALSE, include = FALSE}
ko1.neg.eb.tidy <- tidy(ko1.neg.eb) %>% 
  mutate(
    adj_pval = p.adjust(p.value, method = "BH"),
    ko_div_wt = 2 ^ estimate,
    change_in_ko = ifelse(ko_div_wt < 1, "down", "up")
    ) %>% 
  rename(Compound_short = gene)

ko1.neg.eb.tidy %>% 
  ggplot(aes(estimate, -log10(adj_pval))) +
  geom_point(size = 2, alpha = 0.5) +
  geom_hline(linetype = "dashed", color = "#009E73", yintercept = -log10(0.05)) +
  geom_vline(linetype = "dashed", color = "#CC79A7", xintercept = log2(1.2)) +
  geom_vline(linetype = "dashed", color = "#CC79A7", xintercept = log2(1/1.2)) +
  xlim(-2, 2)

ko1.neg.hits <- ko1.neg.eb.tidy %>% 
  filter(adj_pval < 0.05 & (ko_div_wt > 1.2 | ko_div_wt < 0.83)) %>% 
  inner_join(ko1.neg.compound.info, by = "Compound_short")
table(ko1.neg.hits$term)

```
